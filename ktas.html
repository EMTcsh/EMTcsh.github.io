<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KTAS 한국형 중증도 분류도구 (교육용)</title>
<style>
  :root{
    --bg:#0b1020; --card:#121933; --muted:#8ea0c6; --fg:#e8eeff;
    --ktas1:#ff3b30; --ktas2:#ff9500; --ktas3:#ffcc00; --ktas4:#34c759; --ktas5:#30b0ff;
    --accent:#7aa2ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1020 100%);color:var(--fg);font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif;line-height:1.35}
  header{position:sticky;top:0;background:rgba(10,15,30,.7);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:8px 0 4px;font-size:22px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:10px}
  .grid{display:grid;gap:14px}
  @media (min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
  section{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
  section h2{margin:0 0 10px;font-size:15px;color:#bfd0ff;font-weight:700}
  label{display:block;font-size:13px;color:#cbd8ff;margin:8px 0 6px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0d1530;color:var(--fg);font-size:14px}
  input[type="number"]{appearance:textfield}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer;user-select:none}
  .chip input{display:none}
  .chip.active{background:#16224a;border-color:#3b5bd6}
  .btns{display:flex;gap:10px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#152150;color:var(--fg);cursor:pointer;font-weight:600}
  button.primary{background:var(--accent);color:#0a0f1e;border:none}
  button.warn{background:#26314f;border-color:#ff7a7a;color:#ffdede}
  .result{display:flex;flex-direction:column;gap:10px}
  .badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 12px;font-weight:800}
  .k1{background:var(--ktas1)}.k2{background:var(--ktas2)}.k3{background:var(--ktas3);color:#2a2100}
  .k4{background:var(--ktas4);color:#001a05}.k5{background:var(--ktas5);color:#00131d}
  .muted{color:var(--muted);font-size:13px}
  ul{margin:0 0 0 18px}
  .footer{color:#9fb2e6;font-size:12px;margin-top:10px}
  .timebox{display:flex;gap:8px;flex-wrap:wrap}
  .pill{border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:12px}
  .danger{color:#ff9fa3}
  .ok{color:#aaf0c9}
  .flex{display:flex;gap:12px;flex-wrap:wrap}
  .hint{font-size:12px;color:#9fb2e6}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>KTAS 한국형 중증도 분류도구 <span class="hint">(교육/시뮬레이션용)</span></h1>
    <div class="sub">입력값을 기반으로 규칙적용 → KTAS 1~5 산출 · 근거 표시 · 인쇄/JSON 저장</div>
  </div>
</header>

<main class="wrap grid grid-2">
  <!-- 환자/도착 정보 -->
  <section>
    <h2>① 환자 기본정보</h2>
    <div class="row-2">
      <div>
        <label>이름</label>
        <input id="ptName" placeholder="홍길동" />
      </div>
      <div>
        <label>성별</label>
        <select id="ptSex">
          <option>남</option><option>여</option><option>기타/미상</option>
        </select>
      </div>
    </div>
    <div class="row-4" style="margin-top:8px">
      <div>
        <label>나이(년)</label>
        <input id="ptAge" type="number" min="0" step="1" placeholder="35" />
      </div>
      <div>
        <label>체중(kg)</label>
        <input id="ptWt" type="number" min="0" step="0.1" placeholder="70" />
      </div>
      <div>
        <label>도착일시</label>
        <input id="arrTime" type="datetime-local" />
      </div>
      <div>
        <label>내원경로</label>
        <select id="arrival">
          <option>구급대 이송</option><option>자가</option><option>타병원전원</option><option>기타</option>
        </select>
      </div>
    </div>
  </section>

  <!-- 활력징후 -->
  <section>
    <h2>② 활력징후 / 의식</h2>
    <div class="row-4">
      <div><label>호흡수(RR)</label><input id="rr" type="number" min="0" placeholder="16"></div>
      <div><label>산소포화도(SpO₂ %)</label><input id="spo2" type="number" min="0" max="100" placeholder="98"></div>
      <div><label>심박수(HR)</label><input id="hr" type="number" min="0" placeholder="80"></div>
      <div><label>수축기혈압(SBP)</label><input id="sbp" type="number" min="0" placeholder="120"></div>
    </div>
    <div class="row-4" style="margin-top:8px">
      <div><label>체온(℃)</label><input id="temp" type="number" step="0.1" placeholder="36.8"></div>
      <div><label>AVPU</label>
        <select id="avpu"><option value="A">A</option><option value="V">V</option><option value="P">P</option><option value="U">U</option></select>
      </div>
      <div><label>GCS 합</label><input id="gcs" type="number" min="3" max="15" placeholder="15"></div>
      <div><label>통증 NRS(0-10)</label><input id="pain" type="number" min="0" max="10" placeholder="0"></div>
    </div>
  </section>

  <!-- 즉시 생명위협 -->
  <section>
    <h2>③ 즉시 위협(있으면 KTAS 1)</h2>
    <div class="chips" id="redFlags">
      <!-- 체크 토글 -->
      <label class="chip"><input type="checkbox" value="무호흡/기도폐쇄"><span>무호흡/기도폐쇄</span></label>
      <label class="chip"><input type="checkbox" value="무맥/심정지"><span>무맥/심정지</span></label>
      <label class="chip"><input type="checkbox" value="반응없음(U)"><span>반응없음(U)</span></label>
      <label class="chip"><input type="checkbox" value="지속 경련"><span>지속 경련</span></label>
      <label class="chip"><input type="checkbox" value="심한 호흡곤란/청색증"><span>심한 호흡곤란/청색증</span></label>
      <label class="chip"><input type="checkbox" value="대량출혈/절단"><span>대량출혈/절단</span></label>
      <label class="chip"><input type="checkbox" value="쇼크 의심"><span>쇼크 의심</span></label>
      <label class="chip"><input type="checkbox" value="광범위 화상/흡인"><span>광범위 화상/흡인</span></label>
      <label class="chip"><input type="checkbox" value="다발성 고에너지 외상"><span>다발성 고에너지 외상</span></label>
    </div>
  </section>

  <!-- 증상군 -->
  <section>
    <h2>④ 주증상(Chief Complaint)</h2>
    <div class="row-2">
      <div>
        <label>증상군</label>
        <select id="cc">
          <option>호흡곤란</option><option>흉통</option><option>복통</option><option>발열</option>
          <option>신경학적/의식변화</option><option>외상-머리</option><option>외상-흉복부/골반</option>
          <option>외상-사지/연부</option><option>화상</option><option>중독/약물</option>
          <option>정신과</option><option>산부인과</option><option>소아 발열</option><option>기타</option>
        </select>
      </div>
      <div>
        <label>증상 시작/경과</label>
        <input id="onset" placeholder="예: 2시간 전 발생, 점점 악화" />
      </div>
    </div>
    <label style="margin-top:8px">보조 수정지표</label>
    <div class="row-4">
      <div>
        <select id="bleed">
          <option value="">출혈 정도 선택</option>
          <option value="severe">활동성 대량출혈</option>
          <option value="moderate">중등도 출혈</option>
          <option value="minor">경미</option>
        </select>
      </div>
      <div>
        <select id="mech">
          <option value="">손상 기전</option>
          <option value="high">고에너지(고속충돌/추락&gt;5m 등)</option>
          <option value="mid">중등도</option>
          <option value="low">저에너지/단순</option>
        </select>
      </div>
      <div>
        <select id="dehyd">
          <option value="">탈수/순환</option>
          <option value="severe">중증 탈수/냉감 창백/지연 CRT</option>
          <option value="moderate">중등도</option>
          <option value="mild">경미</option>
        </select>
      </div>
      <div>
        <select id="feverChild">
          <option value="">소아 발열 보정</option>
          <option value="lt3m">3개월 미만 발열(≥38℃)</option>
          <option value="immu">면역저하/중증질환 의심</option>
        </select>
      </div>
    </div>
  </section>

  <!-- 결과 -->
  <section>
    <h2>⑤ 분류 결과</h2>
    <div class="result" id="resultBox">
      <div id="badge" class="badge k5">KTAS 5 (비응급)</div>
      <div class="timebox">
        <div class="pill">목표 진료 대기: <span id="target">≤ 120분</span></div>
        <div class="pill">증상군: <span id="ccOut">-</span></div>
        <div class="pill">도착: <span id="timeOut">-</span></div>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">근거(트리거):</div>
        <ul id="rationale"></ul>
      </div>
      <div class="footer">
        ※ 본 도구는 교육·훈련 및 시뮬레이션 목적입니다. 실제 진료 시 기관 프로토콜/공식 KTAS 매뉴얼을 우선 적용하세요.
      </div>
    </div>
    <div class="btns" style="margin-top:12px">
      <button class="primary" id="calcBtn">중증도 산출</button>
      <button id="resetBtn">입력 초기화</button>
      <button id="saveBtn">JSON 저장</button>
      <button class="warn" id="printBtn">인쇄/PDF</button>
    </div>
  </section>

  <!-- 메모 -->
  <section>
    <h2>메모</h2>
    <textarea id="notes" rows="6" placeholder="관찰/중재/응급처치 등 기록"></textarea>
  </section>
</main>

<script>
  // 초기값
  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));

  const arrTime = $("#arrTime");
  const nowISO = new Date().toISOString().slice(0,16);
  arrTime.value = nowISO;

  // chip 토글 UI
  const chipWrap = $("#redFlags");
  chipWrap.addEventListener("click", (e)=>{
    const lab = e.target.closest(".chip");
    if(!lab) return;
    lab.classList.toggle("active");
    const cb = lab.querySelector("input[type=checkbox]");
    cb.checked = lab.classList.contains("active");
  });

  function setBadge(level){
    const badge = $("#badge");
    badge.className = "badge k"+level;
    const labels = {
      1:"KTAS 1 (최중증·즉시)",
      2:"KTAS 2 (응급·15분)",
      3:"KTAS 3 (준응급·30분)",
      4:"KTAS 4 (경증·60분)",
      5:"KTAS 5 (비응급·120분)"
    };
    badge.textContent = labels[level];
    $("#target").textContent = ({
      1:"즉시",
      2:"≤ 15분",
      3:"≤ 30분",
      4:"≤ 60분",
      5:"≤ 120분"
    })[level];
  }

  function pushReason(reasons, text, minLevel){
    reasons.push("[" + (minLevel===1?"Critical":minLevel===2?"High":minLevel===3?"Moderate":minLevel===4?"Low":"Info") + "] " + text);
  }

  function computeLevel(){
    const reasons = [];
    let level = 5; // 낮을수록 위중

    const age = +($("#ptAge").value||0);
    const rr = +($("#rr").value||0);
    const spo2 = +($("#spo2").value||0);
    const hr = +($("#hr").value||0);
    const sbp = +($("#sbp").value||0);
    const temp = +($("#temp").value||0);
    const avpu = $("#avpu").value;
    const gcs = +($("#gcs").value||15);
    const pain = +($("#pain").value||0);

    const bleed = $("#bleed").value;
    const mech = $("#mech").value;
    const dehyd = $("#dehyd").value;
    const feverChild = $("#feverChild").value;
    const cc = $("#cc").value;

    // 1) 즉시 위협
    const redFlags = $$("#redFlags input:checked").map(i=>i.value);
    if (redFlags.length>0 || avpu==="U" || gcs<=8){
      pushReason(reasons, "즉시 생명위협/반응없음/중증의식저하", 1);
      return {level:1, reasons};
    }

    // 2) 호흡/산소화
    if (rr>30 || rr<8){
      level = Math.min(level, 2);
      pushReason(reasons, "호흡수 RR >30 또는 <8", 2);
    } else if (rr>=24){
      level = Math.min(level, 3);
      pushReason(reasons, "호흡수 RR 24~30", 3);
    }

    if (spo2 && spo2<90){
      level = Math.min(level, 2);
      pushReason(reasons, "SpO₂ < 90%", 2);
    } else if (spo2 && spo2>=90 && spo2<=92){
      level = Math.min(level, 3);
      pushReason(reasons, "SpO₂ 90~92%", 3);
    }

    // 3) 순환
    if (sbp && sbp<90){
      level = Math.min(level, 2);
      pushReason(reasons, "SBP < 90 mmHg", 2);
    } else if (sbp && sbp<=100){
      level = Math.min(level, 3);
      pushReason(reasons, "SBP 90~100 mmHg", 3);
    }

    if (hr && hr>=130){
      level = Math.min(level, 2);
      pushReason(reasons, "HR ≥130", 2);
    } else if (hr && hr>=110){
      level = Math.min(level, 3);
      pushReason(reasons, "HR 110~129", 3);
    }

    // 4) 체온/연령 보정
    if (temp){
      if (temp>=41 || temp<35){
        level = Math.min(level, 2);
        pushReason(reasons, "고열(≥41℃) 또는 저체온(<35℃)", 2);
      }
      if (age<0.25 && temp>=38.0){ // 3개월 미만
        level = Math.min(level, 2);
        pushReason(reasons, "3개월 미만 발열 ≥38.0℃", 2);
      }
    }
    if (feverChild==="lt3m"){
      level = Math.min(level, 2);
      pushReason(reasons, "소아 발열 보정: 3개월 미만", 2);
    }
    if (feverChild==="immu"){
      level = Math.min(level, 2);
      pushReason(reasons, "면역저하/중증 감염 의심", 2);
    }

    // 5) 통증 보정 (NRS)
    if (pain>=8){
      level = Math.min(level, 2);
      pushReason(reasons, "극심한 통증(NRS 8~10)", 2);
    } else if (pain>=4){
      level = Math.min(level, 3);
      pushReason(reasons, "중등도 통증(NRS 4~7)", 3);
    } else if (pain>=1){
      level = Math.min(level, 4);
      pushReason(reasons, "경미한 통증(NRS 1~3)", 4);
    }

    // 6) 출혈/손상기전/탈수
    if (bleed==="severe"){
      level = Math.min(level, 2);
      pushReason(reasons, "활동성 대량 출혈", 2);
    } else if (bleed==="moderate"){
      level = Math.min(level, 3);
      pushReason(reasons, "중등도 출혈", 3);
    } else if (bleed==="minor"){
      level = Math.min(level, 4);
      pushReason(reasons, "경미한 출혈", 4);
    }

    if (mech==="high"){
      level = Math.min(level, 2);
      pushReason(reasons, "고에너지 손상 기전", 2);
    } else if (mech==="mid"){
      level = Math.min(level, 3);
      pushReason(reasons, "중등도 손상 기전", 3);
    }

    if (dehyd==="severe"){
      level = Math.min(level, 2);
      pushReason(reasons, "중증 탈수/말초순환 저하", 2);
    } else if (dehyd==="moderate"){
      level = Math.min(level, 3);
      pushReason(reasons, "중등도 탈수", 3);
    }

    // 7) 증상군별 최소 레벨 힌트
    const ccMinLevel = {
      "호흡곤란": 2,
      "흉통": 3,
      "복통": 4,
      "발열": 4,
      "신경학적/의식변화": 2,
      "외상-머리": 3,
      "외상-흉복부/골반": 2,
      "외상-사지/연부": 4,
      "화상": 3,
      "중독/약물": 3,
      "정신과": 4,
      "산부인과": 3,
      "소아 발열": 4,
      "기타": 5
    };
    if (ccMinLevel[cc]){
      level = Math.min(level, ccMinLevel[cc]);
      pushReason(reasons, `증상군 최소 중증도: ${cc} → KTAS ≥ ${ccMinLevel[cc]}`, ccMinLevel[cc]);
    }

    // 의식 V/P는 최소 2~3 보정
    if (avpu==="P"){
      level = Math.min(level, 2);
      pushReason(reasons, "AVPU = P (통증에만 반응)", 2);
    } else if (avpu==="V"){
      level = Math.min(level, 3);
      pushReason(reasons, "AVPU = V (음성자극 반응)", 3);
    }
    if (gcs && gcs<=12){
      level = Math.min(level, 3);
      pushReason(reasons, "GCS ≤ 12", 3);
    }

    return {level, reasons};
  }

  function render(){
    const {level, reasons} = computeLevel();
    setBadge(level);
    $("#ccOut").textContent = $("#cc").value;
    $("#timeOut").textContent = $("#arrTime").value.replace("T"," ");
    const ul = $("#rationale");
    ul.innerHTML = "";
    if (reasons.length===0){
      const li = document.createElement("li");
      li.textContent = "특이 트리거 없음 → 기본 KTAS 5 유지";
      ul.appendChild(li);
    } else {
      reasons.forEach(r=>{
        const li = document.createElement("li"); li.textContent = r; ul.appendChild(li);
      });
    }
  }

  $("#calcBtn").addEventListener("click", render);

  $("#resetBtn").addEventListener("click", ()=>{
    document.querySelectorAll("input, select, textarea").forEach(el=>{
      if (el.type==="checkbox") el.checked=false;
      else if (el.type==="datetime-local") el.value = new Date().toISOString().slice(0,16);
      else el.value="";
    });
    $$("#redFlags .chip").forEach(c=>c.classList.remove("active"));
    setBadge(5);
    $("#rationale").innerHTML="";
    $("#ccOut").textContent="-"; $("#timeOut").textContent="-";
  });

  $("#saveBtn").addEventListener("click", ()=>{
    const data = {
      patient:{
        name: $("#ptName").value, sex: $("#ptSex").value, age: $("#ptAge").value, weight: $("#ptWt").value
      },
      arrival: {time: $("#arrTime").value, route: $("#arrival").value},
      vitals:{
        rr: $("#rr").value, spo2: $("#spo2").value, hr: $("#hr").value, sbp: $("#sbp").value, temp: $("#temp").value,
        avpu: $("#avpu").value, gcs: $("#gcs").value, pain: $("#pain").value
      },
      flags: $$("#redFlags input:checked").map(i=>i.value),
      complaint: {cc: $("#cc").value, onset: $("#onset").value, bleed: $("#bleed").value, mech: $("#mech").value, dehyd: $("#dehyd").value, feverChild: $("#feverChild").value},
      notes: $("#notes").value
    };
    const comp = computeLevel();
    data.result = comp;
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const ts = new Date().toISOString().replace(/[:.]/g,"-").slice(0,19);
    a.download = `KTAS_${ts}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("#printBtn").addEventListener("click", ()=>window.print());

  // 엔터로도 계산
  document.addEventListener("keydown", (e)=>{
    if (e.key==="Enter" && (e.metaKey || e.ctrlKey)) render();
  });

  // 첫 계산 미리
  setBadge(5);
</script>
</body>
</html>
