<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸš‘ ë¬´ë“±ì‚° ìƒí™©ì‹¤ ëŒ€ì‹œë³´ë“œ</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ff9e145029506d6e4c72d1f2b01ea424&libraries=services"></script>

<style>
body{background:#eef2f7;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;}
.card{
background:#fff;
border-radius:14px;
padding:16px;
margin-bottom:16px;
box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
.stat{font-size:24px;font-weight:800;}
#map{width:100%;height:600px;border-radius:14px;}
.critical-banner{
display:none;
background:#dc2626;
color:#fff;
padding:12px;
border-radius:12px;
font-weight:700;
margin-bottom:16px;
animation:blink 1s infinite;
text-align:center;
}
@keyframes blink{
0%{opacity:1;}
50%{opacity:0.3;}
100%{opacity:1;}
}
</style>
</head>

<body class="p-4">

<h1 class="text-2xl font-bold text-blue-700 mb-4">
ğŸš‘ ë¬´ë“±ì‚° ìƒí™©ì‹¤ ëŒ€ì‹œë³´ë“œ
</h1>

<div id="criticalBanner" class="critical-banner">
ğŸš¨ í˜„ì¬ ì¤‘ì¦ í™˜ì ë°œìƒ!
</div>

<div class="grid grid-cols-3 gap-4 mb-4">
  <div class="card text-center">
    <div>ì „ì²´ ì¶œë™</div>
    <div id="totalCount" class="stat text-blue-600">0</div>
  </div>
  <div class="card text-center">
    <div>ğŸ”´ ì¤‘ì¦ í™˜ì</div>
    <div id="criticalCount" class="stat text-red-600">0</div>
  </div>
  <div class="card text-center">
    <div>ìµœê·¼ ì¶œë™</div>
    <div id="latestDispatch" class="text-sm mt-1">-</div>
  </div>
</div>

<div id="map"></div>

<script>

const SERVER_URL="https://script.google.com/macros/s/AKfycbw686MCjBNLO_9Eoj1CYqqRj3ds9Z6Jzj7-z1MpGt9tnpHGNFch9ulwlWtOmxB7mmHBsg/exec";

let map;
let markers=[];
let infoWindows=[];

// ì§€ë„ ì´ˆê¸°í™”
function initMap(){
  map=new kakao.maps.Map(document.getElementById("map"),{
    center:new kakao.maps.LatLng(35.145,126.888),
    level:7
  });
}
initMap();

// ë§ˆì»¤ ì´ë¯¸ì§€
function createMarkerImage(isCritical){
  const imageSrc = isCritical
    ? "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png"
    : "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

  return new kakao.maps.MarkerImage(
    imageSrc,
    new kakao.maps.Size(24,35)
  );
}

// ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
async function updateDashboard(){
  try{
    const res=await fetch(SERVER_URL);
    const data=await res.json();

    markers.forEach(m=>m.setMap(null));
    markers=[];
    infoWindows=[];

    let total=0;
    let critical=0;

    data.forEach(d=>{
      if(d.latitude && d.longitude){

        total++;

        const gcsScore=parseInt(d.GCS);
        const isCritical = gcsScore<=8;

        if(isCritical) critical++;

        const pos=new kakao.maps.LatLng(d.latitude,d.longitude);

        const marker=new kakao.maps.Marker({
          position:pos,
          map:map,
          image:createMarkerImage(isCritical)
        });

        const infoContent=`
          <div style="padding:10px;font-size:13px;line-height:1.6">
            <b>í™˜ì:</b> ${d.í™˜ìì´ë¦„||"-"}<br>
            <b>ì¶œë™ëŒ€ì›:</b> ${d.ì¶œë™ëŒ€ì›||"-"}<br>
            <b>ì‚¬ê³ ì¥ì†Œ:</b> ${d.ì‚¬ê³ ì¥ì†Œ||"-"}<br>
            <b>ì£¼ì¦ìƒ:</b> ${d.ì£¼ì¦ìƒ||"-"}<br>
            <b>GCS:</b> ${d.GCS||"-"}<br>
            <b>ì—°ë½ì²˜:</b> ${d.ì—°ë½ì²˜||"-"}<br>
            <b>ë„ì°©ì‹œê°„:</b> ${d.ë„ì°©ì‹œê°„||"-"}
          </div>
        `;

        const infoWindow=new kakao.maps.InfoWindow({
          content:infoContent
        });

        kakao.maps.event.addListener(marker,'click',()=>{
          infoWindows.forEach(i=>i.close());
          infoWindow.open(map,marker);
        });

        markers.push(marker);
        infoWindows.push(infoWindow);
      }
    });

    // í†µê³„ ë°˜ì˜
    document.getElementById("totalCount").textContent=total;
    document.getElementById("criticalCount").textContent=critical;

    if(data.length>0){
      const latest=data[data.length-1];
      document.getElementById("latestDispatch").textContent=
        `${latest.ì¶œë™ëŒ€ì›||"-"} / ${latest.ì‚¬ê³ ì¥ì†Œ||"-"}`;
    }

    // ğŸ”´ ì¤‘ì¦ ë°°ë„ˆ
    if(critical>0){
      document.getElementById("criticalBanner").style.display="block";
    }else{
      document.getElementById("criticalBanner").style.display="none";
    }

  }catch(err){
    console.error("ëŒ€ì‹œë³´ë“œ ì˜¤ë¥˜:",err);
  }
}

setInterval(updateDashboard,5000);
updateDashboard();

</script>
</body>
</html>
