<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì‘ê¸‰ ê¸°ë¡ì§€</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f9; color: #333; }
    h1, h2 { color: #004085; }
    .section { background-color: #fff; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input[type="time"], input[type="text"], input[type="number"], textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 80px; }
    .button-group { margin-top: 15px; display: flex; gap: 10px; }
    button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; color: #fff; flex-grow: 1; transition: background-color 0.3s; }
    button:hover { filter: brightness(0.9); }
    button#saveMist, button#saveSbar, button#saveVitals { background-color: #28a745; }
    button#copyMist, button#copySbar, button#copyVitals { background-color: #17a2b8; }
    button#pdfMist, button#pdfSbar, button#pdfVitals { background-color: #dc3545; }
    button#copySummary { background-color: #17a2b8; }
    button#saveSummaryPdf { background-color: #dc3545; }
    button#submitForm { background-color: #28a745; margin-top: 20px; width: 100%; font-size: 18px; padding: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    button#submitForm:hover { background-color: #218838; }
    .output { background-color: #e9ecef; padding: 15px; margin-top: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
    #recentBox { margin-top: 30px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    #recentTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
    #recentTable th, #recentTable td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #recentTable th { background-color: #f2f2f2; }
</style>
</head>
<body>
<h1>MIST/SBAR/í™œë ¥ì§•í›„ ê¸°ë¡ ë° ì €ì¥</h1>

<form id="recordForm">
    <label for="recordTime">ê¸°ë¡ ì‹œê°„</label>
    <input type="time" id="recordTime" name="recordTime" required />

    <!-- MIST Section -->
    <section class="section" id="mistSection">
        <h2>MIST ë³´ê³ </h2>
        <label for="mechanism">Mechanism (ê¸°ì „)</label>
        <textarea id="mechanism" name="mechanism" placeholder="ì˜ˆ: êµí†µì‚¬ê³ , ë‚™ìƒ ë“±" required></textarea>
        <label for="injury">Injury (ì†ìƒë¶€ìœ„)</label>
        <textarea id="injury" name="injury" placeholder="ì†ìƒ ë¶€ìœ„ ë° ìƒíƒœ" required></textarea>
        <label for="signs">Signs (ì¦ìƒ)</label>
        <textarea id="signs" name="signs" placeholder="í™˜ì ì¦ìƒ" required></textarea>
        <label for="treatment">Treatment (ì²˜ì¹˜ ë‚´ìš©)</label>
        <textarea id="treatment" name="treatment" placeholder="ì§€ê¸ˆê¹Œì§€ ì‹œí–‰ëœ ì²˜ì¹˜" required></textarea>
        <div class="button-group">
            <button type="button" id="saveMist">ğŸ’¾ MIST ì €ì¥</button>
            <button type="button" id="copyMist">ğŸ“‹ MIST ë³µì‚¬</button>
            <button type="button" id="pdfMist">ğŸ“„ MIST PDF ì €ì¥</button>
        </div>
        <pre id="mistOutput" class="output" style="display:none;"></pre>
    </section>

    <!-- SBAR Section -->
    <section class="section" id="sbarSection">
        <h2>SBAR ë³´ê³ </h2>
        <label for="situation">Situation (ìƒí™©)</label>
        <textarea id="situation" name="situation" placeholder="í˜„ì¬ ìƒí™© ì„¤ëª…" required></textarea>
        <label for="background">Background (ë°°ê²½)</label>
        <textarea id="background" name="background" placeholder="í™˜ì ë°°ê²½ ë° ë³‘ë ¥" required></textarea>
        <label for="assessment">Assessment (í‰ê°€)</label>
        <textarea id="assessment" name="assessment" placeholder="ì§„ë‹¨ ë° í‰ê°€ ë‚´ìš©" required></textarea>
        <label for="recommendation">Recommendation (ê¶Œê³ )</label>
        <textarea id="recommendation" name="recommendation" placeholder="ì˜ë£Œ ì§€ë„ ë° ê¶Œê³ ì‚¬í•­" required></textarea>
        <div class="button-group">
            <button type="button" id="saveSbar">ğŸ’¾ SBAR ì €ì¥</button>
            <button type="button" id="copySbar">ğŸ“‹ SBAR ë³µì‚¬</button>
            <button type="button" id="pdfSbar">ğŸ“„ SBAR PDF ì €ì¥</button>
        </div>
        <pre id="sbarOutput" class="output" style="display:none;"></pre>
    </section>

    <!-- Vitals Section -->
    <section class="section" id="vitalsSection">
        <h2>í™œë ¥ì§•í›„ ê¸°ë¡</h2>
        <label for="bp">í˜ˆì•• (mmHg)</label>
        <input type="text" id="bp" name="bp" placeholder="ì˜ˆ: 120/80" required />
        <label for="hr">ì‹¬ë°•ìˆ˜ (íšŒ/ë¶„)</label>
        <input type="number" id="hr" name="hr" min="30" max="200" required />
        <label for="rr">í˜¸í¡ìˆ˜ (íšŒ/ë¶„)</label>
        <input type="number" id="rr" name="rr" min="5" max="50" required />
        <label for="temp">ì²´ì˜¨ (â„ƒ)</label>
        <input type="number" step="0.1" id="temp" name="temp" min="30" max="45" required />
        <div class="button-group">
            <button type="button" id="saveVitals">ğŸ’¾ í™œë ¥ì§•í›„ ì €ì¥</button>
            <button type="button" id="copyVitals">ğŸ“‹ í™œë ¥ì§•í›„ ë³µì‚¬</button>
            <button type="button" id="pdfVitals">ğŸ“„ í™œë ¥ì§•í›„ PDF ì €ì¥</button>
        </div>
        <pre id="vitalsOutput" class="output" style="display:none;"></pre>
    </section>

    <!-- Medical Instruction -->
    <section class="section" id="medicalSection">
        <h2>ì˜ë£Œ ì§€ë„</h2>
        <label for="medicalInstruction">ì˜ë£Œ ì§€ë„ ë‚´ìš©</label>
        <textarea id="medicalInstruction" name="medicalInstruction" placeholder="ì˜ë£Œ ì§€ì‹œ ë° ì¶”ê°€ ì²˜ì¹˜ ë‚´ìš©" required></textarea>
    </section>

    <button type="submit" id="submitForm">
        <i class="fas fa-file-excel"></i> ì „ì²´ ê¸°ë¡ Google Sheetsì— ì €ì¥ ë° ìš”ì•½ ìƒì„±
    </button>
</form>

<div id="overallOutput" class="output" style="display:none; margin-top: 30px;"></div>

<h2>ì˜ë£Œì§€ë„ ìš”ì²­ ìš”ì•½</h2>
<div id="summary" class="output" style="display:none;"></div>
<div style="margin-top:10px; display:none;" id="summaryButtons">
    <button id="copySummary">ğŸ“‹ ìš”ì•½ ë³µì‚¬</button>
    <button id="saveSummaryPdf">ğŸ“„ ìš”ì•½ PDF ì €ì¥</button>
</div>

<div id="recentBox" style="display:none; margin-top:30px;">
    <h2>ğŸ“Œ ìµœê·¼ ê¸°ë¡</h2>
    <table id="recentTable"></table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;
const mistFields = ['mechanism','injury','signs','treatment'];
const sbarFields = ['situation','background','assessment','recommendation'];
const vitalsFields = ['bp','hr','rr','temp'];
const form = document.getElementById('recordForm');
const overallOutput = document.getElementById('overallOutput');
const summaryDiv = document.getElementById('summary');
const summaryButtons = document.getElementById('summaryButtons');
const copySummaryBtn = document.getElementById('copySummary');
const saveSummaryPdfBtn = document.getElementById('saveSummaryPdf');
const recentBox = document.getElementById('recentBox');
const recentTable = document.getElementById('recentTable');

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwq3ksWHAtOhp6uon7cQYIDYTZXp35MWbNG1Lp_T3nViP2OqLbrxwbK93UDS-xqjLzC/exec";

// ----------- ê³µí†µ í•¨ìˆ˜ -------------
async function saveToGoogleSheet(dataType, data){
    if(!data) return;
    try{
        const response = await fetch(SCRIPT_URL,{
            method:"POST",
            body: JSON.stringify({dataType, ...data}),
            headers: {"Content-Type": "application/json"}
        });
        const result = await response.json();
        if(result.status==="success"){
            alert(`${dataType} ê¸°ë¡ì´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            if(dataType==='all'){
                const recentResponse = await fetch(SCRIPT_URL+"?action=getRecent");
                const recentData = await recentResponse.json();
                if(recentData.length>0){
                    renderRecentTable(recentData);
                    recentBox.style.display="block";
                }
            }
        } else { alert(`ì €ì¥ ì‹¤íŒ¨: ${result.message}`); }
    } catch(err){
        console.error(err);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë˜ëŠ” URL ì˜¤ë¥˜");
    }
}

function copyToClipboard(text){
    navigator.clipboard.writeText(text).then(()=>alert("ë³µì‚¬ ì™„ë£Œ"));
}

function savePdf(title,text){
    const doc = new jsPDF();
    const lines = doc.splitTextToSize(text,180);
    doc.text(lines,10,10);
    doc.save(title);
}

function renderRecentTable(data){
    recentTable.innerHTML="";
    const headers = Object.keys(data[0]);
    let thead="<tr>"+headers.map(h=>`<th>${h}</th>`).join('')+"</tr>";
    recentTable.innerHTML=thead;
    data.forEach(row=>{
        let tr="<tr>"+headers.map(h=>`<td>${row[h]}</td>`).join('')+"</tr>";
        recentTable.innerHTML+=tr;
    });
}

// ---------------- MIST ----------------
const mistOutput = document.getElementById('mistOutput');
document.getElementById('saveMist').addEventListener('click',()=>{
    const values = mistFields.map(id=>document.getElementById(id).value.trim());
    if(values.some(v=>v==='')) return alert("MIST ëª¨ë“  í•­ëª© ì…ë ¥í•„ìš”");
    const data = {recordTime: form.recordTime.value, mist:{mechanism:values[0], injury:values[1], signs:values[2], treatment:values[3]}};
    mistOutput.textContent = `=== MIST ë³´ê³  ===\nMechanism: ${values[0]}\nInjury: ${values[1]}\nSigns: ${values[2]}\nTreatment: ${values[3]}`;
    mistOutput.style.display="block";
    saveToGoogleSheet("MIST",data);
});
document.getElementById('copyMist').addEventListener('click',()=>copyToClipboard(mistOutput.textContent));
document.getElementById('pdfMist').addEventListener('click',()=>savePdf("MIST.pdf",mistOutput.textContent));

// ---------------- SBAR ----------------
const sbarOutput = document.getElementById('sbarOutput');
document.getElementById('saveSbar').addEventListener('click',()=>{
    const values = sbarFields.map(id=>document.getElementById(id).value.trim());
    if(values.some(v=>v==='')) return alert("SBAR ëª¨ë“  í•­ëª© ì…ë ¥í•„ìš”");
    const data = {recordTime: form.recordTime.value, sbar:{situation:values[0], background:values[1], assessment:values[2], recommendation:values[3]}};
    sbarOutput.textContent = `=== SBAR ë³´ê³  ===\nSituation: ${values[0]}\nBackground: ${values[1]}\nAssessment: ${values[2]}\nRecommendation: ${values[3]}`;
    sbarOutput.style.display="block";
    saveToGoogleSheet("SBAR",data);
});
document.getElementById('copySbar').addEventListener('click',()=>copyToClipboard(sbarOutput.textContent));
document.getElementById('pdfSbar').addEventListener('click',()=>savePdf("SBAR.pdf",sbarOutput.textContent));

// ---------------- Vitals ----------------
const vitalsOutput = document.getElementById('vitalsOutput');
document.getElementById('saveVitals').addEventListener('click',()=>{
    const values = vitalsFields.map(id=>document.getElementById(id).value.trim());
    if(values.some(v=>v==='')) return alert("í™œë ¥ì§•í›„ ëª¨ë“  í•­ëª© ì…ë ¥í•„ìš”");
    const data = {recordTime: form.recordTime.value, vitals:{bp:values[0], hr:values[1], rr:values[2], temp:values[3]}};
    vitalsOutput.textContent = `=== í™œë ¥ì§•í›„ ê¸°ë¡ ===\ní˜ˆì••: ${values[0]}\nì‹¬ë°•ìˆ˜: ${values[1]}\ní˜¸í¡ìˆ˜: ${values[2]}\nì²´ì˜¨: ${values[3]}`;
    vitalsOutput.style.display="block";
    saveToGoogleSheet("Vitals",data);
});
document.getElementById('copyVitals').addEventListener('click',()=>copyToClipboard(vitalsOutput.textContent));
document.getElementById('pdfVitals').addEventListener('click',()=>savePdf("Vitals.pdf",vitalsOutput.textContent));

// ---------------- ì „ì²´ ì œì¶œ ----------------
form.addEventListener('submit',(e)=>{
    e.preventDefault();
    const recordData = {
        recordTime: form.recordTime.value,
        mist: mistFields.reduce((acc,id)=>({...acc,[id]:document.getElementById(id).value.trim()}),{}),
        sbar: sbarFields.reduce((acc,id)=>({...acc,[id]:document.getElementById(id).value.trim()}),{}),
        vitals: vitalsFields.reduce((acc,id)=>({...acc,[id]:document.getElementById(id).value.trim()}),{}),
        medicalInstruction: document.getElementById('medicalInstruction').value.trim()
    };
    overallOutput.textContent = "âœ… ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
    overallOutput.style.display="block";
    summaryDiv.textContent = `ì˜ë£Œì§€ë„ ìš”ì²­: ${recordData.medicalInstruction}`;
    summaryDiv.style.display="block";
    summaryButtons.style.display="block";
    saveToGoogleSheet("all",recordData);
});

// ---------------- ì˜ë£Œì§€ë„ ìš”ì•½ ----------------
copySummaryBtn.addEventListener('click',()=>copyToClipboard(summaryDiv.textContent));
saveSummaryPdfBtn.addEventListener('click',()=>savePdf("MedicalSummary.pdf",summaryDiv.textContent));
</script>
</body>
</html>
