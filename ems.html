<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIST/SBAR/í™œë ¥ì§•í›„ ê¸°ë¡ ë° ì €ì¥</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 20px auto;
      padding: 20px;
      background: #f7f7f7;
      border-radius: 8px;
    }
    h1, h2 {
      color: #333;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="number"],
    input[type="time"],
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 1rem;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      margin-top: 10px;
      padding: 10px 16px;
      background-color: #007bff;
      border: none;
      color: white;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 8px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .section {
      margin-bottom: 30px;
      padding: 15px;
      background: #e9ecef;
      border-radius: 6px;
    }
    .output {
      margin-top: 10px;
      padding: 12px;
      background: #fff;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px solid #ccc;
    }
    .button-group {
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>MIST/SBAR/í™œë ¥ì§•í›„ ê¸°ë¡ ë° ì €ì¥</h1>

  <form id="recordForm">
    <label for="recordTime">ê¸°ë¡ ì‹œê°„</label>
    <input type="time" id="recordTime" name="recordTime" required />

    <section class="section" id="mistSection">
      <h2>MIST ë³´ê³ </h2>
      <label for="mechanism">Mechanism (ê¸°ì „)</label>
      <textarea id="mechanism" name="mechanism" placeholder="ì˜ˆ: êµí†µì‚¬ê³ , ë‚™ìƒ ë“±" required></textarea>

      <label for="injury">Injury (ì†ìƒë¶€ìœ„)</label>
      <textarea id="injury" name="injury" placeholder="ì†ìƒ ë¶€ìœ„ ë° ìƒíƒœ" required></textarea>

      <label for="signs">Signs (ì¦ìƒ)</label>
      <textarea id="signs" name="signs" placeholder="í™˜ì ì¦ìƒ" required></textarea>

      <label for="treatment">Treatment (ì²˜ì¹˜ ë‚´ìš©)</label>
      <textarea id="treatment" name="treatment" placeholder="ì§€ê¸ˆê¹Œì§€ ì‹œí–‰ëœ ì²˜ì¹˜" required></textarea>

      <div class="button-group">
        <button type="button" id="saveMist">ğŸ’¾ MIST ì €ì¥</button>
        <button type="button" id="copyMist">ğŸ“‹ MIST ë³µì‚¬</button>
        <button type="button" id="pdfMist">ğŸ“„ MIST PDF ì €ì¥</button>
      </div>
      <pre id="mistOutput" class="output" style="display:none;"></pre>
    </section>

    <section class="section" id="sbarSection">
      <h2>SBAR ë³´ê³ </h2>
      <label for="situation">Situation (ìƒí™©)</label>
      <textarea id="situation" name="situation" placeholder="í˜„ì¬ ìƒí™© ì„¤ëª…" required></textarea>

      <label for="background">Background (ë°°ê²½)</label>
      <textarea id="background" name="background" placeholder="í™˜ì ë°°ê²½ ë° ë³‘ë ¥" required></textarea>

      <label for="assessment">Assessment (í‰ê°€)</label>
      <textarea id="assessment" name="assessment" placeholder="ì§„ë‹¨ ë° í‰ê°€ ë‚´ìš©" required></textarea>

      <label for="recommendation">Recommendation (ê¶Œê³ )</label>
      <textarea id="recommendation" name="recommendation" placeholder="ì˜ë£Œ ì§€ë„ ë° ê¶Œê³ ì‚¬í•­" required></textarea>

      <div class="button-group">
        <button type="button" id="saveSbar">ğŸ’¾ SBAR ì €ì¥</button>
        <button type="button" id="copySbar">ğŸ“‹ SBAR ë³µì‚¬</button>
        <button type="button" id="pdfSbar">ğŸ“„ SBAR PDF ì €ì¥</button>
      </div>
      <pre id="sbarOutput" class="output" style="display:none;"></pre>
    </section>

    <section class="section" id="vitalsSection">
      <h2>í™œë ¥ì§•í›„ ê¸°ë¡</h2>
      <label for="bp">í˜ˆì•• (mmHg)</label>
      <input type="text" id="bp" name="bp" placeholder="ì˜ˆ: 120/80" required />

      <label for="hr">ì‹¬ë°•ìˆ˜ (íšŒ/ë¶„)</label>
      <input type="number" id="hr" name="hr" min="30" max="200" required />

      <label for="rr">í˜¸í¡ìˆ˜ (íšŒ/ë¶„)</label>
      <input type="number" id="rr" name="rr" min="5" max="50" required />

      <label for="temp">ì²´ì˜¨ (â„ƒ)</label>
      <input type="number" step="0.1" id="temp" name="temp" min="30" max="45" required />

      <div class="button-group">
        <button type="button" id="saveVitals">ğŸ’¾ í™œë ¥ì§•í›„ ì €ì¥</button>
        <button type="button" id="copyVitals">ğŸ“‹ í™œë ¥ì§•í›„ ë³µì‚¬</button>
        <button type="button" id="pdfVitals">ğŸ“„ í™œë ¥ì§•í›„ PDF ì €ì¥</button>
      </div>
      <pre id="vitalsOutput" class="output" style="display:none;"></pre>
    </section>

    <section class="section" id="medicalSection">
      <h2>ì˜ë£Œ ì§€ë„</h2>
      <label for="medicalInstruction">ì˜ë£Œ ì§€ë„ ë‚´ìš©</label>
      <textarea id="medicalInstruction" name="medicalInstruction" placeholder="ì˜ë£Œ ì§€ì‹œ ë° ì¶”ê°€ ì²˜ì¹˜ ë‚´ìš©" required></textarea>
    </section>

    <button type="submit" id="submitForm">
        <i class="fas fa-file-excel"></i> ì „ì²´ ê¸°ë¡ Google Sheetsì— ì €ì¥ ë° ìš”ì•½ ìƒì„±
    </button>
  </form>

  <div id="overallOutput" class="output" style="display:none; margin-top: 30px;"></div>

  <h2>ì˜ë£Œì§€ë„ ìš”ì²­ ìš”ì•½</h2>
  <div id="summary" class="output" style="display:none;"></div>
  <div style="margin-top:10px; display:none;" id="summaryButtons">
    <button id="copySummary">ğŸ“‹ ìš”ì•½ ë³µì‚¬</button>
    <button id="saveSummaryPdf">ğŸ“„ ìš”ì•½ PDF ì €ì¥</button>
  </div>

  <div id="recentBox" style="display:none; margin-top:30px;">
    <h2>ğŸ“Œ ìµœê·¼ ê¸°ë¡</h2>
    <table id="recentTable"></table>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;

    // í•„ë“œ ì •ì˜
    const mistFields = ['mechanism', 'injury', 'signs', 'treatment'];
    const sbarFields = ['situation', 'background', 'assessment', 'recommendation'];
    const vitalsFields = ['bp', 'hr', 'rr', 'temp'];

    const form = document.getElementById('recordForm');
    const overallOutput = document.getElementById('overallOutput');
    const summaryDiv = document.getElementById('summary');
    const summaryButtons = document.getElementById('summaryButtons');
    const copySummaryBtn = document.getElementById('copySummary');
    const saveSummaryPdfBtn = document.getElementById('saveSummaryPdf');
    const recentBox = document.getElementById('recentBox');
    const recentTable = document.getElementById('recentTable');

    // âœ… Apps Script ë°°í¬ URL ì…ë ¥ - ì—¬ê¸°ì— ì‹¤ì œ URLì„ ë„£ìœ¼ì„¸ìš”!
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxFZ7HQj3IXeGe7_hwFGTX8K-E8Wo7POhI0qJ1_mj3W3arUR01lJwhFiP85OjJVccg/exec";

    // ===================== MIST ì €ì¥/ë³µì‚¬/PDF =====================
    const mistOutput = document.getElementById('mistOutput');
    document.getElementById('saveMist').addEventListener('click', () => {
      const values = mistFields.map(id => document.getElementById(id).value.trim());
      if (values.some(v => v === '')) return alert('MIST ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      mistOutput.textContent = `=== MIST ë³´ê³  ===\nMechanism: ${values[0]}\nInjury: ${values[1]}\nSigns: ${values[2]}\nTreatment: ${values[3]}`;
      mistOutput.style.display = 'block';
    });
    document.getElementById('copyMist').addEventListener('click', () => {
      if (mistOutput.style.display === 'none') return alert('ë¨¼ì € MIST ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      navigator.clipboard.writeText(mistOutput.textContent).then(() => alert('MIST ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
    });
    document.getElementById('pdfMist').addEventListener('click', () => {
      if (mistOutput.style.display === 'none') return alert('ë¨¼ì € MIST ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      const doc = new jsPDF();
      doc.text('MIST ë³´ê³ ', 10, 20);
      doc.text(doc.splitTextToSize(mistOutput.textContent, 180), 10, 30);
      doc.save('MIST_ë³´ê³ .pdf');
    });

    // ===================== SBAR ì €ì¥/ë³µì‚¬/PDF =====================
    const sbarOutput = document.getElementById('sbarOutput');
    document.getElementById('saveSbar').addEventListener('click', () => {
      const values = sbarFields.map(id => document.getElementById(id).value.trim());
      if (values.some(v => v === '')) return alert('SBAR ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      sbarOutput.textContent = `=== SBAR ë³´ê³  ===\nSituation: ${values[0]}\nBackground: ${values[1]}\nAssessment: ${values[2]}\nRecommendation: ${values[3]}`;
      sbarOutput.style.display = 'block';
    });
    document.getElementById('copySbar').addEventListener('click', () => {
      if (sbarOutput.style.display === 'none') return alert('ë¨¼ì € SBAR ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      navigator.clipboard.writeText(sbarOutput.textContent).then(() => alert('SBAR ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
    });
    document.getElementById('pdfSbar').addEventListener('click', () => {
      if (sbarOutput.style.display === 'none') return alert('ë¨¼ì € SBAR ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      const doc = new jsPDF();
      doc.text('SBAR ë³´ê³ ', 10, 20);
      doc.text(doc.splitTextToSize(sbarOutput.textContent, 180), 10, 30);
      doc.save('SBAR_ë³´ê³ .pdf');
    });

    // ===================== í™œë ¥ì§•í›„ ì €ì¥/ë³µì‚¬/PDF =====================
    const vitalsOutput = document.getElementById('vitalsOutput');
    document.getElementById('saveVitals').addEventListener('click', () => {
      const [bp, hr, rr, temp] = vitalsFields.map(id => document.getElementById(id).value.trim());
      if ([bp, hr, rr, temp].some(v => v === '')) return alert('í™œë ¥ì§•í›„ ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      vitalsOutput.textContent = `=== í™œë ¥ì§•í›„ ê¸°ë¡ ===\ní˜ˆì••: ${bp} mmHg\nì‹¬ë°•ìˆ˜: ${hr} íšŒ/ë¶„\ní˜¸í¡ìˆ˜: ${rr} íšŒ/ë¶„\nì²´ì˜¨: ${temp} â„ƒ`;
      vitalsOutput.style.display = 'block';
    });
    document.getElementById('copyVitals').addEventListener('click', () => {
      if (vitalsOutput.style.display === 'none') return alert('ë¨¼ì € í™œë ¥ì§•í›„ ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      navigator.clipboard.writeText(vitalsOutput.textContent).then(() => alert('í™œë ¥ì§•í›„ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
    });
    document.getElementById('pdfVitals').addEventListener('click', () => {
      if (vitalsOutput.style.display === 'none') return alert('ë¨¼ì € í™œë ¥ì§•í›„ ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      const doc = new jsPDF();
      doc.text('í™œë ¥ì§•í›„ ê¸°ë¡', 10, 20);
      doc.text(doc.splitTextToSize(vitalsOutput.textContent, 180), 10, 30);
      doc.save('í™œë ¥ì§•í›„_ê¸°ë¡.pdf');
    });

   // ===================== ì „ì²´ í¼ ì œì¶œ =====================
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const recordTime = form.recordTime.value;
      const mist = mistFields.map(id => document.getElementById(id).value.trim());
      const sbar = sbarFields.map(id => document.getElementById(id).value.trim());
      const [bp, hr, rr, temp] = vitalsFields.map(id => document.getElementById(id).value.trim());
      const medicalInstruction = document.getElementById('medicalInstruction').value.trim();

      const recordData = {
        recordTime,
        mist: { mechanism: mist[0], injury: mist[1], signs: mist[2], treatment: mist[3] },
        sbar: { situation: sbar[0], background: sbar[1], assessment: sbar[2], recommendation: sbar[3] },
        vitals: { bp, hr, rr, temp },
        medicalInstruction
      };

      // âœ… ìˆ˜ì •ëœ ë¶€ë¶„: "âœ… ì €ì¥ ì™„ë£Œ" í…ìŠ¤íŠ¸ë§Œ í‘œì‹œí•˜ê³  JSON ë°ì´í„°ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
      overallOutput.textContent = "âœ… ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
      overallOutput.style.display = "block";

      // ìš”ì•½
      let summaryText = `ì˜ë£Œì§€ë„ ìš”ì²­: ${medicalInstruction}`;
      summaryDiv.textContent = summaryText;
      summaryDiv.style.display = 'block';
      summaryButtons.style.display = 'block';

      // Google Apps Script ì €ì¥
      try {
        const response = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(recordData),
          headers: { "Content-Type": "application/json" }
        });
        const result = await response.json();
        if (result.status === "success") {
          alert("ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
          // ìµœê·¼ ê¸°ë¡ì„ ê°€ì ¸ì™€ í…Œì´ë¸”ì„ ë Œë”ë§
          const recentResponse = await fetch(SCRIPT_URL + "?action=getRecent");
          const recentData = await recentResponse.json();
          if (recentData.length > 0) {
              renderRecentTable(recentData);
              recentBox.style.display = "block";
          }
        } else {
          alert("ì €ì¥ ì‹¤íŒ¨: " + result.message);
        }
      } catch (err) {
        console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë˜ëŠ” URL ì˜¤ë¥˜");
      }
    });

      // í™”ë©´ ì¶œë ¥
      overallOutput.textContent = "âœ… ì €ì¥ ì™„ë£Œ\n" + JSON.stringify(recordData, null, 2);
      overallOutput.style.display = "block";

      // ìš”ì•½
      let summaryText = `ì˜ë£Œì§€ë„ ìš”ì²­: ${medicalInstruction}`;
      summaryDiv.textContent = summaryText;
      summaryDiv.style.display = 'block';
      summaryButtons.style.display = 'block';

      // Google Apps Script ì €ì¥
      try {
        const response = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(recordData),
          headers: { "Content-Type": "application/json" }
        });
        const result = await response.json();
        if (result.status === "success") {
          alert("ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
          // ìµœê·¼ ê¸°ë¡ì„ ê°€ì ¸ì™€ í…Œì´ë¸”ì„ ë Œë”ë§
          const recentResponse = await fetch(SCRIPT_URL + "?action=getRecent");
          const recentData = await recentResponse.json();
          if (recentData.length > 0) {
              renderRecentTable(recentData);
              recentBox.style.display = "block";
          }
        } else {
          alert("ì €ì¥ ì‹¤íŒ¨: " + result.message);
        }
      } catch (err) {
        console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë˜ëŠ” URL ì˜¤ë¥˜");
      }
    });

    // ìš”ì•½ ë³µì‚¬ & PDF
    copySummaryBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(summaryDiv.textContent).then(() => alert('ìš”ì•½ë¬¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
    });
    saveSummaryPdfBtn.addEventListener('click', () => {
      const doc = new jsPDF();
      doc.text("ì˜ë£Œì§€ë„ ìš”ì²­ ìš”ì•½", 10, 20);
      doc.text(doc.splitTextToSize(summaryDiv.textContent, 180), 10, 30);
      doc.save('ì˜ë£Œì§€ë„_ìš”ì²­_ìš”ì•½.pdf');
    });

    // ìµœê·¼ ê¸°ë¡ í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
    function renderRecentTable(data) {
      if (!Array.isArray(data) || data.length === 0) {
          recentTable.innerHTML = "<tr><td>ìµœê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
          return;
      }
      
      let html = "";
      // í…Œì´ë¸” í—¤ë” ìƒì„±
      const headers = Object.keys(data[0]);
      html += "<thead><tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr></thead>";
      
      // í…Œì´ë¸” ë°”ë”” ìƒì„± (ìµœê·¼ 5ê°œ ê¸°ë¡)
      html += "<tbody>";
      data.slice(0, 5).forEach(record => {
          html += "<tr>" + headers.map(h => `<td>${record[h] || ''}</td>`).join("") + "</tr>";
      });
      html += "</tbody>";
      
      recentTable.innerHTML = html;
    }
  </script>
</body>
</html>
