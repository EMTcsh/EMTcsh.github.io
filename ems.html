<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>응급 기록지</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f9; color: #333; }
    h1, h2 { color: #004085; }
    .section { background-color: #fff; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input[type="time"], input[type="text"], input[type="number"], textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 80px; }
    .button-group { margin-top: 15px; display: flex; gap: 10px; }
    button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; color: #fff; flex-grow: 1; transition: background-color 0.3s; }
    button:hover { filter: brightness(0.9); }
    button#saveMist, button#saveSbar, button#saveVitals { background-color: #28a745; }
    button#copyMist, button#copySbar, button#copyVitals { background-color: #17a2b8; }
    button#pdfMist, button#pdfSbar, button#pdfVitals { background-color: #dc3545; }
    button#copySummary { background-color: #17a2b8; }
    button#saveSummaryPdf { background-color: #dc3545; }
    button#submitForm { background-color: #28a745; margin-top: 20px; width: 100%; font-size: 18px; padding: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    button#submitForm:hover { background-color: #218838; }
    .output { background-color: #e9ecef; padding: 15px; margin-top: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
    #recentBox { margin-top: 30px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    #recentTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
    #recentTable th, #recentTable td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #recentTable th { background-color: #f2f2f2; }
</style>
</head>
<body>
<h1>MIST/SBAR/활력징후 기록 및 저장</h1>

<form id="recordForm">
    <label for="recordTime">기록 시간</label>
    <input type="time" id="recordTime" name="recordTime" required />

    <!-- MIST Section -->
    <section class="section" id="mistSection">
        <h2>MIST 보고</h2>
        <label for="mechanism">Mechanism (기전)</label>
        <textarea id="mechanism" name="mechanism" placeholder="예: 교통사고, 낙상 등" required></textarea>
        <label for="injury">Injury (손상부위)</label>
        <textarea id="injury" name="injury" placeholder="손상 부위 및 상태" required></textarea>
        <label for="signs">Signs (증상)</label>
        <textarea id="signs" name="signs" placeholder="환자 증상" required></textarea>
        <label for="treatment">Treatment (처치 내용)</label>
        <textarea id="treatment" name="treatment" placeholder="지금까지 시행된 처치" required></textarea>
        <div class="button-group">
            <button type="button" id="saveMist">💾 MIST 저장</button>
            <button type="button" id="copyMist">📋 MIST 복사</button>
            <button type="button" id="pdfMist">📄 MIST PDF 저장</button>
        </div>
        <pre id="mistOutput" class="output" style="display:none;"></pre>
    </section>

    <!-- SBAR Section -->
    <section class="section" id="sbarSection">
        <h2>SBAR 보고</h2>
        <label for="situation">Situation (상황)</label>
        <textarea id="situation" name="situation" placeholder="현재 상황 설명" required></textarea>
        <label for="background">Background (배경)</label>
        <textarea id="background" name="background" placeholder="환자 배경 및 병력" required></textarea>
        <label for="assessment">Assessment (평가)</label>
        <textarea id="assessment" name="assessment" placeholder="진단 및 평가 내용" required></textarea>
        <label for="recommendation">Recommendation (권고)</label>
        <textarea id="recommendation" name="recommendation" placeholder="의료 지도 및 권고사항" required></textarea>
        <div class="button-group">
            <button type="button" id="saveSbar">💾 SBAR 저장</button>
            <button type="button" id="copySbar">📋 SBAR 복사</button>
            <button type="button" id="pdfSbar">📄 SBAR PDF 저장</button>
        </div>
        <pre id="sbarOutput" class="output" style="display:none;"></pre>
    </section>

    <!-- Vitals Section -->
    <section class="section" id="vitalsSection">
        <h2>활력징후 기록</h2>
        <label for="bp">혈압 (mmHg)</label>
        <input type="text" id="bp" name="bp" placeholder="예: 120/80" required />
        <label for="hr">심박수 (회/분)</label>
        <input type="number" id="hr" name="hr" min="30" max="200" required />
        <label for="rr">호흡수 (회/분)</label>
        <input type="number" id="rr" name="rr" min="5" max="50" required />
        <label for="temp">체온 (℃)</label>
        <input type="number" step="0.1" id="temp" name="temp" min="30" max="45" required />
        <div class="button-group">
            <button type="button" id="saveVitals">💾 활력징후 저장</button>
            <button type="button" id="copyVitals">📋 활력징후 복사</button>
            <button type="button" id="pdfVitals">📄 활력징후 PDF 저장</button>
        </div>
        <pre id="vitalsOutput" class="output" style="display:none;"></pre>
    </section>

    <!-- Medical Instruction -->
    <section class="section" id="medicalSection">
        <h2>의료 지도</h2>
        <label for="medicalInstruction">의료 지도 내용</label>
        <textarea id="medicalInstruction" name="medicalInstruction" placeholder="의료 지시 및 추가 처치 내용" required></textarea>
    </section>

    <button type="submit" id="submitForm">
        <i class="fas fa-file-excel"></i> 전체 기록 Google Sheets에 저장 및 요약 생성
    </button>
</form>

<div id="overallOutput" class="output" style="display:none; margin-top: 30px;"></div>

<h2>의료지도 요청 요약</h2>
<div id="summary" class="output" style="display:none;"></div>
<div style="margin-top:10px; display:none;" id="summaryButtons">
    <button id="copySummary">📋 요약 복사</button>
    <button id="saveSummaryPdf">📄 요약 PDF 저장</button>
</div>

<div id="recentBox" style="display:none; margin-top:30px;">
    <h2>📌 최근 기록</h2>
    <table id="recentTable"></table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;
const mistFields = ['mechanism','injury','signs','treatment'];
const sbarFields = ['situation','background','assessment','recommendation'];
const vitalsFields = ['bp','hr','rr','temp'];
const form = document.getElementById('recordForm');
const overallOutput = document.getElementById('overallOutput');
const summaryDiv = document.getElementById('summary');
const summaryButtons = document.getElementById('summaryButtons');
const copySummaryBtn = document.getElementById('copySummary');
const saveSummaryPdfBtn = document.getElementById('saveSummaryPdf');
const recentBox = document.getElementById('recentBox');
const recentTable = document.getElementById('recentTable');

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwq3ksWHAtOhp6uon7cQYIDYTZXp35MWbNG1Lp_T3nViP2OqLbrxwbK93UDS-xqjLzC/exec";

// ----------- 공통 함수 -------------
async function saveToGoogleSheet(dataType, data){
    if(!data) return;
    try{
        const response = await fetch(SCRIPT_URL,{
            method:"POST",
            body: JSON.stringify({dataType, ...data}),
            headers: {"Content-Type": "application/json"}
        });
        const result = await response.json();
        if(result.status==="success"){
            alert(`${dataType} 기록이 스프레드시트에 저장되었습니다!`);
            if(dataType==='all'){
                const recentResponse = await fetch(SCRIPT_URL+"?action=getRecent");
                const recentData = await recentResponse.json();
                if(recentData.length>0){
                    renderRecentTable(recentData);
                    recentBox.style.display="block";
                }
            }
        } else { alert(`저장 실패: ${result.message}`); }
    } catch(err){
        console.error(err);
        alert("저장 중 오류 발생: 네트워크 문제 또는 URL 오류");
    }
}

function copyToClipboard(text){
    navigator.clipboard.writeText(text).then(()=>alert("복사 완료"));
}

function savePdf(title,text){
    const doc = new jsPDF();
    const lines = doc.splitTextToSize(text,180);
    doc.text(lines,10,10);
    doc.save(title);
}

function renderRecentTable(data){
    recentTable.innerHTML="";
    const headers = Object.keys(data[0]);
    let thead="<tr>"+headers.map(h=>`<th>${h}</th>`).join('')+"</tr>";
    recentTable.innerHTML=thead;
    data.forEach(row=>{
        let tr="<tr>"+headers.map(h=>`<td>${row[h]}</td>`).join('')+"</tr>";
        recentTable.innerHTML+=tr;
    });
}

// ---------------- MIST ----------------
const mistOutput = document.getElementById('mistOutput');
document.getElementById('saveMist').addEventListener('click',()=>{
    const values = mistFields.map(id=>document.getElementById(id).value.trim());
    if(values.some(v=>v==='')) return alert("MIST 모든 항목 입력필요");
    const data = {recordTime: form.recordTime.value, mist:{mechanism:values[0], injury:values[1], signs:values[2], treatment:values[3]}};
    mistOutput.textContent = `=== MIST 보고 ===\nMechanism: ${values[0]}\nInjury: ${values[1]}\nSigns: ${values[2]}\nTreatment: ${values[3]}`;
    mistOutput.style.display="block";
    saveToGoogleSheet("MIST",data);
});
document.getElementById('copyMist').addEventListener('click',()=>copyToClipboard(mistOutput.textContent));
document.getElementById('pdfMist').addEventListener('click',()=>savePdf("MIST.pdf",mistOutput.textContent));

// ---------------- SBAR ----------------
const sbarOutput = document.getElementById('sbarOutput');
document.getElementById('saveSbar').addEventListener('click',()=>{
    const values = sbarFields.map(id=>document.getElementById(id).value.trim());
    if(values.some(v=>v==='')) return alert("SBAR 모든 항목 입력필요");
    const data = {recordTime: form.recordTime.value, sbar:{situation:values[0], background:values[1], assessment:values[2], recommendation:values[3]}};
    sbarOutput.textContent = `=== SBAR 보고 ===\nSituation: ${values[0]}\nBackground: ${values[1]}\nAssessment: ${values[2]}\nRecommendation: ${values[3]}`;
    sbarOutput.style.display="block";
    saveToGoogleSheet("SBAR",data);
});
document.getElementById('copySbar').addEventListener('click',()=>copyToClipboard(sbarOutput.textContent));
document.getElementById('pdfSbar').addEventListener('click',()=>savePdf("SBAR.pdf",sbarOutput.textContent));

// ---------------- Vitals ----------------
const vitalsOutput = document.getElementById('vitalsOutput');
document.getElementById('saveVitals').addEventListener('click',()=>{
    const values = vitalsFields.map(id=>document.getElementById(id).value.trim());
    if(values.some(v=>v==='')) return alert("활력징후 모든 항목 입력필요");
    const data = {recordTime: form.recordTime.value, vitals:{bp:values[0], hr:values[1], rr:values[2], temp:values[3]}};
    vitalsOutput.textContent = `=== 활력징후 기록 ===\n혈압: ${values[0]}\n심박수: ${values[1]}\n호흡수: ${values[2]}\n체온: ${values[3]}`;
    vitalsOutput.style.display="block";
    saveToGoogleSheet("Vitals",data);
});
document.getElementById('copyVitals').addEventListener('click',()=>copyToClipboard(vitalsOutput.textContent));
document.getElementById('pdfVitals').addEventListener('click',()=>savePdf("Vitals.pdf",vitalsOutput.textContent));

// ---------------- 전체 제출 ----------------
form.addEventListener('submit',(e)=>{
    e.preventDefault();
    const recordData = {
        recordTime: form.recordTime.value,
        mist: mistFields.reduce((acc,id)=>({...acc,[id]:document.getElementById(id).value.trim()}),{}),
        sbar: sbarFields.reduce((acc,id)=>({...acc,[id]:document.getElementById(id).value.trim()}),{}),
        vitals: vitalsFields.reduce((acc,id)=>({...acc,[id]:document.getElementById(id).value.trim()}),{}),
        medicalInstruction: document.getElementById('medicalInstruction').value.trim()
    };
    overallOutput.textContent = "✅ 기록이 성공적으로 저장되었습니다.";
    overallOutput.style.display="block";
    summaryDiv.textContent = `의료지도 요청: ${recordData.medicalInstruction}`;
    summaryDiv.style.display="block";
    summaryButtons.style.display="block";
    saveToGoogleSheet("all",recordData);
});

// ---------------- 의료지도 요약 ----------------
copySummaryBtn.addEventListener('click',()=>copyToClipboard(summaryDiv.textContent));
saveSummaryPdfBtn.addEventListener('click',()=>savePdf("MedicalSummary.pdf",summaryDiv.textContent));
</script>
</body>
</html>
