<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸ†˜ ë¬´ë“±ì‚° íŠ¹ìˆ˜êµ¬ì¡°íŒ€ ì‹¤ì‹œê°„ ì‚°ì•…ì‚¬ê³  ì‹ ê³ ì ‘ìˆ˜</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ff9e145029506d6e4c72d1f2b01ea424&libraries=services"></script>

<style>
body{margin:0;font-family:Arial;background:#111;color:#fff;}
header{background:#b71c1c;padding:15px;text-align:center;font-size:20px;}
.container{padding:15px;}
.form-box{background:#222;padding:12px;margin-bottom:15px;border-radius:6px;}
input,textarea{width:100%;padding:8px;margin-bottom:8px;border-radius:4px;border:none;}
button{padding:8px 12px;background:#e53935;color:#fff;border:none;border-radius:4px;cursor:pointer;}
#map{width:100%;height:320px;margin-bottom:15px;border-radius:6px;}
.card{background:#1e1e1e;padding:12px;margin-bottom:10px;border-radius:6px;transition:0.2s;cursor:pointer;}
.card.done{opacity:0.6;background:#2b2b2b;}
.time{color:#ffcc00;font-size:14px;}
.coord{font-size:12px;color:#aaa;}
.maplink{color:#4fc3f7;font-size:12px;text-decoration:none;}
.maplink:hover{text-decoration:underline;}
.complete-btn{background:#2e7d32;margin-top:6px;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;}
.complete-btn:hover{opacity:0.8;}
</style>
</head>

<body>

<header>ğŸ†˜ ë¬´ë“±ì‚° íŠ¹ìˆ˜êµ¬ì¡°íŒ€ ì‹¤ì‹œê°„ ì‚°ì•…ì‚¬ê³  ì‹ ê³ ì ‘ìˆ˜</header>

<div class="container">

<div id="map"></div>

<div class="form-box">
  <h3>ğŸ“Œ ìœ„ì¹˜êµ¬ì¡° ì‹ ê³ ìš”ì²­ ë“±ë¡</h3>
  <textarea id="condition" placeholder="ì¦ìƒ ì…ë ¥"></textarea>
  <input type="text" id="phone" placeholder="ì—°ë½ì²˜ ì…ë ¥">
  <input type="text" id="address" placeholder="ì‹ ê³  ì£¼ì†Œ ì…ë ¥ (ì£¼ì†Œ ì…ë ¥ ì‹œ ì¢Œí‘œ ìë™ ì…ë ¥)">
  <input type="number" step="any" id="lat" placeholder="ìœ„ë„">
  <input type="number" step="any" id="lng" placeholder="ê²½ë„">
  <button onclick="submitData()">êµ¬ì¡° ìš”ì²­ ë“±ë¡</button>
</div>

<div id="listArea">ë¡œë”©ì¤‘...</div>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbybwt7-vC5W8NUmve94LLsdlIRFHoiw3wcIrWk9GZFRHnmZJ_0TEsihhz7oX8al_BYR_A/exec";

let map, geocoder, previewMarker=null, selectedMarker=null, selectedCard=null;

const conditionEl=document.getElementById("condition");
const phoneEl=document.getElementById("phone");
const addressEl=document.getElementById("address");
const latEl=document.getElementById("lat");
const lngEl=document.getElementById("lng");
const listArea=document.getElementById("listArea");

/******** ì§€ë„ ì´ˆê¸°í™” ********/
function initMap(){
  map=new kakao.maps.Map(document.getElementById("map"),{
    center:new kakao.maps.LatLng(35.1345,126.9902),
    level:6
  });
  geocoder=new kakao.maps.services.Geocoder();
}

/******** ì£¼ì†Œ â†’ ì¢Œí‘œ ìë™ ì…ë ¥ ********/
addressEl.addEventListener("change",function(){
  const address=this.value.trim();
  if(!address) return;
  geocoder.addressSearch(address,function(result,status){
    if(status===kakao.maps.services.Status.OK){
      const lat=parseFloat(result[0].y);
      const lng=parseFloat(result[0].x);
      latEl.value=lat;
      lngEl.value=lng;

      const pos=new kakao.maps.LatLng(lat,lng);
      map.setCenter(pos);
      map.setLevel(3);

      if(previewMarker) previewMarker.setMap(null);
      previewMarker=new kakao.maps.Marker({ map, position:pos });
    } else alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  });
});

/******** ë“±ë¡ ********/
async function submitData(){
  if(!conditionEl.value.trim()){ alert("ì¦ìƒ ì…ë ¥ í•„ìˆ˜"); return; }
  let lat=latEl.value, lng=lngEl.value;
  if(lat && lng){ sendData(parseFloat(lat),parseFloat(lng)); return; }
  if(navigator.geolocation)
    navigator.geolocation.getCurrentPosition(pos=>sendData(pos.coords.latitude,pos.coords.longitude));
}

async function sendData(lat,lng){
  await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({
      lat,lng,
      address:addressEl.value,
      symptom:conditionEl.value,
      phone:phoneEl.value,
      kakaoMapURL:`https://map.kakao.com/link/map/êµ¬ì¡°ìš”ì²­ ìœ„ì¹˜,${lat},${lng}`
    })
  });
  conditionEl.value=phoneEl.value=addressEl.value=latEl.value=lngEl.value="";
  if(previewMarker) previewMarker.setMap(null);
  loadData();
}

/******** ğŸš‘ í˜„ì¥ë„ì°© ********/
async function completeCase(id){
  if(!confirm("êµ¬ì¡°ëŒ€ì›ì´ í˜„ì¥ì— ë„ì°©í–ˆìŠµë‹ˆê¹Œ?")) return;
  try{
    await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body:JSON.stringify({
        action:"complete",
        id:id,
        completeTime:new Date().toISOString()
      })
    });
    loadData();
  }catch(err){
    alert("ì²˜ë¦¬ ì‹¤íŒ¨");
    console.error(err);
  }
}

/******** âœ… ì‚¬ê³ ì²˜ë¦¬ ì™„ë£Œ ********/
async function finishCase(id){
  if(!confirm("ì‚¬ê³ ì²˜ë¦¬ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  try{
    await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body:JSON.stringify({
        action:"finish",
        id:id,
        finishTime:new Date().toISOString()
      })
    });
    loadData();
  }catch(err){
    alert("ì²˜ë¦¬ ì‹¤íŒ¨");
    console.error(err);
  }
}

/******** ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ********/
async function loadData(){
  const res=await fetch(API_URL);
  const data=await res.json();
  listArea.innerHTML="";
  if(!data.length){
    listArea.innerHTML="í˜„ì¬ ì ‘ìˆ˜ëœ ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  data.sort((a,b)=>new Date(b.time)-new Date(a.time));

  data.forEach(item=>{
    const div=document.createElement("div");

    // ì‚¬ê³ ì²˜ë¦¬ ì™„ë£Œë§Œ íë¦¼ ì²˜ë¦¬
    div.className="card"+(item.status==="ì‚¬ê³ ì²˜ë¦¬ì™„ë£Œ"?" done":"");

    div.innerHTML=`
      <div class="time">ğŸ•’ ì ‘ìˆ˜: ${new Date(item.time).toLocaleString()}</div>

      ${item.status==="í˜„ì¥ë„ì°©"?
        `<div class="time">ğŸš‘ í˜„ì¥ë„ì°©: ${item.completeTime ? new Date(item.completeTime).toLocaleString() : ""}</div>`
        : ""}

      ${item.status==="ì‚¬ê³ ì²˜ë¦¬ì™„ë£Œ"?
        `<div class="time">ğŸš‘ í˜„ì¥ë„ì°©: ${item.completeTime ? new Date(item.completeTime).toLocaleString() : ""}</div>
         <div class="time">âœ… ì‚¬ê³ ì²˜ë¦¬ ì™„ë£Œ: ${item.finishTime ? new Date(item.finishTime).toLocaleString() : ""}</div>`
        : ""}

      ğŸ  ${item.address||"ì£¼ì†Œì—†ìŒ"}<br>
      ğŸ“ ${item.phone||"ë²ˆí˜¸ì—†ìŒ"}<br>
      ğŸ“ ${item.symptom||"ë‚´ìš©ì—†ìŒ"}<br>
      <div class="coord">ìœ„ë„: ${item.lat} / ê²½ë„: ${item.lng}</div>
      <a class="maplink" href="https://map.kakao.com/link/map/êµ¬ì¡°ìš”ì²­ ìœ„ì¹˜,${item.lat},${item.lng}" target="_blank">ğŸ“ ì§€ë„ë³´ê¸°</a><br>

      ${
        item.status==="ì‚¬ê³ ì²˜ë¦¬ì™„ë£Œ"
        ? ""
        : item.status==="í˜„ì¥ë„ì°©"
          ? `<button class="complete-btn" onclick="finishCase('${item.id}')">âœ… ì‚¬ê³ ì²˜ë¦¬ ì™„ë£Œ</button>`
          : `<button class="complete-btn" onclick="completeCase('${item.id}')">ğŸš‘ êµ¬ì¡°ëŒ€ì› í˜„ì¥ë„ì°©</button>`
      }
    `;

    listArea.appendChild(div);
  });
}

initMap();
loadData();
setInterval(loadData,10000);
</script>

</body>
</html>
