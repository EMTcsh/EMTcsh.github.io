<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>국립공원 안전산행 체크인/아웃</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 480px; margin: auto; }
  input, button { padding: 12px; margin: 5px 0; width: 100%; font-size: 16px; }
  button { border: none; border-radius: 8px; color: white; cursor: pointer; }
  button.start { background-color: #007BFF; }
  button.mid { background-color: #FFC107; color: black; }
  button.end { background-color: #28A745; }
  .log { margin-top: 20px; font-size: 14px; word-break: break-word; }
  .alert { color: red; font-weight: bold; margin-bottom: 10px; }
  #message { margin-top: 10px; font-weight: bold; font-size: 18px; }
</style>
</head>
<body>

<h2>국립공원 안전산행 체크인/아웃</h2>

<label>전화번호:</label>
<input type="text" id="phone" placeholder="010-1234-5678" inputmode="tel">

<button class="start" onclick="checkIn('start')">입구 체크인</button>
<button class="mid" onclick="checkIn('mid')">산행 중 체크</button>
<button class="end" onclick="checkIn('end')">출구 체크아웃</button>

<div id="message"></div>
<div class="log" id="log"></div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwjufnBNZtPhucvyQ4BMImls7fR064bkuGPY5UQjpnPVtNW7Z9GU5BhTBDQnu94QnUo/exec'; // Apps Script URL 입력

let startTime, midTime, endTime;

function getLocation(callback) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            callback({ lat: position.coords.latitude, lng: position.coords.longitude });
        }, () => { alert("위치 정보를 가져올 수 없습니다."); });
    } else {
        alert("GPS를 지원하지 않는 기기입니다.");
    }
}

function checkIn(type) {
    const phone = document.getElementById('phone').value;
    if (!phone) { alert("전화번호를 입력해주세요."); return; }

    getLocation((coords) => {
        const now = new Date();
        const record = {
            phone: phone,
            type: type,
            lat: coords.lat,
            lng: coords.lng,
            timestamp: now.toISOString(),
            mapLink: `https://www.google.com/maps?q=${coords.lat},${coords.lng}`
        };

        if (type === 'start') startTime = now;
        if (type === 'mid') midTime = now;
        if (type === 'end') {
            endTime = now;
            const duration = ((endTime - startTime)/1000/60).toFixed(1);
            record.duration = duration + "분";
        }

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(record)
        }).then(() => {
            let logText = `${type} 체크 완료: ${record.lat}, ${record.lng} - <a href="${record.mapLink}" target="_blank">지도보기</a>`;
            if (record.duration) logText += `, 총 산행 시간: ${record.duration}`;
            document.getElementById('log').innerHTML += `<p>${logText}</p>`;

            const msgDiv = document.getElementById('message');
            if (type === 'start') msgDiv.style.color = '#007BFF';
            else if (type === 'mid') msgDiv.style.color = '#FFC107';
            else if (type === 'end') msgDiv.style.color = '#28A745';

            msgDiv.textContent = "잘되었습니다";
            setTimeout(() => { msgDiv.textContent = ""; }, 3000);
        });
    });
}

// 퇴실 미체크 경고 (24시간)
setInterval(() => {
    if (startTime && !endTime) {
        const now = new Date();
        const hours = (now - startTime)/1000/60/60;
        if (hours > 24 && !document.getElementById('alert')) {
            const alertDiv = document.createElement('div');
            alertDiv.id = 'alert';
            alertDiv.className = 'alert';
            alertDiv.textContent = '⚠️ 퇴실 시간이 지났습니다. 확인 필요!';
            document.body.prepend(alertDiv);
        }
    }
}, 60000);
</script>

</body>
</html>
