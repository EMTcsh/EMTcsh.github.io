<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸ†˜ ì‚°ì•…ì‚¬ê³  êµ¬ì¡°ìš”ì²­</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ff9e145029506d6e4c72d1f2b01ea424&libraries=services"></script>
<style>
body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
header { background:#b71c1c; color:white; padding:14px; text-align:center; font-size:20px; }
#map { width:100%; height:450px; }
section { padding:15px; padding-bottom:30px; }
button { width:90%; padding:12px; margin-top:10px; font-size:18px; }
button { background:#d32f2f; color:white; border:none; border-radius:6px; cursor:pointer; }
.info { background:white; padding:12px; border-radius:6px; margin-bottom:10px; }
.small { font-size:14px; color:#555; }
</style>
</head>
<body>

<header>ğŸ†˜ ë¬´ë“±ì‚° ì‚°ì•…êµ¬ì¡° ìš”ì²­</header>

<div class="info">
  <section>
    <div class="info" id="gpsInfo">ğŸ“ í˜„ì¬ ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>
    <button onclick="sendSMSAndCall()">âœ‰ï¸ ì‚°ì•…êµ¬ì¡°ëŒ€ ë¬¸ìì „ì†¡</button>
  </section>
</div>

<div class="small">
<b>ğŸ“ ìœ„ì¹˜ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ì•ˆë‚´</b><br>
êµ¬ì¡° ìš”ì²­ ì‹œ <b>GPS ìœ„ì¹˜ì •ë³´ì™€ ìš”ì²­ ì‹œê°</b>ì„ ìˆ˜ì§‘í•˜ë©°,
ì´ ì •ë³´ëŠ” êµ¬ì¡°Â·êµ¬ê¸‰ ëª©ì ì—ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.<br>
<b>[ë¬¸ì ì „ì†¡ ë²„íŠ¼]</b>ì„ ëˆ„ë¥´ë©´ ìœ„ì¹˜ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.
</div>

<div class="small">
â€» ë¬¸ìì „ì†¡ì€ <b>ë¬´ë“±ì‚° íŠ¹ìˆ˜ì‚°ì•…êµ¬ì¡°ëŒ€</b>ë¡œ ì—°ê²°ë©ë‹ˆë‹¤
</div>

<br>
<div id="map"></div>

<script>
let map, userMarker;
let currentLat = null, currentLng = null;
let markers = [];

const RESCUE_NUMBER = "01066650113";
const GOOGLE_SHEET_API = "https://script.google.com/macros/s/AKfycbwR_WOHslJnvmdI9K0Vckgr1k6_ZPJVdgF6ynwxVxXJ1qlzHw9nxc3HPVM8mn_qp7k/exec";

// ì§€ë„ ì´ˆê¸°í™”
function initMap(latInit = 35.131295, lngInit = 126.948047) {
    map = new kakao.maps.Map(document.getElementById("map"), {
        center: new kakao.maps.LatLng(latInit, lngInit),
        level: 3
    });
    userMarker = new kakao.maps.Marker({ map: map });
}
initMap();

// GPS ì‹¤ì‹œê°„ ì¶”ì 
if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
        pos => {
            currentLat = pos.coords.latitude;
            currentLng = pos.coords.longitude;
            const loc = new kakao.maps.LatLng(currentLat, currentLng);
            map.setCenter(loc);
            userMarker.setPosition(loc);
            document.getElementById("gpsInfo").innerHTML =
                `ğŸ“ í˜„ì¬ ìœ„ì¹˜<br>ìœ„ë„: ${currentLat.toFixed(6)}<br>ê²½ë„: ${currentLng.toFixed(6)}`;
        },
        () => {
            document.getElementById("gpsInfo").innerHTML =
                "ğŸ“ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨: ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.";
        },
        { enableHighAccuracy:true }
    );
}

// êµ¬ì¡° ìš”ì²­ ë¶ˆëŸ¬ì˜¤ê¸°
function loadAllRequests() {
    fetch(GOOGLE_SHEET_API + "?action=get")
        .then(res => res.json())
        .then(data => {
            if (!Array.isArray(data)) return;
            markers.forEach(m => m.setMap(null));
            markers = [];
            data.forEach(item => {
                const pos = new kakao.maps.LatLng(item.lat, item.lng);
                const marker = new kakao.maps.Marker({ map, position: pos });
                markers.push(marker);
            });
        });
}
setInterval(loadAllRequests, 5000);

// SMS ì „ì†¡
function sendSMSAndCall() {
    if (!currentLat || !currentLng) {
        alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const lat = currentLat.toFixed(6);
    const lng = currentLng.toFixed(6);
    const kakaoMapLink = `http://map.kakao.com/link/map/${lat},${lng}`;

    fetch(GOOGLE_SHEET_API, {
        method: "POST",
        body: JSON.stringify({ lat: +lat, lng: +lng })
    });

    if (/Mobi|Android/i.test(navigator.userAgent)) {
        location.href = `sms:${RESCUE_NUMBER}?body=${encodeURIComponent(
`ğŸš¨ [ì‚°ì•…êµ¬ì¡°ìš”ì²­]
ğŸ“ ìœ„ë„: ${lat}
ğŸ“ ê²½ë„: ${lng}
ğŸ—º ì¹´ì¹´ì˜¤ë§µ: ${kakaoMapLink}`
        )}`;
    } else {
        alert("ëª¨ë°”ì¼ì—ì„œë§Œ ë¬¸ì ì „ì†¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    }
}
</script>

</body>
</html>
