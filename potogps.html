<!doctype html>

<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>사진에서 좌표 추출 & 지도 표시</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; margin:12px}
    .container{max-width:980px;margin:0 auto}
    #preview{max-width:100%;height:auto;border:1px solid #ddd;padding:6px;background:#fafafa}
    #map{height:420px;margin-top:12px;border-radius:8px;overflow:hidden}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{flex:1 1 320px;padding:12px;border-radius:8px;border:1px solid #eee;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
    label{display:block;margin-bottom:6px;font-weight:600}
    input[type=file]{display:block}
    button{padding:8px 12px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    pre{background:#111;color:#fff;padding:10px;border-radius:6px;overflow:auto}
    small{color:#666}
  </style>
</head>
<body>
  <div class="container">
    <h1>사진에서 좌표 추출 & 지도 표시</h1>
    <p>사진을 업로드하면 EXIF GPS 정보를 읽어 지도에 자동 표시합니다. (OCR 제외)</p><div class="row">
  <div class="card">
    <label for="fileInput">사진 선택</label>
    <input id="fileInput" type="file" accept="image/*" />

    <hr />
    <label>사진 미리보기</label>
    <img id="preview" alt="preview" />

    <hr />
    <label>추출된 좌표</label>
    <div id="coordsArea"><em>아직 분석되지 않음</em></div>
  </div>

  <div class="card">
    <label>로그 / 디버그</label>
    <pre id="log">대기 중...</pre>
  </div>
</div>

<div id="map"></div>

  </div>  <!-- 필요한 라이브러리: EXIF.js, Leaflet -->  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>  <script>
    function gpsToDecimal(gpsData, ref) {
      if (!gpsData) return null;
      const toNumber = (v) => {
        if (typeof v === 'number') return v;
        if (v.numerator !== undefined) return v.numerator / v.denominator;
        if (Array.isArray(v)) return v[0] / v[1];
        return Number(v);
      }
      const d = toNumber(gpsData[0]);
      const m = toNumber(gpsData[1]);
      const s = toNumber(gpsData[2]);
      let dec = d + m/60 + s/3600;
      if (ref === 'S' || ref === 'W') dec = -dec;
      return dec;
    }

    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const coordsArea = document.getElementById('coordsArea');
    const log = document.getElementById('log');

    let lastCoords = null;
    let marker = null;

    function appendLog(s){ log.textContent = new Date().toLocaleTimeString() + ' - ' + s + "\n" + log.textContent; }

    // 지도 초기화
    const map = L.map('map').setView([37.5665, 126.9780], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      preview.src = url;
      coordsArea.innerHTML = '<em>분석 중...</em>';
      appendLog('이미지 선택됨: ' + f.name);

      // EXIF 읽기
      try {
        EXIF.getData(f, function() {
          const gpsLat = EXIF.getTag(this, 'GPSLatitude');
          const gpsLatRef = EXIF.getTag(this, 'GPSLatitudeRef');
          const gpsLng = EXIF.getTag(this, 'GPSLongitude');
          const gpsLngRef = EXIF.getTag(this, 'GPSLongitudeRef');
          if (gpsLat && gpsLng) {
            const lat = gpsToDecimal(gpsLat, gpsLatRef);
            const lng = gpsToDecimal(gpsLng, gpsLngRef);
            lastCoords = {lat, lng, source: 'exif'};
            coordsArea.innerHTML = `<strong>EXIF GPS:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            appendLog('EXIF 좌표 발견: ' + lat + ', ' + lng);

            // 지도에 자동 표시
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lng]).addTo(map).bindPopup(`추출 좌표<br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br><small>출처: EXIF</small>`).openPopup();
            map.setView([lat, lng], 16);
            appendLog('마커 자동 추가 완료.');
          } else {
            coordsArea.innerHTML = '<em>EXIF GPS 정보 없음</em>';
            appendLog('EXIF에 GPS 정보 없음.');
          }
        });
      } catch (err) {
        appendLog('EXIF 처리 중 오류: ' + err);
        coordsArea.innerHTML = '<em>분석 실패: 예외 발생</em>';
      }
    });

    appendLog('준비 완료 — 이미지를 선택하면 자동으로 좌표를 분석하고 지도에 표시합니다.');
  </script></body>
</html>