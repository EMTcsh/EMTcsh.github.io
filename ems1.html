<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PARAMEDIC 응급환자 평가도구</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; }
  .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
  .board-item { border-bottom: 1px solid #ddd; padding: 10px 0; white-space: pre-line; }
  .vitalsRow { border: 1px dashed #ccc; padding: 5px; margin-bottom: 10px; border-radius: 5px; background-color: #fff; }
</style>
</head>
<body>

<h1 class="text-2xl font-bold mb-4">🚑 PARAMEDIC 응급환자 평가도구</h1>

<form id="recordForm">
  <!-- 환자 정보 -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">환자 정보</h2>
    <label>이름: <input type="text" name="환자이름" required class="rounded-lg"></label><br>
    <label>생년월일: <input type="date" name="생년월일" required class="rounded-lg"></label>
  </div>

  <!-- 활력징후 -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">활력징후 (여러 회 측정 가능)</h2>
    <div id="vitalSignsContainer"></div>
    <button type="button" onclick="addVitalSigns()" class="bg-green-600 text-white px-3 py-1 rounded">+ 활력징후 추가</button>
  </div>

  <!-- GCS -->
  <div class="section">
    <h2 class="text-xl font-semibold">Glasgow Coma Scale (GCS)</h2>
    <label>눈 반응 (E)</label>
    <select id="eye">
      <option value="4">자발적으로 열림</option>
      <option value="3">소리 자극에 열림</option>
      <option value="2">통증 자극에 열림</option>
      <option value="1">전혀 열림 안함</option>
    </select>
    <label>언어 반응 (V)</label>
    <select id="verbal">
      <option value="5">정확한 대답</option>
      <option value="4">혼잡한 대답</option>
      <option value="3">혼미한 대답</option>
      <option value="2">모호한 대답</option>
      <option value="1">응답 없음</option>
    </select>
    <label>운동 반응 (M)</label>
    <select id="motor">
      <option value="6">명령 수행</option>
      <option value="5">통증 자극에 국소화</option>
      <option value="4">통증 자극에 굴곡</option>
      <option value="3">통증 자극에 구부리기</option>
      <option value="2">경련</option>
      <option value="1">운동 없음</option>
    </select>
    <div id="gcsResultContainer" style="margin-top:10px; display:none;">
      <strong>GCS 결과:</strong> <span id="gcsResult"></span>
    </div>
  </div>

  <!-- 응급처치 -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">응급처치</h2>
    <textarea name="응급처치" rows="4" placeholder="실시한 응급처치 기록" class="w-full rounded-lg"></textarea>
  </div>

  <!-- 상황 정보 -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">상황 정보</h2>
    <label>발생 시간: <input type="datetime-local" name="발생시간" required class="rounded-lg"></label><br>
    <label>장소: <input type="text" name="장소" placeholder="예: OO동 123-45" required class="rounded-lg"></label><br>
    <label>주 증상: <input type="text" name="주증상" placeholder="예: 호흡곤란, 가슴 통증" required class="rounded-lg"></label>
  </div>

  <!-- 기록자 -->
  <div class="section">
    <h2 class="text-xl font-semibold">기록자</h2>
    <input type="text" name="기록자" placeholder="응급구조사 성명" required class="rounded-lg">
  </div>

  <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg">기록 + 다운로드</button>
  <div id="resultMessage" class="mt-4 text-center"></div>
</form>

<div class="section">
  <h2 class="text-xl font-semibold">저장된 기록</h2>
  <div id="savedData"></div>
</div>

<script>
function addVitalSigns(){
  const container = document.getElementById("vitalSignsContainer");
  const index = container.children.length + 1;
  const div = document.createElement("div");
  div.className = "vitalsRow";
  div.innerHTML = `
    <strong>${index}회차 측정</strong><br>
    혈압: <input type="text" name="혈압[]" placeholder="120/80"><br>
    맥박: <input type="number" name="맥박[]" placeholder="회/분"><br>
    호흡수: <input type="number" name="호흡수[]" placeholder="회/분"><br>
    체온: <input type="number" step="0.1" name="체온[]" placeholder="℃"><br>
    SpO₂: <input type="number" name="산소포화도[]" placeholder="%"><br>
  `;
  container.appendChild(div);
}
addVitalSigns();

function calculateGCS() {
  const eye = parseInt(document.getElementById("eye").value);
  const verbal = parseInt(document.getElementById("verbal").value);
  const motor = parseInt(document.getElementById("motor").value);
  const total = eye + verbal + motor;
  let state = '';
  if(total === 15) state='정상';
  else if(total >=13) state='졸림';
  else if(total >=9) state='혼미';
  else if(total >=4) state='반혼수';
  else state='혼수';
  document.getElementById("gcsResult").innerText = `${total}점 (${state})`;
  document.getElementById("gcsResultContainer").style.display="block";
}
["eye","verbal","motor"].forEach(id=>document.getElementById(id).addEventListener("change",calculateGCS));
calculateGCS();

document.getElementById("recordForm").addEventListener("submit", e=>{
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {};
  for(const [key,value] of formData.entries()){
    if(key.endsWith("[]")){
      const baseKey = key.replace("[]","");
      if(!data[baseKey]) data[baseKey]=[];
      data[baseKey].push(value);
    } else {
      data[key] = value;
    }
  }
  data.GCS = document.getElementById("gcsResult").innerText;

  // Google Sheet 저장 + 다운로드
  google.script.run.withSuccessHandler(res=>{
    document.getElementById("resultMessage").innerText = res;

    // TXT 다운로드
    let content = "";
    for(const k in data){
      content += Array.isArray(data[k]) ? `${k}: ${data[k].join(", ")}\n` : `${k}: ${data[k]}\n`;
    }
    const today = new Date().toISOString().slice(0,10);
    const blob = new Blob([content],{type:"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `환자평가_${today}.txt`;
    a.click();
    URL.revokeObjectURL(url);

    document.getElementById("savedData").innerText = content;

  }).withFailureHandler(err=>{
    document.getElementById("resultMessage").innerText = "저장 실패 ❌ "+err.message;
  }).saveRecord(data);
});
</script>
</body>
</html>

