<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸï¸ êµ­ë¦½ê³µì› ì•ˆì „ì‚°í–‰ ì²´í¬</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.container{max-width:500px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1)}
h2{text-align:center}
button{width:100%;padding:15px;font-size:16px;margin-top:10px;border:none;border-radius:6px;color:#fff}
.entry{background:#4caf50}
.mid{background:#2196f3}
.exit{background:#f44336}
input{width:80%;padding:12px;font-size:15px;margin-bottom:10px}
#result{margin-top:15px;font-size:14px;background:#f1f1f1;padding:10px;border-radius:6px}
</style>
</head>
<body>
<div class="container">
<h2>ğŸï¸ êµ­ë¦½ê³µì› ì•ˆì „ì‚°í–‰ ì²´í¬</h2>
<input type="tel" id="phone" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ (ìµœì´ˆ 1íšŒ ì…ë ¥)">
<button class="entry" onclick="scan('ì…ì¥')">ì…êµ¬ ìŠ¤ìº”</button>
<button class="mid" onclick="scan('ì¤‘ê°„')">ì¤‘ê°„ ìŠ¤ìº”</button>
<button class="exit" onclick="scan('í‡´ì¥')">ì¶œêµ¬ ìŠ¤ìº”</button>
<div id="result">ëŒ€ê¸° ì¤‘...</div>
</div>
<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwwadT2YGMxgPQk34MJFX6PHjIcreBNiJ6_NTeeaqYqHPGoZhTka5j31rRGDdCw8w9J/exec";

if(localStorage.phone){
 document.getElementById('phone').value = localStorage.phone;
}

function scan(stage){
 const phone = document.getElementById('phone').value.trim();
 if(!phone){alert('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');return;}
 localStorage.phone = phone;

 if(!navigator.geolocation){alert('GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤');return;}

 document.getElementById('result').innerText = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';

 navigator.geolocation.getCurrentPosition(pos=>{
   const lat = pos.coords.latitude.toFixed(6);
   const lng = pos.coords.longitude.toFixed(6);
   const time = new Date().toLocaleString();

   document.getElementById('result').innerHTML =
     `ğŸ“ ${stage} ì¢Œí‘œ í™•ì¸<br>ìœ„ë„: ${lat}<br>ê²½ë„: ${lng}<br>ì „ì†¡ ì¤‘...`;

   fetch(SHEET_URL,{
     method:'POST',
     headers:{'Content-Type':'application/json'},
     body:JSON.stringify({
       stage:stage,
       phone:phone,
       lat:lat,
       lng:lng,
       time:time
     })
   }).then(()=>{
     document.getElementById('result').innerHTML =
       `âœ… ${stage} ì™„ë£Œ<br>ìœ„ë„: ${lat}<br>ê²½ë„: ${lng}<br><b>êµ¬ê¸€ì‹œíŠ¸ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤</b>`;
   }).catch(()=>{
     document.getElementById('result').innerText = 'âŒ ì „ì†¡ ì‹¤íŒ¨';
   });
 },()=>alert('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤'));
}
</script>
</body>
</html>

<!-- ================= GOOGLE APPS SCRIPT =================
const SPREADSHEET_ID = '1uftb9c8nEyHv6BEdpFcGCbUaOmRTyj0Y9iOQCit95cs';

function doPost(e) {
  try {
    const d = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);

    // â–¶ ë‹¨ê³„ë³„ ì‹œíŠ¸ ì €ì¥
    const sheet =
      ss.getSheetByName(d.stage) || ss.insertSheet(d.stage);

    sheet.appendRow([
      new Date(),
      d.stage,
      d.phone,
      d.lat,
      d.lng,
      d.time
    ]);

    // â–¶ ë¯¸ì™„ë£Œ ì‹œíŠ¸ ìë™ ê°±ì‹ 
    updateIncompleteSheet(ss);

    return ContentService
      .createTextOutput(JSON.stringify({ result: 'OK' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ error: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function updateIncompleteSheet(ss) {
  const entry = getPhones(ss, 'ì…ì¥');
  const mid   = getPhones(ss, 'ì¤‘ê°„');
  const exit  = getPhones(ss, 'í‡´ì¥');

  const sheet =
    ss.getSheetByName('ë¯¸ì™„ë£Œ') || ss.insertSheet('ë¯¸ì™„ë£Œ');

  sheet.clear();
  sheet.appendRow([
    'ì „í™”ë²ˆí˜¸',
    'ì…ì¥',
    'ì¤‘ê°„',
    'í‡´ì¥',
    'ìƒíƒœ'
  ]);

  const all = new Set([...entry, ...mid, ...exit]);

  all.forEach(p => {
    const e = entry.has(p);
    const m = mid.has(p);
    const x = exit.has(p);

    if (e && !x) {
      sheet.appendRow([
        p,
        e ? 'O' : 'X',
        m ? 'O' : 'X',
        x ? 'O' : 'X',
        m ? 'í‡´ì¥ ë¯¸í™•ì¸' : 'ì¤‘ê°„Â·í‡´ì¥ ë¯¸í™•ì¸'
      ]);
    }
  });
}

function getPhones(ss, name) {
  const sh = ss.getSheetByName(name);
  if (!sh) return new Set();

  const v = sh.getDataRange().getValues();
  const s = new Set();

  for (let i = 1; i < v.length; i++) {
    s.add(v[i][2]); // Cì—´ = ì „í™”ë²ˆí˜¸
  }
  return s;
}

======================================================= -->
