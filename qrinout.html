<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>êµ­ë¦½ê³µì› ì•ˆì „ì‚°í–‰ ì²´í¬</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.container{max-width:500px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1)}
h2{text-align:center}
button{width:100%;padding:15px;font-size:16px;margin-top:10px;border:none;border-radius:6px;color:#fff}
.entry{background:#4caf50}
.mid{background:#2196f3}
.exit{background:#f44336}
input{width:100%;padding:12px;font-size:15px;margin-bottom:10px}
#result{margin-top:15px;font-size:14px;background:#f1f1f1;padding:10px;border-radius:6px}
</style>
</head>

<body>
<div class="container">
  <h2>êµ­ë¦½ê³µì› ì•ˆì „ì‚°í–‰ ì²´í¬</h2>

  <input type="tel" id="phone" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ (ìµœì´ˆ 1íšŒ ì…ë ¥)">

  <button class="entry" onclick="scan('ì…ì¥')">ì…êµ¬ ìŠ¤ìº”</button>
  <button class="mid" onclick="scan('ì¤‘ê°„')">ì¤‘ê°„ ìŠ¤ìº”</button>
  <button class="exit" onclick="scan('í‡´ì¥')">ì¶œêµ¬ ìŠ¤ìº”</button>

  <div id="result">ëŒ€ê¸° ì¤‘...</div>
</div>

<script>
/* â­â­â­ ë°˜ë“œì‹œ ì…ë ¥ â­â­â­ */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbzbcI6n1DtwEFN4HvwdQ7fUJiH_7asagQjT4l5QdrMdUMtGHfspOy0_4JzXfw7oHEH2/exec";

/* ì „í™”ë²ˆí˜¸ ê¸°ì–µ */
if(localStorage.phone){
  document.getElementById('phone').value = localStorage.phone;
}

function scan(stage){
  const phone = document.getElementById('phone').value.trim();
  if(!phone){
    alert('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
    return;
  }
  localStorage.phone = phone;

  if(!navigator.geolocation){
    alert('GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤');
    return;
  }

  document.getElementById('result').innerText = 'ğŸ“¡ ìœ„ì¹˜ í™•ì¸ ì¤‘...';

  navigator.geolocation.getCurrentPosition(pos=>{
    const lat  = pos.coords.latitude.toFixed(6);
    const lng  = pos.coords.longitude.toFixed(6);
    const time = new Date().toLocaleString();

    document.getElementById('result').innerHTML =
      `ğŸ“ ${stage} ì¢Œí‘œ í™•ì¸<br>
       ìœ„ë„: ${lat}<br>
       ê²½ë„: ${lng}<br>
       ì „ì†¡ ì¤‘...`;

    fetch(SHEET_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ stage, phone, lat, lng, time })
    })
    .then(res => res.json())
    .then(data => {
      if(data.result === 'OK'){
        document.getElementById('result').innerHTML =
          `âœ… ${stage} ì™„ë£Œ<br><b>êµ¬ê¸€ì‹œíŠ¸ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤</b>`;
      } else {
        throw new Error(data.error);
      }
    })
    .catch(err => {
      document.getElementById('result').innerText =
        'âŒ ì „ì†¡ ì‹¤íŒ¨: ' + err.message;
    });

  }, ()=>{
    alert('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
  });
}
</script>
</body>
</html>


<!-- ================= GOOGLE APPS SCRIPT =================

const SPREADSHEET_ID = '1DMwMD4nrefM2qfP-e7AlirEzBtTFXUuH0twvW2EHUCw';

/**
 * ì›¹ì•± POST ìˆ˜ì‹ 
 */
function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error('POST ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
    }

    const d = JSON.parse(e.postData.contents);

    if (!d.stage || !d.phone) {
      throw new Error('í•„ìˆ˜ê°’(stage, phone) ëˆ„ë½');
    }

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);

    // 1ï¸âƒ£ ì…ì¥ / ì¤‘ê°„ / í‡´ì¥ ì‹œíŠ¸ì— ì›ë³¸ ì €ì¥
    const sheet =
      ss.getSheetByName(d.stage) || ss.insertSheet(d.stage);

    // í—¤ë” ì—†ìœ¼ë©´ ìƒì„±
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        'ê¸°ë¡ì‹œê°„',
        'ë‹¨ê³„',
        'ì „í™”ë²ˆí˜¸',
        'ìœ„ë„',
        'ê²½ë„',
        'ì‚¬ìš©ìì‹œê°„'
      ]);
    }

    sheet.appendRow([
      new Date(),
      d.stage,
      d.phone,
      d.lat || '',
      d.lng || '',
      d.time || ''
    ]);

    // 2ï¸âƒ£ ë¯¸ì™„ë£Œ ì‹œíŠ¸ ìë™ ê°±ì‹ 
    updateIncompleteSheet(ss);

    // âœ… ë°˜ë“œì‹œ JSON ì‘ë‹µ
    return ContentService
      .createTextOutput(JSON.stringify({ result: 'OK' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({
        result: 'ERROR',
        error: err.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ë¯¸ì™„ë£Œ íƒë°©ê° ì‹œíŠ¸ ìƒì„±/ê°±ì‹ 
 */
function updateIncompleteSheet(ss) {
  const entry = getPhones(ss, 'ì…ì¥');
  const mid   = getPhones(ss, 'ì¤‘ê°„');
  const exit  = getPhones(ss, 'í‡´ì¥');

  const sheet =
    ss.getSheetByName('ë¯¸ì™„ë£Œ') || ss.insertSheet('ë¯¸ì™„ë£Œ');

  sheet.clear();
  sheet.appendRow([
    'ì „í™”ë²ˆí˜¸',
    'ì…ì¥',
    'ì¤‘ê°„',
    'í‡´ì¥',
    'ìƒíƒœ'
  ]);

  const allPhones = new Set([
    ...entry,
    ...mid,
    ...exit
  ]);

  allPhones.forEach(phone => {
    const hasEntry = entry.has(phone);
    const hasMid   = mid.has(phone);
    const hasExit  = exit.has(phone);

    // ì…ì¥ì€ í–ˆëŠ”ë° í‡´ì¥ì€ ì•ˆ í•œ ê²½ìš°ë§Œ í‘œì‹œ
    if (hasEntry && !hasExit) {
      sheet.appendRow([
        phone,
        hasEntry ? 'O' : 'X',
        hasMid   ? 'O' : 'X',
        hasExit  ? 'O' : 'X',
        hasMid ? 'í‡´ì¥ ë¯¸í™•ì¸' : 'ì¤‘ê°„Â·í‡´ì¥ ë¯¸í™•ì¸'
      ]);
    }
  });
}

/**
 * íŠ¹ì • ì‹œíŠ¸ì—ì„œ ì „í™”ë²ˆí˜¸ Set ì¶”ì¶œ
 */
function getPhones(ss, sheetName) {
  const sh = ss.getSheetByName(sheetName);
  if (!sh) return new Set();

  const values = sh.getDataRange().getValues();
  const phones = new Set();

  // 1í–‰ì€ í—¤ë”
  for (let i = 1; i < values.length; i++) {
    const phone = values[i][2];
    if (phone) phones.add(phone);
  }
  return phones;
}


======================================================= -->
