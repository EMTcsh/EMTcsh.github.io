<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸš¨ ë¬´ë“±ì‚° íŠ¹ìˆ˜êµ¬ì¡°íŒ€ ì‹¤ì‹œê°„ ì‚°ì•…ì‚¬ê³  ì‹ ê³ ê³µìœ </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#111;color:#fff;}
header{background:#b71c1c;padding:15px;text-align:center;font-size:20px;}
.container{padding:15px;}
.card{background:#1e1e1e;padding:12px;margin-bottom:10px;border-radius:6px;}
.card.done{background:#2b2b2b;opacity:0.6;}
.time{color:#ffcc00;font-size:14px;}
.coord{font-size:12px;color:#aaa;}
.maplink{color:#4fc3f7;font-size:13px;text-decoration:none;}
.maplink:hover{text-decoration:underline;}
.complete-btn{
  background:#2e7d32;
  margin-top:8px;
  color:#fff;
  border:none;
  padding:6px 10px;
  border-radius:4px;
  cursor:pointer;
}
.complete-btn:hover{opacity:0.8;}
</style>
</head>
<body>

<header>ğŸš¨ ë¬´ë“±ì‚° íŠ¹ìˆ˜êµ¬ì¡°íŒ€ ì‹¤ì‹œê°„ ì‚°ì•…ì‚¬ê³  ì‹ ê³ ê³µìœ </header>

<div class="container" style="display: flex; justify-content: flex-end;">
  <div>
    <button onclick="window.open('https://mudeung.github.io/rescue/ems.html', '_blank', 'noopener')">
      ë¬´ë“±ì‚° ì‚°ì•…ì‚¬ê³  ê¸°ë¡ì§€ ë°”ë¡œê°€ê¸°
    </button>
  </div>
</div> 
  
<div class="container">
  <div id="listArea">ë¡œë”©ì¤‘...</div>
</div> 
  
<script>
const API_URL="https://script.google.com/macros/s/AKfycbybwt7-vC5W8NUmve94LLsdlIRFHoiw3wcIrWk9GZFRHnmZJ_0TEsihhz7oX8al_BYR_A/exec";
const listArea=document.getElementById("listArea");

/******** ğŸš‘ í˜„ì¥ë„ì°© ********/
async function completeCase(id){
  if(!confirm("êµ¬ì¡°ëŒ€ì›ì´ í˜„ì¥ì— ë„ì°©í–ˆìŠµë‹ˆê¹Œ?")) return;
  try{
    await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body:JSON.stringify({
        action:"complete",
        id:id,
        completeTime:new Date().toISOString()
      })
    });
    loadData();
  }catch(err){
    alert("ì²˜ë¦¬ ì‹¤íŒ¨");
    console.error(err);
  }
}

/******** âœ… ì‚¬ê³ ì²˜ë¦¬ ì™„ë£Œ ********/
async function finishCase(id){
  if(!confirm("ì‚¬ê³ ì²˜ë¦¬ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  try{
    await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body:JSON.stringify({
        action:"finish",
        id:id,
        finishTime:new Date().toISOString()
      })
    });
    loadData();
  }catch(err){
    alert("ì²˜ë¦¬ ì‹¤íŒ¨");
    console.error(err);
  }
}

/******** ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ********/
async function loadData(){
  const res=await fetch(API_URL);
  const data=await res.json();
  listArea.innerHTML="";
  if(!data.length){
    listArea.innerHTML="í˜„ì¬ ì ‘ìˆ˜ëœ ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  data.sort((a,b)=>new Date(b.time)-new Date(a.time));

  data.forEach(item=>{
    const div=document.createElement("div");

    // ì‚¬ê³ ì²˜ë¦¬ ì™„ë£Œë§Œ íë¦¼ ì²˜ë¦¬
    div.className="card"+(item.status==="ì‚¬ê³ ì²˜ë¦¬ì™„ë£Œ"?" done":"");

    div.innerHTML=`
      <div class="time">ğŸ•’ ì ‘ìˆ˜: ${new Date(item.time).toLocaleString()}</div>

      ${item.status==="í˜„ì¥ë„ì°©"?
        `<div class="time">ğŸš‘ í˜„ì¥ë„ì°©: ${item.completeTime ? new Date(item.completeTime).toLocaleString() : ""}</div>`
        : ""}

      ${item.status==="ì‚¬ê³ ì²˜ë¦¬ì™„ë£Œ"?
        `<div class="time">ğŸš‘ í˜„ì¥ë„ì°©: ${item.completeTime ? new Date(item.completeTime).toLocaleString() : ""}</div>
         <div class="time">âœ… ì‚¬ê³ ì²˜ë¦¬ ì™„ë£Œ: ${item.finishTime ? new Date(item.finishTime).toLocaleString() : ""}</div>`
        : ""}

      ğŸ  ${item.address||"ì£¼ì†Œì—†ìŒ"}<br>
      ğŸ“ ${item.phone||"ë²ˆí˜¸ì—†ìŒ"}<br>
      ğŸ“ ${item.symptom||"ë‚´ìš©ì—†ìŒ"}<br>
      <div class="coord">ìœ„ë„: ${item.lat} / ê²½ë„: ${item.lng}</div>
      <a class="maplink" href="https://map.kakao.com/link/map/êµ¬ì¡°ìš”ì²­ ìœ„ì¹˜,${item.lat},${item.lng}" target="_blank">ğŸ“ ì§€ë„ë³´ê¸°</a><br>

      ${
        item.status==="ì‚¬ê³ ì²˜ë¦¬ì™„ë£Œ"
        ? ""
        : item.status==="í˜„ì¥ë„ì°©"
          ? `<button class="complete-btn" onclick="finishCase('${item.id}')">âœ… ì‚¬ê³ ì²˜ë¦¬ ì™„ë£Œ</button>`
          : `<button class="complete-btn" onclick="completeCase('${item.id}')">ğŸš‘ êµ¬ì¡°ëŒ€ì› í˜„ì¥ë„ì°©</button>`
      }
    `;

    listArea.appendChild(div);
  });
}

loadData();
setInterval(loadData,10000);
</script>

</body>
</html>
