<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>📌 국립공원 특수구조대 현장대응 구급처치 세분화 버전 (교육/시뮬레이션용)</title>
<style>
  :root{
    --bg:#0b1020; --card:#121933; --muted:#8ea0c6; --fg:#e8eeff;
    --ktas1:#ff3b30; --ktas2:#ff9500; --ktas3:#ffcc00; --ktas4:#34c759; --ktas5:#30b0ff;
    --accent:#7aa2ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1020 100%);color:var(--fg);font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif;line-height:1.35}
  header{position:sticky;top:0;background:rgba(10,15,30,.7);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:8px 0 4px;font-size:22px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:10px}
  .grid{display:grid;gap:14px}
  @media (min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
  section{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
  section h2{margin:0 0 10px;font-size:15px;color:#bfd0ff;font-weight:700}
  label{display:block;font-size:13px;color:#cbd8ff;margin:8px 0 6px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0d1530;color:var(--fg);font-size:14px}
  input[type="number"]{appearance:textfield}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer;user-select:none}
  .chip input{display:none}
  .chip.active{background:#16224a;border-color:#3b5bd6}
  .btns{display:flex;gap:10px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#152150;color:var(--fg);cursor:pointer;font-weight:600}
  button.primary{background:var(--accent);color:#0a0f1e;border:none}
  button.warn{background:#26314f;border-color:#ff7a7a;color:#ffdede}
  .result{display:flex;flex-direction:column;gap:10px}
  .badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 12px;font-weight:800}
  .k1{background:var(--ktas1)}.k2{background:var(--ktas2)}.k3{background:var(--ktas3);color:#2a2100}
  .k4{background:var(--ktas4);color:#001a05}.k5{background:var(--ktas5);color:#00131d}
  .muted{color:var(--muted);font-size:13px}
  ul{margin:0 0 0 18px}
  .footer{color:#9fb2e6;font-size:12px;margin-top:10px}
  .timebox{display:flex;gap:8px;flex-wrap:wrap}
  .pill{border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:12px}
  .danger{color:#ff9fa3}
  .ok{color:#aaf0c9}
  .flex{display:flex;gap:12px;flex-wrap:wrap}
  .hint{font-size:12px;color:#9fb2e6}
</style>
</head>
<body>
<div class="wrap">
  <header>
  <div class="wrap">
    <h1>📌 국립공원 특수구조대 구급처치 세분화 버전 <span class="hint">(교육/시뮬레이션용)</span></h1>
    <div class="sub">PedKTAS(소아) 보정, 증상군별 1·2차 트리거, 활력징후 임계값을 더 세분화하여 적용합니다. (실제 진료 전 기관 매뉴얼 확인 필수)</div>
  </div>
</header>

  <main class="grid">
    <!-- 입력 영역 -->
    <section>
      <h2>1. 환자 정보 / 도착</h2>
      <div class="row">
        <div class="col">
          <label>이름</label><input id="ptName" placeholder="">
        </div>
        <div class="col">
          <label>성별</label>
          <select id="ptSex"><option>선택</option><option>남</option><option>여</option><option>기타/미상</option></select>
        </div>
        <div class="col">
  <label>신고접수 시간</label>
  <input id="arrTime" type="datetime-local">
</div>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col"><label>나이(년)</label><input id="ptAge" type="number" min="0" placeholder=""></div>
        <div class="col"><label>체중(kg)</label><input id="ptWt" type="number" step="0.1" placeholder=""></div>
        <div class="col"><label>현장도착 시간</label><input id="arrTime" type="time"></div>
        <div class="col"><label>응급처치 시작</label><input id="arrTime" type="time"></div>
        <div class="col"><label>응급처치 완료</label><input id="arrTime" type="time"></div>
        <div class="col"><label>이송완료 시간</label><input id="arrTime" type="datetime-local"></div>
      </div>

      <h2 style="margin-top:12px">2. 활력징후 / 의식</h2>
      <div class="row">
        <div class="col"><label>호흡수 (RR / rpm)</label><input id="rr" type="number" placeholder=""></div>
        <div class="col"><label>산소포화도 SpO₂ (%)</label><input id="spo2" type="number" min="0" max="100" placeholder=""></div>
        <div class="col"><label>심박수 HR (/min)</label><input id="hr" type="number" placeholder=""></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><label>수축기혈압 SBP (mmHg)</label><input id="sbp" type="number" placeholder=""></div>
        <div class="col"><label>체온 (℃)</label><input id="temp" type="number" step="0.1" placeholder=""></div>
        <div class="col"><label>AVPU</label>
          <select id="avpu"><option value="선택">선택</option><option value="A">A</option><option value="V">V</option><option value="P">P</option><option value="U">U</option></select>
        </div>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col"><label>GCS 합계</label><input id="gcs" type="number" min="3" max="15" placeholder=""></div>
        <div class="col"><label>통증 NRS (0-10)</label><input id="pain" type="number" min="0" max="10" placeholder=""></div>
        <div class="col"><label>호흡지원(산소, 기도치료 등)</label>
          <select id="oxygen"><option value="">없음</option><option value="nasal">비강캐뉼라/산소</option><option value="nonrebreather">NRB</option><option value="intub">기도삽관/인공호흡</option></select>
        </div>
      </div>

      <h2 style="margin-top:12px">3. 주요 증상군 (세분화)</h2>
      <label>증상군 선택 (주증상)</label>
      <select id="cc">
        <option value="respiratory">선택</option>
        <option value="respiratory">호흡곤란 / 저산소</option>
        <option value="chest">흉통 / 심계</option>
        <option value="neuro">신경학적 증상 (급성 편마비/언어장애/혼동)</option>
        <option value="gi">복통 / 구토 / 위장출혈</option>
        <option value="trauma_head">외상 - 머리(의식변화/두부손상)</option>
        <option value="trauma_thorax">외상 - 흉복부/골반 (내장손상 의심)</option>
        <option value="trauma_extrem">외상 - 사지/연부조직</option>
        <option value="sepsis">패혈증 의심(감염+저혈압/빈호흡 등)</option>
        <option value="burn">화상</option>
        <option value="poison">중독/약물</option>
        <option value="obstetrics">산부인과(임신/출혈)</option>
        <option value="psy">정신과(자해위험/급성정신병)</option>
        <option value="fever_ped">소아 발열</option>
        <option value="other">기타</option>
      </select>

      <label style="margin-top:8px">증상 상세 (메모)</label>
      <input id="ccNote" placeholder="증상 경과, 발병시간, 외상 기전 등">

      <h2 style="margin-top:12px">4. 수정지표 보조 항목 (해당 시 선택)</h2>
      <div class="chips" id="modifiers">
        <button type="button" class="chip" data-val="cardiac_arrest">무호흡/심정지</button>
        <button type="button" class="chip" data-val="severe_resp">심한 호흡곤란(호흡곤란+청색증/기침불가)</button>
        <button type="button" class="chip" data-val="massive_bleed">활동성 대량출혈</button>
        <button type="button" class="chip" data-val="highenergy">고에너지 외상(추락>5m/고속충돌 등)</button>
        <button type="button" class="chip" data-val="neuro_deficit">급성 신경학적 결손(편마비/언어장애)</button>
        <button type="button" class="chip" data-val="chest_isch">흉통: 좌측방사통/심전도변화/허혈의심</button>
        <button type="button" class="chip" data-val="sepsis_suspect">감염 의심 + 저혈압/빈호흡</button>
        <button type="button" class="chip" data-val="pregnancy">임신/분만관련</button>
        <button type="button" class="chip" data-val="ped_lt3m">소아: 3개월 미만 발열</button>
        <button type="button" class="chip" data-val="immuno">면역저하(화학요법 등)</button>
        <button type="button" class="chip" data-val="selfharm_risk">자해 또는 타해 위험</button>
      </div>

      <h2 style="margin-top:12px">5. 출혈/기전/탈수 선택</h2>
      <div class="row">
        <div class="col"><label>출혈</label>
          <select id="bleed"><option value="">선택</option><option value="massive">활동성(대량)</option><option value="moderate">중등도</option><option value="minor">경미</option></select>
        </div>
        <div class="col"><label>손상기전</label>
          <select id="mech"><option value="">선택</option><option value="high">고에너지</option><option value="mid">중간</option><option value="low">저에너지</option></select>
        </div>
        <div class="col"><label>탈수/순환</label>
          <select id="dehyd"><option value="">선택</option><option value="severe">중증(창백/냉감/CRT지연)</option><option value="moderate">중등도</option><option value="mild">경미</option></select>
        </div>
      </div>

    </section>

    <!-- 결과/사유 영역 -->
    <section>
      <h2>결과</h2>
      <div style="margin-bottom:8px">
        <div id="badge" class="badge k5">환자상태 5 (비응급)</div>
      </div>
      <div class="small">목표 진료 시간: <span id="target">≤ 120분</span></div>
      <div style="margin-top:8px">
        <div class="small">선택된 수정지표:</div>
        <div id="selectedMods" class="muted">-</div>
      </div>
      <div style="margin-top:10px">
        <div class="small">근거(트리거):</div>
        <ul id="rationale"></ul>
      </div>
      <div style="margin-top:10px" class="btn-row">
        <button class="primary" id="calcBtn">중증도 산출</button>
        <button id="resetBtn">초기화</button>
        <button id="saveBtn">JSON 저장</button>
        <button id="printBtn">인쇄하기</button>
      </div>

      <div style="margin-top:12px" class="note">
        주의: 이 도구는 교육/시뮬레이션용입니다. 실제 임상에서 적용하기 전 기관별 환자상태 매뉴얼을 반드시 확인하십시오.
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">
         
 <div class="centered">
  <label>
    <input type="checkbox" id="autoSaveToggle" checked />
    작성내용 표시 
  </label>

        
</div>
  <div id="writtenDataBox" style="margin-top:10px;font-size:13px;color:#9fb2e6;white-space:pre-wrap;background:#0d1530;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08)">
    아직 저장된 데이터가 없습니다.
  </div>
        <div style="margin-top:10px; display:flex; gap:8px;">
  <button id="copyResultBtn" style="padding:6px 12px;">내용 복사</button>
  <button id="generateLinkBtn" style="padding:6px 12px;">공유 링크 생성</button>
  <input id="shareLinkOutput" type="text" readonly style="flex:1; padding:6px; font-size:13px;" placeholder="공유 링크가 여기에 생성됩니다" />
</div>
</div>
    </section>
  </main>
</div>

<script>
  // 현재 시간으로 기본값 설정하는 함수
  function setNow(id, type="datetime") {
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000; // 타임존 보정
    if (type === "datetime") {
      document.getElementById(id).value =
        new Date(now - offset).toISOString().slice(0, 16);
    } else if (type === "time") {
      document.getElementById(id).value =
        new Date(now - offset).toISOString().slice(11, 16);
    }
  }

  // 최초 로딩 시 자동 입력
  setNow("reportTime", "datetime");
  setNow("arrivalTime", "time");
  setNow("treatmentStart", "time");
  setNow("treatmentEnd", "time");
  setNow("transferDone", "datetime");
</script>
  
  // --- 유틸 / 초기값 ---
  const $ = q=>document.querySelector(q);
  const $$ = q=>Array.from(document.querySelectorAll(q));
  $("#arrTime").value = new Date().toISOString().slice(0,16);

  // 칩 토글
  $$("#modifiers .chip").forEach(c=>{
    c.addEventListener("click", ()=>{ c.classList.toggle("active"); renderSelectedMods(); });
  });
  function selectedModifiers(){ return $$("#modifiers .chip.active").map(c=>c.dataset.val); }
  function renderSelectedMods(){ const s = selectedModifiers(); $("#selectedMods").textContent = s.length? s.join(", ") : "-"; }

  // 소아 정상범위(참고용, 연령 구간별 단순화)
  // 이 값들은 PedKTAS/CTAS 계열의 권고를 참고하여 교육용으로 단순화한 범위입니다.
  const pediatrics = [
    {maxAgeMonths:3, hr:[90,205], rr:[30,60]},   // 0-3 months (대략)
    {maxAgeMonths:12, hr:[80,180], rr:[25,50]},  // 3-12 months
    {maxAgeMonths:36, hr:[70,160], rr:[20,40]},  // 1-3 years
    {maxAgeMonths:72, hr:[60,140], rr:[20,30]},  // 3-6 years
    {maxAgeMonths:144, hr:[50,120], rr:[16,25]}, // 6-12 years
  ];
  function getPediatricRanges(ageYears){
    if (ageYears===null || ageYears===undefined) return null;
    const months = ageYears*12;
    for (let r of pediatrics) if (months <= r.maxAgeMonths) return r;
    return {hr:[50,110], rr:[12,20]}; // 12세 이상은 성인 기준 유사
  }

  // --- 핵심 중증도 계산(세분화 로직) ---
  function computeKTAS(){
    const reasons = [];
    let level = 5; // 1이 가장 중증

    const age = Number($("#ptAge").value) || 0;
    const rr = Number($("#rr").value) || null;
    const spo2 = Number($("#spo2").value) || null;
    const hr = Number($("#hr").value) || null;
    const sbp = Number($("#sbp").value) || null;
    const temp = Number($("#temp").value) || null;
    const avpu = $("#avpu").value;
    const gcs = Number($("#gcs").value) || null;
    const pain = Number($("#pain").value) || 0;
    const cc = $("#cc").value;
    const mods = selectedModifiers();
    const bleed = $("#bleed").value;
    const mech = $("#mech").value;
    const dehyd = $("#dehyd").value;

    // 즉시치료/심정지
    if (mods.includes("cardiac_arrest")){
      reasons.push("[Critical] 무호흡/심정지 감지 — 환자상태 1");
      return {level:1, reasons};
    }
    if (avpu==="U" || gcs<=8){
      reasons.push("[Critical] 의식 소실(GCS ≤ 8 / AVPU=U) — 환자상태 1");
      return {level:1, reasons};
    }

    // 중증 호흡곤란 / 산소화 저하
    if (mods.includes("severe_resp") || $("#oxygen").value==="intub"){
      level = Math.min(level,1);
      reasons.push("[Critical] 심한 호흡곤란 또는 기도삽관/인공호흡 필요 — 환자상태 1");
      return {level:1, reasons};
    }
    if (spo2 !== null && spo2 < 85){
      level = Math.min(level,1);
      reasons.push("[Critical] SpO₂ < 85% — 즉시 개입(호흡/기도) 고려 — 환자상태 1");
    } else if (spo2 !== null && spo2 < 90){
      level = Math.min(level,2);
      reasons.push("[High] SpO₂ < 90% — 고위험(산소치료 필요) — 환자상태 2");
    } else if (spo2 !== null && spo2 <= 92){
      level = Math.min(level,3);
      reasons.push("[Moderate] SpO₂ 90–92% — 산소보조/재평가 — 환자상태 3");
    }

    // 호흡수 — 성인/소아 구분
    if (age < 15){ // 소아 (PedKTAS 반영)
      const ranges = getPediatricRanges(age);
      if (ranges){
        if (rr && rr > ranges.rr[1]*1.3){ level = Math.min(level,2); reasons.push("[High] 소아 RR 현저한 상승 → 중증 가능성"); }
        else if (rr && rr > ranges.rr[1]){ level = Math.min(level,3); reasons.push("[Moderate] 소아 RR 상승"); }
        else if (rr && rr < ranges.rr[0]){ level = Math.min(level,3); reasons.push("[Moderate] 소아 저호흡"); }
      }
    } else { // 성인
      if (rr && (rr>30 || rr<8)){ level = Math.min(level,2); reasons.push("[High] RR >30 또는 <8"); }
      else if (rr && (rr>=24)){ level = Math.min(level,3); reasons.push("[Moderate] RR 24–30"); }
    }

    // 순환/혈압
    if (sbp && sbp < 70){
      level = Math.min(level,1); reasons.push("[Critical] SBP < 70 mmHg — 즉시 소생술/쇼크관리"); 
    } else if (sbp && sbp < 90){
      level = Math.min(level,2); reasons.push("[High] SBP < 90 mmHg — 쇼크 의심"); 
    } else if (sbp && sbp <= 100){
      level = Math.min(level,3); reasons.push("[Moderate] SBP 90–100 mmHg"); 
    }

    // 심박수 (성인/소아)
    if (age < 15){
      const ranges = getPediatricRanges(age);
      if (hr && hr > ranges.hr[1]*1.2){ level = Math.min(level,2); reasons.push("[High] 소아 HR 현저한 상승"); }
      else if (hr && hr > ranges.hr[1]){ level = Math.min(level,3); reasons.push("[Moderate] 소아 HR 상승"); }
      else if (hr && hr < ranges.hr[0]){ level = Math.min(level,3); reasons.push("[Moderate] 소아 서맥"); }
    } else {
      if (hr && hr >= 130){ level = Math.min(level,2); reasons.push("[High] HR ≥ 130"); }
      else if (hr && hr >= 110){ level = Math.min(level,3); reasons.push("[Moderate] HR 110–129"); }
    }

    // 신경학적 증상
    if (mods.includes("neuro_deficit") || cc==="neuro"){
      level = Math.min(level,2);
      reasons.push("[High] 급성 신경학적 결손(편마비/언어장애/의식변화) — 뇌졸중·출혈 의심");
    }
    if (cc==="trauma_head" && (mods.includes("cardiac_arrest") || mech==="high" || gcs<=13)){
      level = Math.min(level,2); reasons.push("[High] 두부손상 + 의식저하/고에너지 → CT/수술 가능성");
    }

    // 흉통 — 심근허혈/ACS 관련 트리거
    if (mods.includes("chest_isch") || cc==="chest"){
      // 심전도/허혈 의심(교육용: 흉통 + 왼쪽 팔 방사통/식은땀/호흡곤란/불안감 등)
      level = Math.min(level,2);
      reasons.push("[High] 흉통: 심근허혈/급성관상동맥증후군 의심 → 빠른 평가(ECG, 트로포닌) 권고");
    }

    // 출혈/대량출혈
    if (bleed === "massive" || mods.includes("massive_bleed")){
      level = Math.min(level,1); reasons.push("[Critical] 활동성 대량출혈 — 즉시 지혈/수혈 준비"); 
    } else if (bleed === "moderate") {
      level = Math.min(level,2); reasons.push("[High] 중등도 출혈"); 
    }

    // 고에너지 외상
    if (mech === "high" || mods.includes("highenergy")){
      level = Math.min(level,2); reasons.push("[High] 고에너지 외상 — 다발손상·내부손상 의심");
    }

    // 패혈증 의심
    if (cc==="sepsis" || mods.includes("sepsis_suspect")){
      if (sbp && sbp < 90) { level = Math.min(level,2); reasons.push("[High] 감염 + 저혈압(Sepsis/Septic shock 의심)"); }
      else if (rr && rr>22){ level = Math.min(level,2); reasons.push("[High] 감염 + 빈호흡(Sepsis 의심)"); }
      else { level = Math.min(level,3); reasons.push("[Moderate] 감염 의심(Sepsis 규칙 적용 필요)"); }
    }

    // 산부인과/임신
    if (mods.includes("pregnancy") || cc==="obstetrics"){
      // 임신 관련 출혈·통증·분만징후는 최소 환자상태 2-3으로 고려
      level = Math.min(level,3);
      reasons.push("[Moderate] 임신/산과 관련 환자 — 분만/자궁출혈 등 특수관리 필요");
    }

    // 소아 발열 보정 (3개월 미만은 higher)
    if (mods.includes("ped_lt3m") || cc==="fever_ped"){
      if (mods.includes("ped_lt3m") || age>0 && age < 0.25){
        level = Math.min(level,2);
        reasons.push("[High] 소아 3개월 미만 발열(≥38℃) — 소아중환자나 입원 고려");
      } else {
        // 소아 발열(>=3개월) : 증상/평소상태에 따라 3~4
        level = Math.min(level,3);
        reasons.push("[Moderate] 소아 발열(3개월 이상) — 증상기반 재평가 필요");
      }
    }

    // 통증 보정 (성인)
    if (age >= 15){
      if (pain >= 8){ level = Math.min(level,2); reasons.push("[High] 통증 NRS 8–10"); }
      else if (pain >= 4){ level = Math.min(level,3); reasons.push("[Moderate] 통증 NRS 4–7"); }
      else if (pain >= 1){ level = Math.min(level,4); reasons.push("[Low] 통증 NRS 1–3"); }
    }

    // 탈수/순환 보정
    if (dehyd === "severe"){ level = Math.min(level,2); reasons.push("[High] 중증 탈수/순환부전"); }
    else if (dehyd === "moderate"){ level = Math.min(level,3); reasons.push("[Moderate] 중등도 탈수"); }

    // 정신과 자해위험
    if (mods.includes("selfharm_risk") || cc==="psy"){
      level = Math.min(level,2);
      reasons.push("[High] 자해/타해 위험 — 안전조치 필요");
    }

    // 기본 증상군 최소값 (교육용 권장)
    const ccMin = {
      "respiratory":2, "chest":2, "neuro":2, "sepsis":2,
      "trauma_thorax":2, "trauma_head":3, "burn":3,
      "poison":3, "obstetrics":3, "fever_ped":3, "gi":4, "trauma_extrem":4, "psy":3, "other":5
    };
    if (ccMin[cc]) {
      level = Math.min(level, ccMin[cc]);
      reasons.push("[Info] 증상군 권장 최소중증도: " + cc + " → 환자상태 ≥ " + ccMin[cc]);
    }

    // 최종 보정(예: 환자상태 1 우선)
    if (level <= 1) level = 1;
    if (level > 5) level = 5;

    return {level, reasons};
  }

  // --- 렌더링 ---
  function setBadge(level){
    const badge = $("#badge");
    badge.className = "badge k"+level;
    const labels = {1:"환자상태 1 (즉시)",2:"환자상태 2 (응급, ≤15분)",3:"환자상태 3 (준응급, ≤30분)",4:"환자상태 4 (≤60분)",5:"환자상태 5 (비응급, ≤120분)"};
    badge.textContent = labels[level];
    $("#target").textContent = ({1:"즉시",2:"≤ 15분",3:"≤ 30분",4:"≤ 60분",5:"≤ 120분"})[level];
  }

  function render(){
    const res = computeKTAS();
    setBadge(res.level);
    const ul = $("#rationale");
    ul.innerHTML = "";
    if (res.reasons.length === 0) {
      const li = document.createElement("li"); li.textContent = "특이 트리거 없음 → 기본 환자상태 5 유지"; ul.appendChild(li);
    } else {
      res.reasons.forEach(r=>{
        const li = document.createElement("li"); li.textContent = r; ul.appendChild(li);
      });
    }
  }

  // 버튼 이벤트
  $("#calcBtn").addEventListener("click", ()=>{ render(); });
  $("#resetBtn").addEventListener("click", ()=>{
    document.querySelectorAll("input,select,textarea").forEach(el=>{
      if (el.type === "datetime-local") el.value = new Date().toISOString().slice(0,16);
      else el.value = "";
    });
    $$("#modifiers .chip").forEach(c=>c.classList.remove("active"));
    $("#selectedMods").textContent = "-";
    setBadge(5);
    $("#rationale").innerHTML = "";
  });

  // JSON 저장
  $("#saveBtn").addEventListener("click", ()=>{
    const data = {
      patient:{name:$("#ptName").value, age:$("#ptAge").value, sex:$("#ptSex").value, weight:$("#ptWt").value},
      arrival:{time:$("#arrTime").value},
      vitals:{rr:$("#rr").value, spo2:$("#spo2").value, hr:$("#hr").value, sbp:$("#sbp").value, temp:$("#temp").value, avpu:$("#avpu").value, gcs:$("#gcs").value, pain:$("#pain").value},
      complaint:{cc:$("#cc").value, note:$("#ccNote").value},
      modifiers:selectedModifiers(),
      bleed:$("#bleed").value, mech:$("#mech").value, dehyd:$("#dehyd").value,
      result: computeKTAS()
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
    a.download = `환자상태_detail_${new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // 초기 세팅
  setBadge(5);
  
  // 작성내용 표시 및 저장
function saveWrittenDataIfEnabled() {
  const autoSave = $("#autoSaveToggle").checked;
  if (!autoSave) {
    alert("자동 저장이 비활성화되어 있습니다.\n체크박스를 선택하면 저장됩니다.");
    return;
  }

  const data = {
    이름: $("#ptName").value,
    성별: $("#ptSex").value,
    나이: $("#ptAge").value,
    체중: $("#ptWt").value,
    활력징후: {
      RR: $("#rr").value,
      SpO2: $("#spo2").value,
      HR: $("#hr").value,
      SBP: $("#sbp").value,
      체온: $("#temp").value,
      AVPU: $("#avpu").value,
      GCS: $("#gcs").value,
      통증: $("#pain").value
    },
    주증상: $("#cc").value,
    상세증상: $("#ccNote").value,
    수정지표: selectedModifiers().join(", "),
    중증도: computeKTAS().level
  };

  // 표시용 텍스트 구성
  const displayText = Object.entries(data).map(([k, v]) => {
    if (typeof v === 'object') {
      return `${k}:\n  ` + Object.entries(v).map(([subK, subV]) => `${subK}: ${subV}`).join('\n  ');
    } else {
      return `${k}: ${v}`;
    }
  }).join('\n');

  $("#writtenDataBox").textContent = displayText;
}

// 중증도 계산 버튼에 이벤트 추가 (기존 코드 유지하면서 이 부분만 추가)
$("#calcBtn").addEventListener("click", () => {
  render();
  saveWrittenDataIfEnabled(); // ← 자동 저장 체크 여부 확인 후 작성 내용 표시
});
  
  // 📋 내용 복사
$("#copyResultBtn").addEventListener("click", () => {
  const text = $("#writtenDataBox").textContent;
  if (!text.trim()) return alert("복사할 내용이 없습니다.");
  navigator.clipboard.writeText(text).then(() => {
    alert("작성 내용이 클립보드에 복사되었습니다.");
  });
});

// 🔗 공유 링크 생성 (내용을 압축해서 URL에 포함)
$("#generateLinkBtn").addEventListener("click", () => {
  const text = $("#writtenDataBox").textContent;
  if (!text.trim()) return alert("공유할 내용이 없습니다.");

  // base64 encode (간단하게)
  const encoded = btoa(unescape(encodeURIComponent(text)));
  const baseUrl = location.origin + location.pathname;
  const shareUrl = `${baseUrl}?share=${encoded}`;
  $("#shareLinkOutput").value = shareUrl;
  $("#shareLinkOutput").select();
});

// 페이지에 공유 링크로 접근한 경우, 내용 자동 복원
window.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(location.search);
  if (params.has("share")) {
    try {
      const decoded = decodeURIComponent(escape(atob(params.get("share"))));
      $("#writtenDataBox").textContent = decoded;
      $("#autoSaveToggle").checked = true; // 자동저장 ON으로 표시
    } catch (e) {
      console.error("공유 링크 복원 실패", e);
    }
  }
});
</script>
  
   <script>
    const printBtn = document.getElementById('printBtn');
    printBtn.addEventListener('click', () => {
      window.print();
    });
  </script>
  
</body>
</html>

</body>
</html>
