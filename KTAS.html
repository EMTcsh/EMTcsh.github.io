<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“Œ êµ­ë¦½ê³µì› íŠ¹ìˆ˜êµ¬ì¡°ëŒ€ í˜„ì¥ëŒ€ì‘ êµ¬ê¸‰ì²˜ì¹˜ ì„¸ë¶„í™” ë²„ì „ (êµìœ¡/ì‹œë®¬ë ˆì´ì…˜ìš©)</title>
<style>
  :root{
    --bg:#0b1020; --card:#121933; --muted:#8ea0c6; --fg:#e8eeff;
    --ktas1:#ff3b30; --ktas2:#ff9500; --ktas3:#ffcc00; --ktas4:#34c759; --ktas5:#30b0ff;
    --accent:#7aa2ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1020 100%);color:var(--fg);font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif;line-height:1.35}
  header{position:sticky;top:0;background:rgba(10,15,30,.7);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{margin:8px 0 4px;font-size:22px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:10px}
  .grid{display:grid;gap:14px}
  @media (min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
  section{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
  section h2{margin:0 0 10px;font-size:15px;color:#bfd0ff;font-weight:700}
  label{display:block;font-size:13px;color:#cbd8ff;margin:8px 0 6px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0d1530;color:var(--fg);font-size:14px}
  input[type="number"]{appearance:textfield}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer;user-select:none}
  .chip input{display:none}
  .chip.active{background:#16224a;border-color:#3b5bd6}
  .btns{display:flex;gap:10px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#152150;color:var(--fg);cursor:pointer;font-weight:600}
  button.primary{background:var(--accent);color:#0a0f1e;border:none}
  button.warn{background:#26314f;border-color:#ff7a7a;color:#ffdede}
  .result{display:flex;flex-direction:column;gap:10px}
  .badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 12px;font-weight:800}
  .k1{background:var(--ktas1)}.k2{background:var(--ktas2)}.k3{background:var(--ktas3);color:#2a2100}
  .k4{background:var(--ktas4);color:#001a05}.k5{background:var(--ktas5);color:#00131d}
  .muted{color:var(--muted);font-size:13px}
  ul{margin:0 0 0 18px}
  .footer{color:#9fb2e6;font-size:12px;margin-top:10px}
  .timebox{display:flex;gap:8px;flex-wrap:wrap}
  .pill{border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:12px}
  .danger{color:#ff9fa3}
  .ok{color:#aaf0c9}
  .flex{display:flex;gap:12px;flex-wrap:wrap}
  .hint{font-size:12px;color:#9fb2e6}
</style>
</head>
<body>
<div class="wrap">
  <header>
  <div class="wrap">
    <h1>ğŸ“Œ êµ­ë¦½ê³µì› íŠ¹ìˆ˜êµ¬ì¡°ëŒ€ êµ¬ê¸‰ì²˜ì¹˜ ì„¸ë¶„í™” ë²„ì „ <span class="hint">(êµìœ¡/ì‹œë®¬ë ˆì´ì…˜ìš©)</span></h1>
    <div class="sub">PedKTAS(ì†Œì•„) ë³´ì •, ì¦ìƒêµ°ë³„ 1Â·2ì°¨ íŠ¸ë¦¬ê±°, í™œë ¥ì§•í›„ ì„ê³„ê°’ì„ ë” ì„¸ë¶„í™”í•˜ì—¬ ì ìš©í•©ë‹ˆë‹¤. (ì‹¤ì œ ì§„ë£Œ ì „ ê¸°ê´€ ë§¤ë‰´ì–¼ í™•ì¸ í•„ìˆ˜)</div>
  </div>
</header>

  <main class="grid">
    <!-- ì…ë ¥ ì˜ì—­ -->
    <section>
      <h2>1. í™˜ì ì •ë³´ / ë„ì°©</h2>
      <div class="row">
        <div class="col">
          <label>ì´ë¦„</label><input id="ptName" placeholder="">
        </div>
        <div class="col">
          <label>ì„±ë³„</label>
          <select id="ptSex"><option>ì„ íƒ</option><option>ë‚¨</option><option>ì—¬</option><option>ê¸°íƒ€/ë¯¸ìƒ</option></select>
        </div>
        <div class="col">
  <label>ì‹ ê³ ì ‘ìˆ˜ ì‹œê°„</label>
  <input id="arrTime" type="datetime-local">
</div>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col"><label>ë‚˜ì´(ë…„)</label><input id="ptAge" type="number" min="0" placeholder=""></div>
        <div class="col"><label>ì²´ì¤‘(kg)</label><input id="ptWt" type="number" step="0.1" placeholder=""></div>
        <div class="col"><label>í˜„ì¥ë„ì°© ì‹œê°„</label><input id="arrTime" type="time"></div>
        <div class="col"><label>ì‘ê¸‰ì²˜ì¹˜ ì‹œì‘</label><input id="arrTime" type="time"></div>
        <div class="col"><label>ì‘ê¸‰ì²˜ì¹˜ ì™„ë£Œ</label><input id="arrTime" type="time"></div>
        <div class="col"><label>ì´ì†¡ì™„ë£Œ ì‹œê°„</label><input id="arrTime" type="datetime-local"></div>
      </div>

      <h2 style="margin-top:12px">2. í™œë ¥ì§•í›„ / ì˜ì‹</h2>
      <div class="row">
        <div class="col"><label>í˜¸í¡ìˆ˜ (RR / rpm)</label><input id="rr" type="number" placeholder=""></div>
        <div class="col"><label>ì‚°ì†Œí¬í™”ë„ SpOâ‚‚ (%)</label><input id="spo2" type="number" min="0" max="100" placeholder=""></div>
        <div class="col"><label>ì‹¬ë°•ìˆ˜ HR (/min)</label><input id="hr" type="number" placeholder=""></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><label>ìˆ˜ì¶•ê¸°í˜ˆì•• SBP (mmHg)</label><input id="sbp" type="number" placeholder=""></div>
        <div class="col"><label>ì²´ì˜¨ (â„ƒ)</label><input id="temp" type="number" step="0.1" placeholder=""></div>
        <div class="col"><label>AVPU</label>
          <select id="avpu"><option value="ì„ íƒ">ì„ íƒ</option><option value="A">A</option><option value="V">V</option><option value="P">P</option><option value="U">U</option></select>
        </div>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col"><label>GCS í•©ê³„</label><input id="gcs" type="number" min="3" max="15" placeholder=""></div>
        <div class="col"><label>í†µì¦ NRS (0-10)</label><input id="pain" type="number" min="0" max="10" placeholder=""></div>
        <div class="col"><label>í˜¸í¡ì§€ì›(ì‚°ì†Œ, ê¸°ë„ì¹˜ë£Œ ë“±)</label>
          <select id="oxygen"><option value="">ì—†ìŒ</option><option value="nasal">ë¹„ê°•ìºë‰¼ë¼/ì‚°ì†Œ</option><option value="nonrebreather">NRB</option><option value="intub">ê¸°ë„ì‚½ê´€/ì¸ê³µí˜¸í¡</option></select>
        </div>
      </div>

      <h2 style="margin-top:12px">3. ì£¼ìš” ì¦ìƒêµ° (ì„¸ë¶„í™”)</h2>
      <label>ì¦ìƒêµ° ì„ íƒ (ì£¼ì¦ìƒ)</label>
      <select id="cc">
        <option value="respiratory">ì„ íƒ</option>
        <option value="respiratory">í˜¸í¡ê³¤ë€ / ì €ì‚°ì†Œ</option>
        <option value="chest">í‰í†µ / ì‹¬ê³„</option>
        <option value="neuro">ì‹ ê²½í•™ì  ì¦ìƒ (ê¸‰ì„± í¸ë§ˆë¹„/ì–¸ì–´ì¥ì• /í˜¼ë™)</option>
        <option value="gi">ë³µí†µ / êµ¬í†  / ìœ„ì¥ì¶œí˜ˆ</option>
        <option value="trauma_head">ì™¸ìƒ - ë¨¸ë¦¬(ì˜ì‹ë³€í™”/ë‘ë¶€ì†ìƒ)</option>
        <option value="trauma_thorax">ì™¸ìƒ - í‰ë³µë¶€/ê³¨ë°˜ (ë‚´ì¥ì†ìƒ ì˜ì‹¬)</option>
        <option value="trauma_extrem">ì™¸ìƒ - ì‚¬ì§€/ì—°ë¶€ì¡°ì§</option>
        <option value="sepsis">íŒ¨í˜ˆì¦ ì˜ì‹¬(ê°ì—¼+ì €í˜ˆì••/ë¹ˆí˜¸í¡ ë“±)</option>
        <option value="burn">í™”ìƒ</option>
        <option value="poison">ì¤‘ë…/ì•½ë¬¼</option>
        <option value="obstetrics">ì‚°ë¶€ì¸ê³¼(ì„ì‹ /ì¶œí˜ˆ)</option>
        <option value="psy">ì •ì‹ ê³¼(ìí•´ìœ„í—˜/ê¸‰ì„±ì •ì‹ ë³‘)</option>
        <option value="fever_ped">ì†Œì•„ ë°œì—´</option>
        <option value="other">ê¸°íƒ€</option>
      </select>

      <label style="margin-top:8px">ì¦ìƒ ìƒì„¸ (ë©”ëª¨)</label>
      <input id="ccNote" placeholder="ì¦ìƒ ê²½ê³¼, ë°œë³‘ì‹œê°„, ì™¸ìƒ ê¸°ì „ ë“±">

      <h2 style="margin-top:12px">4. ìˆ˜ì •ì§€í‘œ ë³´ì¡° í•­ëª© (í•´ë‹¹ ì‹œ ì„ íƒ)</h2>
      <div class="chips" id="modifiers">
        <button type="button" class="chip" data-val="cardiac_arrest">ë¬´í˜¸í¡/ì‹¬ì •ì§€</button>
        <button type="button" class="chip" data-val="severe_resp">ì‹¬í•œ í˜¸í¡ê³¤ë€(í˜¸í¡ê³¤ë€+ì²­ìƒ‰ì¦/ê¸°ì¹¨ë¶ˆê°€)</button>
        <button type="button" class="chip" data-val="massive_bleed">í™œë™ì„± ëŒ€ëŸ‰ì¶œí˜ˆ</button>
        <button type="button" class="chip" data-val="highenergy">ê³ ì—ë„ˆì§€ ì™¸ìƒ(ì¶”ë½>5m/ê³ ì†ì¶©ëŒ ë“±)</button>
        <button type="button" class="chip" data-val="neuro_deficit">ê¸‰ì„± ì‹ ê²½í•™ì  ê²°ì†(í¸ë§ˆë¹„/ì–¸ì–´ì¥ì• )</button>
        <button type="button" class="chip" data-val="chest_isch">í‰í†µ: ì¢Œì¸¡ë°©ì‚¬í†µ/ì‹¬ì „ë„ë³€í™”/í—ˆí˜ˆì˜ì‹¬</button>
        <button type="button" class="chip" data-val="sepsis_suspect">ê°ì—¼ ì˜ì‹¬ + ì €í˜ˆì••/ë¹ˆí˜¸í¡</button>
        <button type="button" class="chip" data-val="pregnancy">ì„ì‹ /ë¶„ë§Œê´€ë ¨</button>
        <button type="button" class="chip" data-val="ped_lt3m">ì†Œì•„: 3ê°œì›” ë¯¸ë§Œ ë°œì—´</button>
        <button type="button" class="chip" data-val="immuno">ë©´ì—­ì €í•˜(í™”í•™ìš”ë²• ë“±)</button>
        <button type="button" class="chip" data-val="selfharm_risk">ìí•´ ë˜ëŠ” íƒ€í•´ ìœ„í—˜</button>
      </div>

      <h2 style="margin-top:12px">5. ì¶œí˜ˆ/ê¸°ì „/íƒˆìˆ˜ ì„ íƒ</h2>
      <div class="row">
        <div class="col"><label>ì¶œí˜ˆ</label>
          <select id="bleed"><option value="">ì„ íƒ</option><option value="massive">í™œë™ì„±(ëŒ€ëŸ‰)</option><option value="moderate">ì¤‘ë“±ë„</option><option value="minor">ê²½ë¯¸</option></select>
        </div>
        <div class="col"><label>ì†ìƒê¸°ì „</label>
          <select id="mech"><option value="">ì„ íƒ</option><option value="high">ê³ ì—ë„ˆì§€</option><option value="mid">ì¤‘ê°„</option><option value="low">ì €ì—ë„ˆì§€</option></select>
        </div>
        <div class="col"><label>íƒˆìˆ˜/ìˆœí™˜</label>
          <select id="dehyd"><option value="">ì„ íƒ</option><option value="severe">ì¤‘ì¦(ì°½ë°±/ëƒ‰ê°/CRTì§€ì—°)</option><option value="moderate">ì¤‘ë“±ë„</option><option value="mild">ê²½ë¯¸</option></select>
        </div>
      </div>

    </section>

    <!-- ê²°ê³¼/ì‚¬ìœ  ì˜ì—­ -->
    <section>
      <h2>ê²°ê³¼</h2>
      <div style="margin-bottom:8px">
        <div id="badge" class="badge k5">í™˜ììƒíƒœ 5 (ë¹„ì‘ê¸‰)</div>
      </div>
      <div class="small">ëª©í‘œ ì§„ë£Œ ì‹œê°„: <span id="target">â‰¤ 120ë¶„</span></div>
      <div style="margin-top:8px">
        <div class="small">ì„ íƒëœ ìˆ˜ì •ì§€í‘œ:</div>
        <div id="selectedMods" class="muted">-</div>
      </div>
      <div style="margin-top:10px">
        <div class="small">ê·¼ê±°(íŠ¸ë¦¬ê±°):</div>
        <ul id="rationale"></ul>
      </div>
      <div style="margin-top:10px" class="btn-row">
        <button class="primary" id="calcBtn">ì¤‘ì¦ë„ ì‚°ì¶œ</button>
        <button id="resetBtn">ì´ˆê¸°í™”</button>
        <button id="saveBtn">JSON ì €ì¥</button>
        <button id="printBtn">ì¸ì‡„í•˜ê¸°</button>
      </div>

      <div style="margin-top:12px" class="note">
        ì£¼ì˜: ì´ ë„êµ¬ëŠ” êµìœ¡/ì‹œë®¬ë ˆì´ì…˜ìš©ì…ë‹ˆë‹¤. ì‹¤ì œ ì„ìƒì—ì„œ ì ìš©í•˜ê¸° ì „ ê¸°ê´€ë³„ í™˜ììƒíƒœ ë§¤ë‰´ì–¼ì„ ë°˜ë“œì‹œ í™•ì¸í•˜ì‹­ì‹œì˜¤.
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">
         
 <div class="centered">
  <label>
    <input type="checkbox" id="autoSaveToggle" checked />
    ì‘ì„±ë‚´ìš© í‘œì‹œ 
  </label>

        
</div>
  <div id="writtenDataBox" style="margin-top:10px;font-size:13px;color:#9fb2e6;white-space:pre-wrap;background:#0d1530;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08)">
    ì•„ì§ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
  </div>
        <div style="margin-top:10px; display:flex; gap:8px;">
  <button id="copyResultBtn" style="padding:6px 12px;">ë‚´ìš© ë³µì‚¬</button>
  <button id="generateLinkBtn" style="padding:6px 12px;">ê³µìœ  ë§í¬ ìƒì„±</button>
  <input id="shareLinkOutput" type="text" readonly style="flex:1; padding:6px; font-size:13px;" placeholder="ê³µìœ  ë§í¬ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤" />
</div>
</div>
    </section>
  </main>
</div>

<script>
  // í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê¸°ë³¸ê°’ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
  function setNow(id, type="datetime") {
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000; // íƒ€ì„ì¡´ ë³´ì •
    if (type === "datetime") {
      document.getElementById(id).value =
        new Date(now - offset).toISOString().slice(0, 16);
    } else if (type === "time") {
      document.getElementById(id).value =
        new Date(now - offset).toISOString().slice(11, 16);
    }
  }

  // ìµœì´ˆ ë¡œë”© ì‹œ ìë™ ì…ë ¥
  setNow("reportTime", "datetime");
  setNow("arrivalTime", "time");
  setNow("treatmentStart", "time");
  setNow("treatmentEnd", "time");
  setNow("transferDone", "datetime");
</script>
  
  // --- ìœ í‹¸ / ì´ˆê¸°ê°’ ---
  const $ = q=>document.querySelector(q);
  const $$ = q=>Array.from(document.querySelectorAll(q));
  $("#arrTime").value = new Date().toISOString().slice(0,16);

  // ì¹© í† ê¸€
  $$("#modifiers .chip").forEach(c=>{
    c.addEventListener("click", ()=>{ c.classList.toggle("active"); renderSelectedMods(); });
  });
  function selectedModifiers(){ return $$("#modifiers .chip.active").map(c=>c.dataset.val); }
  function renderSelectedMods(){ const s = selectedModifiers(); $("#selectedMods").textContent = s.length? s.join(", ") : "-"; }

  // ì†Œì•„ ì •ìƒë²”ìœ„(ì°¸ê³ ìš©, ì—°ë ¹ êµ¬ê°„ë³„ ë‹¨ìˆœí™”)
  // ì´ ê°’ë“¤ì€ PedKTAS/CTAS ê³„ì—´ì˜ ê¶Œê³ ë¥¼ ì°¸ê³ í•˜ì—¬ êµìœ¡ìš©ìœ¼ë¡œ ë‹¨ìˆœí™”í•œ ë²”ìœ„ì…ë‹ˆë‹¤.
  const pediatrics = [
    {maxAgeMonths:3, hr:[90,205], rr:[30,60]},   // 0-3 months (ëŒ€ëµ)
    {maxAgeMonths:12, hr:[80,180], rr:[25,50]},  // 3-12 months
    {maxAgeMonths:36, hr:[70,160], rr:[20,40]},  // 1-3 years
    {maxAgeMonths:72, hr:[60,140], rr:[20,30]},  // 3-6 years
    {maxAgeMonths:144, hr:[50,120], rr:[16,25]}, // 6-12 years
  ];
  function getPediatricRanges(ageYears){
    if (ageYears===null || ageYears===undefined) return null;
    const months = ageYears*12;
    for (let r of pediatrics) if (months <= r.maxAgeMonths) return r;
    return {hr:[50,110], rr:[12,20]}; // 12ì„¸ ì´ìƒì€ ì„±ì¸ ê¸°ì¤€ ìœ ì‚¬
  }

  // --- í•µì‹¬ ì¤‘ì¦ë„ ê³„ì‚°(ì„¸ë¶„í™” ë¡œì§) ---
  function computeKTAS(){
    const reasons = [];
    let level = 5; // 1ì´ ê°€ì¥ ì¤‘ì¦

    const age = Number($("#ptAge").value) || 0;
    const rr = Number($("#rr").value) || null;
    const spo2 = Number($("#spo2").value) || null;
    const hr = Number($("#hr").value) || null;
    const sbp = Number($("#sbp").value) || null;
    const temp = Number($("#temp").value) || null;
    const avpu = $("#avpu").value;
    const gcs = Number($("#gcs").value) || null;
    const pain = Number($("#pain").value) || 0;
    const cc = $("#cc").value;
    const mods = selectedModifiers();
    const bleed = $("#bleed").value;
    const mech = $("#mech").value;
    const dehyd = $("#dehyd").value;

    // ì¦‰ì‹œì¹˜ë£Œ/ì‹¬ì •ì§€
    if (mods.includes("cardiac_arrest")){
      reasons.push("[Critical] ë¬´í˜¸í¡/ì‹¬ì •ì§€ ê°ì§€ â€” í™˜ììƒíƒœ 1");
      return {level:1, reasons};
    }
    if (avpu==="U" || gcs<=8){
      reasons.push("[Critical] ì˜ì‹ ì†Œì‹¤(GCS â‰¤ 8 / AVPU=U) â€” í™˜ììƒíƒœ 1");
      return {level:1, reasons};
    }

    // ì¤‘ì¦ í˜¸í¡ê³¤ë€ / ì‚°ì†Œí™” ì €í•˜
    if (mods.includes("severe_resp") || $("#oxygen").value==="intub"){
      level = Math.min(level,1);
      reasons.push("[Critical] ì‹¬í•œ í˜¸í¡ê³¤ë€ ë˜ëŠ” ê¸°ë„ì‚½ê´€/ì¸ê³µí˜¸í¡ í•„ìš” â€” í™˜ììƒíƒœ 1");
      return {level:1, reasons};
    }
    if (spo2 !== null && spo2 < 85){
      level = Math.min(level,1);
      reasons.push("[Critical] SpOâ‚‚ < 85% â€” ì¦‰ì‹œ ê°œì…(í˜¸í¡/ê¸°ë„) ê³ ë ¤ â€” í™˜ììƒíƒœ 1");
    } else if (spo2 !== null && spo2 < 90){
      level = Math.min(level,2);
      reasons.push("[High] SpOâ‚‚ < 90% â€” ê³ ìœ„í—˜(ì‚°ì†Œì¹˜ë£Œ í•„ìš”) â€” í™˜ììƒíƒœ 2");
    } else if (spo2 !== null && spo2 <= 92){
      level = Math.min(level,3);
      reasons.push("[Moderate] SpOâ‚‚ 90â€“92% â€” ì‚°ì†Œë³´ì¡°/ì¬í‰ê°€ â€” í™˜ììƒíƒœ 3");
    }

    // í˜¸í¡ìˆ˜ â€” ì„±ì¸/ì†Œì•„ êµ¬ë¶„
    if (age < 15){ // ì†Œì•„ (PedKTAS ë°˜ì˜)
      const ranges = getPediatricRanges(age);
      if (ranges){
        if (rr && rr > ranges.rr[1]*1.3){ level = Math.min(level,2); reasons.push("[High] ì†Œì•„ RR í˜„ì €í•œ ìƒìŠ¹ â†’ ì¤‘ì¦ ê°€ëŠ¥ì„±"); }
        else if (rr && rr > ranges.rr[1]){ level = Math.min(level,3); reasons.push("[Moderate] ì†Œì•„ RR ìƒìŠ¹"); }
        else if (rr && rr < ranges.rr[0]){ level = Math.min(level,3); reasons.push("[Moderate] ì†Œì•„ ì €í˜¸í¡"); }
      }
    } else { // ì„±ì¸
      if (rr && (rr>30 || rr<8)){ level = Math.min(level,2); reasons.push("[High] RR >30 ë˜ëŠ” <8"); }
      else if (rr && (rr>=24)){ level = Math.min(level,3); reasons.push("[Moderate] RR 24â€“30"); }
    }

    // ìˆœí™˜/í˜ˆì••
    if (sbp && sbp < 70){
      level = Math.min(level,1); reasons.push("[Critical] SBP < 70 mmHg â€” ì¦‰ì‹œ ì†Œìƒìˆ /ì‡¼í¬ê´€ë¦¬"); 
    } else if (sbp && sbp < 90){
      level = Math.min(level,2); reasons.push("[High] SBP < 90 mmHg â€” ì‡¼í¬ ì˜ì‹¬"); 
    } else if (sbp && sbp <= 100){
      level = Math.min(level,3); reasons.push("[Moderate] SBP 90â€“100 mmHg"); 
    }

    // ì‹¬ë°•ìˆ˜ (ì„±ì¸/ì†Œì•„)
    if (age < 15){
      const ranges = getPediatricRanges(age);
      if (hr && hr > ranges.hr[1]*1.2){ level = Math.min(level,2); reasons.push("[High] ì†Œì•„ HR í˜„ì €í•œ ìƒìŠ¹"); }
      else if (hr && hr > ranges.hr[1]){ level = Math.min(level,3); reasons.push("[Moderate] ì†Œì•„ HR ìƒìŠ¹"); }
      else if (hr && hr < ranges.hr[0]){ level = Math.min(level,3); reasons.push("[Moderate] ì†Œì•„ ì„œë§¥"); }
    } else {
      if (hr && hr >= 130){ level = Math.min(level,2); reasons.push("[High] HR â‰¥ 130"); }
      else if (hr && hr >= 110){ level = Math.min(level,3); reasons.push("[Moderate] HR 110â€“129"); }
    }

    // ì‹ ê²½í•™ì  ì¦ìƒ
    if (mods.includes("neuro_deficit") || cc==="neuro"){
      level = Math.min(level,2);
      reasons.push("[High] ê¸‰ì„± ì‹ ê²½í•™ì  ê²°ì†(í¸ë§ˆë¹„/ì–¸ì–´ì¥ì• /ì˜ì‹ë³€í™”) â€” ë‡Œì¡¸ì¤‘Â·ì¶œí˜ˆ ì˜ì‹¬");
    }
    if (cc==="trauma_head" && (mods.includes("cardiac_arrest") || mech==="high" || gcs<=13)){
      level = Math.min(level,2); reasons.push("[High] ë‘ë¶€ì†ìƒ + ì˜ì‹ì €í•˜/ê³ ì—ë„ˆì§€ â†’ CT/ìˆ˜ìˆ  ê°€ëŠ¥ì„±");
    }

    // í‰í†µ â€” ì‹¬ê·¼í—ˆí˜ˆ/ACS ê´€ë ¨ íŠ¸ë¦¬ê±°
    if (mods.includes("chest_isch") || cc==="chest"){
      // ì‹¬ì „ë„/í—ˆí˜ˆ ì˜ì‹¬(êµìœ¡ìš©: í‰í†µ + ì™¼ìª½ íŒ” ë°©ì‚¬í†µ/ì‹ì€ë•€/í˜¸í¡ê³¤ë€/ë¶ˆì•ˆê° ë“±)
      level = Math.min(level,2);
      reasons.push("[High] í‰í†µ: ì‹¬ê·¼í—ˆí˜ˆ/ê¸‰ì„±ê´€ìƒë™ë§¥ì¦í›„êµ° ì˜ì‹¬ â†’ ë¹ ë¥¸ í‰ê°€(ECG, íŠ¸ë¡œí¬ë‹Œ) ê¶Œê³ ");
    }

    // ì¶œí˜ˆ/ëŒ€ëŸ‰ì¶œí˜ˆ
    if (bleed === "massive" || mods.includes("massive_bleed")){
      level = Math.min(level,1); reasons.push("[Critical] í™œë™ì„± ëŒ€ëŸ‰ì¶œí˜ˆ â€” ì¦‰ì‹œ ì§€í˜ˆ/ìˆ˜í˜ˆ ì¤€ë¹„"); 
    } else if (bleed === "moderate") {
      level = Math.min(level,2); reasons.push("[High] ì¤‘ë“±ë„ ì¶œí˜ˆ"); 
    }

    // ê³ ì—ë„ˆì§€ ì™¸ìƒ
    if (mech === "high" || mods.includes("highenergy")){
      level = Math.min(level,2); reasons.push("[High] ê³ ì—ë„ˆì§€ ì™¸ìƒ â€” ë‹¤ë°œì†ìƒÂ·ë‚´ë¶€ì†ìƒ ì˜ì‹¬");
    }

    // íŒ¨í˜ˆì¦ ì˜ì‹¬
    if (cc==="sepsis" || mods.includes("sepsis_suspect")){
      if (sbp && sbp < 90) { level = Math.min(level,2); reasons.push("[High] ê°ì—¼ + ì €í˜ˆì••(Sepsis/Septic shock ì˜ì‹¬)"); }
      else if (rr && rr>22){ level = Math.min(level,2); reasons.push("[High] ê°ì—¼ + ë¹ˆí˜¸í¡(Sepsis ì˜ì‹¬)"); }
      else { level = Math.min(level,3); reasons.push("[Moderate] ê°ì—¼ ì˜ì‹¬(Sepsis ê·œì¹™ ì ìš© í•„ìš”)"); }
    }

    // ì‚°ë¶€ì¸ê³¼/ì„ì‹ 
    if (mods.includes("pregnancy") || cc==="obstetrics"){
      // ì„ì‹  ê´€ë ¨ ì¶œí˜ˆÂ·í†µì¦Â·ë¶„ë§Œì§•í›„ëŠ” ìµœì†Œ í™˜ììƒíƒœ 2-3ìœ¼ë¡œ ê³ ë ¤
      level = Math.min(level,3);
      reasons.push("[Moderate] ì„ì‹ /ì‚°ê³¼ ê´€ë ¨ í™˜ì â€” ë¶„ë§Œ/ìê¶ì¶œí˜ˆ ë“± íŠ¹ìˆ˜ê´€ë¦¬ í•„ìš”");
    }

    // ì†Œì•„ ë°œì—´ ë³´ì • (3ê°œì›” ë¯¸ë§Œì€ higher)
    if (mods.includes("ped_lt3m") || cc==="fever_ped"){
      if (mods.includes("ped_lt3m") || age>0 && age < 0.25){
        level = Math.min(level,2);
        reasons.push("[High] ì†Œì•„ 3ê°œì›” ë¯¸ë§Œ ë°œì—´(â‰¥38â„ƒ) â€” ì†Œì•„ì¤‘í™˜ìë‚˜ ì…ì› ê³ ë ¤");
      } else {
        // ì†Œì•„ ë°œì—´(>=3ê°œì›”) : ì¦ìƒ/í‰ì†Œìƒíƒœì— ë”°ë¼ 3~4
        level = Math.min(level,3);
        reasons.push("[Moderate] ì†Œì•„ ë°œì—´(3ê°œì›” ì´ìƒ) â€” ì¦ìƒê¸°ë°˜ ì¬í‰ê°€ í•„ìš”");
      }
    }

    // í†µì¦ ë³´ì • (ì„±ì¸)
    if (age >= 15){
      if (pain >= 8){ level = Math.min(level,2); reasons.push("[High] í†µì¦ NRS 8â€“10"); }
      else if (pain >= 4){ level = Math.min(level,3); reasons.push("[Moderate] í†µì¦ NRS 4â€“7"); }
      else if (pain >= 1){ level = Math.min(level,4); reasons.push("[Low] í†µì¦ NRS 1â€“3"); }
    }

    // íƒˆìˆ˜/ìˆœí™˜ ë³´ì •
    if (dehyd === "severe"){ level = Math.min(level,2); reasons.push("[High] ì¤‘ì¦ íƒˆìˆ˜/ìˆœí™˜ë¶€ì „"); }
    else if (dehyd === "moderate"){ level = Math.min(level,3); reasons.push("[Moderate] ì¤‘ë“±ë„ íƒˆìˆ˜"); }

    // ì •ì‹ ê³¼ ìí•´ìœ„í—˜
    if (mods.includes("selfharm_risk") || cc==="psy"){
      level = Math.min(level,2);
      reasons.push("[High] ìí•´/íƒ€í•´ ìœ„í—˜ â€” ì•ˆì „ì¡°ì¹˜ í•„ìš”");
    }

    // ê¸°ë³¸ ì¦ìƒêµ° ìµœì†Œê°’ (êµìœ¡ìš© ê¶Œì¥)
    const ccMin = {
      "respiratory":2, "chest":2, "neuro":2, "sepsis":2,
      "trauma_thorax":2, "trauma_head":3, "burn":3,
      "poison":3, "obstetrics":3, "fever_ped":3, "gi":4, "trauma_extrem":4, "psy":3, "other":5
    };
    if (ccMin[cc]) {
      level = Math.min(level, ccMin[cc]);
      reasons.push("[Info] ì¦ìƒêµ° ê¶Œì¥ ìµœì†Œì¤‘ì¦ë„: " + cc + " â†’ í™˜ììƒíƒœ â‰¥ " + ccMin[cc]);
    }

    // ìµœì¢… ë³´ì •(ì˜ˆ: í™˜ììƒíƒœ 1 ìš°ì„ )
    if (level <= 1) level = 1;
    if (level > 5) level = 5;

    return {level, reasons};
  }

  // --- ë Œë”ë§ ---
  function setBadge(level){
    const badge = $("#badge");
    badge.className = "badge k"+level;
    const labels = {1:"í™˜ììƒíƒœ 1 (ì¦‰ì‹œ)",2:"í™˜ììƒíƒœ 2 (ì‘ê¸‰, â‰¤15ë¶„)",3:"í™˜ììƒíƒœ 3 (ì¤€ì‘ê¸‰, â‰¤30ë¶„)",4:"í™˜ììƒíƒœ 4 (â‰¤60ë¶„)",5:"í™˜ììƒíƒœ 5 (ë¹„ì‘ê¸‰, â‰¤120ë¶„)"};
    badge.textContent = labels[level];
    $("#target").textContent = ({1:"ì¦‰ì‹œ",2:"â‰¤ 15ë¶„",3:"â‰¤ 30ë¶„",4:"â‰¤ 60ë¶„",5:"â‰¤ 120ë¶„"})[level];
  }

  function render(){
    const res = computeKTAS();
    setBadge(res.level);
    const ul = $("#rationale");
    ul.innerHTML = "";
    if (res.reasons.length === 0) {
      const li = document.createElement("li"); li.textContent = "íŠ¹ì´ íŠ¸ë¦¬ê±° ì—†ìŒ â†’ ê¸°ë³¸ í™˜ììƒíƒœ 5 ìœ ì§€"; ul.appendChild(li);
    } else {
      res.reasons.forEach(r=>{
        const li = document.createElement("li"); li.textContent = r; ul.appendChild(li);
      });
    }
  }

  // ë²„íŠ¼ ì´ë²¤íŠ¸
  $("#calcBtn").addEventListener("click", ()=>{ render(); });
  $("#resetBtn").addEventListener("click", ()=>{
    document.querySelectorAll("input,select,textarea").forEach(el=>{
      if (el.type === "datetime-local") el.value = new Date().toISOString().slice(0,16);
      else el.value = "";
    });
    $$("#modifiers .chip").forEach(c=>c.classList.remove("active"));
    $("#selectedMods").textContent = "-";
    setBadge(5);
    $("#rationale").innerHTML = "";
  });

  // JSON ì €ì¥
  $("#saveBtn").addEventListener("click", ()=>{
    const data = {
      patient:{name:$("#ptName").value, age:$("#ptAge").value, sex:$("#ptSex").value, weight:$("#ptWt").value},
      arrival:{time:$("#arrTime").value},
      vitals:{rr:$("#rr").value, spo2:$("#spo2").value, hr:$("#hr").value, sbp:$("#sbp").value, temp:$("#temp").value, avpu:$("#avpu").value, gcs:$("#gcs").value, pain:$("#pain").value},
      complaint:{cc:$("#cc").value, note:$("#ccNote").value},
      modifiers:selectedModifiers(),
      bleed:$("#bleed").value, mech:$("#mech").value, dehyd:$("#dehyd").value,
      result: computeKTAS()
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
    a.download = `í™˜ììƒíƒœ_detail_${new Date().toISOString().slice(0,19).replace(/[:.]/g,'-')}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // ì´ˆê¸° ì„¸íŒ…
  setBadge(5);
  
  // ì‘ì„±ë‚´ìš© í‘œì‹œ ë° ì €ì¥
function saveWrittenDataIfEnabled() {
  const autoSave = $("#autoSaveToggle").checked;
  if (!autoSave) {
    alert("ìë™ ì €ì¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\nì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤.");
    return;
  }

  const data = {
    ì´ë¦„: $("#ptName").value,
    ì„±ë³„: $("#ptSex").value,
    ë‚˜ì´: $("#ptAge").value,
    ì²´ì¤‘: $("#ptWt").value,
    í™œë ¥ì§•í›„: {
      RR: $("#rr").value,
      SpO2: $("#spo2").value,
      HR: $("#hr").value,
      SBP: $("#sbp").value,
      ì²´ì˜¨: $("#temp").value,
      AVPU: $("#avpu").value,
      GCS: $("#gcs").value,
      í†µì¦: $("#pain").value
    },
    ì£¼ì¦ìƒ: $("#cc").value,
    ìƒì„¸ì¦ìƒ: $("#ccNote").value,
    ìˆ˜ì •ì§€í‘œ: selectedModifiers().join(", "),
    ì¤‘ì¦ë„: computeKTAS().level
  };

  // í‘œì‹œìš© í…ìŠ¤íŠ¸ êµ¬ì„±
  const displayText = Object.entries(data).map(([k, v]) => {
    if (typeof v === 'object') {
      return `${k}:\n  ` + Object.entries(v).map(([subK, subV]) => `${subK}: ${subV}`).join('\n  ');
    } else {
      return `${k}: ${v}`;
    }
  }).join('\n');

  $("#writtenDataBox").textContent = displayText;
}

// ì¤‘ì¦ë„ ê³„ì‚° ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì¶”ê°€ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€í•˜ë©´ì„œ ì´ ë¶€ë¶„ë§Œ ì¶”ê°€)
$("#calcBtn").addEventListener("click", () => {
  render();
  saveWrittenDataIfEnabled(); // â† ìë™ ì €ì¥ ì²´í¬ ì—¬ë¶€ í™•ì¸ í›„ ì‘ì„± ë‚´ìš© í‘œì‹œ
});
  
  // ğŸ“‹ ë‚´ìš© ë³µì‚¬
$("#copyResultBtn").addEventListener("click", () => {
  const text = $("#writtenDataBox").textContent;
  if (!text.trim()) return alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
  navigator.clipboard.writeText(text).then(() => {
    alert("ì‘ì„± ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
  });
});

// ğŸ”— ê³µìœ  ë§í¬ ìƒì„± (ë‚´ìš©ì„ ì••ì¶•í•´ì„œ URLì— í¬í•¨)
$("#generateLinkBtn").addEventListener("click", () => {
  const text = $("#writtenDataBox").textContent;
  if (!text.trim()) return alert("ê³µìœ í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");

  // base64 encode (ê°„ë‹¨í•˜ê²Œ)
  const encoded = btoa(unescape(encodeURIComponent(text)));
  const baseUrl = location.origin + location.pathname;
  const shareUrl = `${baseUrl}?share=${encoded}`;
  $("#shareLinkOutput").value = shareUrl;
  $("#shareLinkOutput").select();
});

// í˜ì´ì§€ì— ê³µìœ  ë§í¬ë¡œ ì ‘ê·¼í•œ ê²½ìš°, ë‚´ìš© ìë™ ë³µì›
window.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(location.search);
  if (params.has("share")) {
    try {
      const decoded = decodeURIComponent(escape(atob(params.get("share"))));
      $("#writtenDataBox").textContent = decoded;
      $("#autoSaveToggle").checked = true; // ìë™ì €ì¥ ONìœ¼ë¡œ í‘œì‹œ
    } catch (e) {
      console.error("ê³µìœ  ë§í¬ ë³µì› ì‹¤íŒ¨", e);
    }
  }
});
</script>
  
   <script>
    const printBtn = document.getElementById('printBtn');
    printBtn.addEventListener('click', () => {
      window.print();
    });
  </script>
  
</body>
</html>

</body>
</html>
