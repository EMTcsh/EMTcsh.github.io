<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🚑 특수산악구조대 환자평가</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ff9e145029506d6e4c72d1f2b01ea424&libraries=services"></script>
<style>
body { background-color: #f0f2f5; font-family: Arial, sans-serif; }
.container { max-width: 900px; margin: 20px auto; padding: 20px; }
.section { background-color: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
.section h2 { font-size: 1.25rem; color: #1e3a8a; margin-bottom: 10px; }
input, select, textarea { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; width: 100%; margin-bottom: 10px; font-size: 1rem; }
textarea { resize: vertical; min-height: 80px; }
button { border-radius: 8px; font-weight: bold; }
.board-item { white-space: pre-line; background-color: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
.vitalsRow { border: 1px dashed #cbd5e1; border-radius: 8px; padding: 10px; margin-bottom: 10px; background-color: #fefefe; }
.coordinate-box { background-color: #e2e8f0; border-radius: 8px; padding: 10px; margin-bottom: 10px; word-break: break-word; }
#map { width: 100%; height: 300px; border-radius: 12px; margin-bottom: 10px; }
.GPS-link a { display: block; text-align: center; padding: 10px; margin: 5px 0; background-color: #e0e7ff; border-radius: 8px; font-weight: bold; color: #1e40af; text-decoration: none; }
</style>
</head>
<body>
<div class="container">

<h1 class="text-2xl font-bold text-center text-blue-700 mb-4">🚑 특수산악구조대 환자평가</h1>

<!-- 공지사항 -->
<div class="section">
    <h2>알림</h2>
    <p>응급환자의 신속한 평가와 기록 및 구조대 현장 대응력 향상을 위해 제작되었습니다.</p>
    <p class="mt-2 text-sm text-gray-500">© 2024 Paramedic Web Applications | EMT Ver.0.9.28 | Korea National Park Service Paramedic Lab</p>
</div>

<form id="recordForm">

<!-- 상황 정보 -->
<div class="section">
    <h2>상황 정보</h2>
    <input type="datetime-local" name="발생시간" required placeholder="발생시간">
    <input type="text" name="장소" placeholder="장소 (예: OO동 123-45)" required>
    <input type="text" name="주증상" placeholder="증상 (예: 호흡곤란, 가슴 통증)" required>
</div>

<!-- 환자 정보 -->
<div class="section">
    <h2>환자 정보</h2>
    <input type="text" name="환자이름" placeholder="이름" required>
    <input type="date" name="생년월일" required>
</div>

<!-- GCS -->
<div class="section">
    <h2>Glasgow Coma Scale (GCS)</h2>
    <label>눈 반응 (E)
        <select id="eye">
            <option value="4">자발적으로 열림</option>
            <option value="3">소리 자극에 열림</option>
            <option value="2">통증 자극에 열림</option>
            <option value="1">전혀 열림 안함</option>
        </select>
    </label>
    <label>언어 반응 (V)
        <select id="verbal">
            <option value="5">정확한 대답</option>
            <option value="4">혼잡한 대답</option>
            <option value="3">혼미한 대답</option>
            <option value="2">모호한 대답</option>
            <option value="1">응답 없음</option>
        </select>
    </label>
    <label>운동 반응 (M)
        <select id="motor">
            <option value="6">명령 수행</option>
            <option value="5">통증 자극에 국소화</option>
            <option value="4">통증 자극에 굴곡</option>
            <option value="3">통증 자극에 구부리기</option>
            <option value="2">경련</option>
            <option value="1">운동 없음</option>
        </select>
    </label>
    <div id="gcsResultContainer" class="mt-2" style="display:none;">
        <strong>GCS 결과:</strong> <span id="gcsResult"></span>
    </div>
</div>

<!-- 활력징후 -->
<div class="section">
    <h2>활력징후</h2>
    <div id="vitalSignsContainer"></div>
    <button type="button" onclick="addVitalSigns()" class="bg-green-600 text-white px-4 py-2">+ 활력징후 추가</button>
</div>

<!-- 응급처치 -->
<div class="section">
    <h2>응급처치</h2>
    <textarea name="응급처치" placeholder="실시한 응급처치 기록"></textarea>
</div>

<!-- 기록자 -->
<div class="section">
    <h2>기록자</h2>
    <input type="text" name="기록자" placeholder="응급구조사 성명" required>
</div>

<button type="submit" class="bg-blue-600 text-white px-4 py-3 w-full mt-2">기록 저장하기</button>
<button type="button" onclick="shareReport()" class="bg-purple-600 text-white px-4 py-3 w-full mt-2">공유</button>
<div id="resultMessage" class="mt-2 text-center text-green-600 font-bold"></div>
</form>

<!-- 작성 기록 -->
<div class="section">
    <h2>작성 기록</h2>
    <div id="savedData"></div>
</div>

<!-- GPS -->
<div class="section">
    <h2>GPS 좌표</h2>
    <button id="getLocation" class="bg-green-500 text-white px-4 py-2 mr-2 mb-2">🌐 내 위치 확인</button>
    <button id="shareLocation" class="bg-blue-500 text-white px-4 py-2 mb-2">📲 위치 공유</button>
    <div id="locationDisplay" class="coordinate-box">위도: , 경도: </div>
    <div id="dmsCoordinates" class="coordinate-box">도분초: </div>
    <div id="map"></div>
</div>

<div class="GPS-link">
    <a href="https://www.whereurl.com/" target="_blank">조난자 위치공유 whereUrl</a>
    <a href="https://discord.gg/ryaMRTAhwP" target="_blank">문의: 🐸 국립공원 안전사고 연구회</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

    /* 활력징후 추가 */
    function addVitalSigns() {
        const container = document.getElementById("vitalSignsContainer");
        const index = container.children.length + 1;
        const div = document.createElement("div");
        div.className = "vitalsRow";
        div.innerHTML = `
            <strong>${index}회차 측정</strong>
            <input type="text" name="혈압[]" placeholder="혈압 120/80">
            <input type="number" name="맥박[]" placeholder="맥박 회/분">
            <input type="number" name="호흡수[]" placeholder="호흡수 회/분">
            <input type="number" step="0.1" name="체온[]" placeholder="체온 ℃">
            <input type="number" name="산소포화도[]" placeholder="SpO₂ %">
        `;
        container.appendChild(div);
    }
    addVitalSigns();

    /* GCS 계산 */
    function calculateGCS() {
        const eye = parseInt(document.getElementById("eye").value);
        const verbal = parseInt(document.getElementById("verbal").value);
        const motor = parseInt(document.getElementById("motor").value);
        const total = eye + verbal + motor;
        let state='';
        if(total===15) state='정상';
        else if(total>=13) state='졸림';
        else if(total>=9) state='혼미';
        else if(total>=4) state='반혼수';
        else state='혼수';
        document.getElementById("gcsResult").innerText = `${total}점 (${state})`;
        document.getElementById("gcsResultContainer").style.display="block";
    }
    ["eye","verbal","motor"].forEach(id=>document.getElementById(id).addEventListener("change",calculateGCS));
    calculateGCS();

    /* 기록 저장 */
    document.getElementById("recordForm").addEventListener("submit", function(e){
        e.preventDefault();
        const formData = new FormData(this);
        const data={};
        for(const [k,v] of formData.entries()){
            if(k.endsWith("[]")){ const key=k.replace("[]",""); data[key]=data[key]||[]; data[key].push(v);}
            else data[k]=v;
        }
        data["GCS"] = document.getElementById("gcsResult").innerText;
        let content=""; for(const k in data){ content += Array.isArray(data[k])?`${k}: ${data[k].join(", ")}\n`:`${k}: ${data[k]}\n`; }
        const today=new Date().toISOString().slice(0,10);
        const blob=new Blob([content],{type:"text/plain"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`환자평가_${today}.txt`; a.click(); URL.revokeObjectURL(a.href);
        document.getElementById("savedData").innerHTML = `<div class="board-item">${content}</div>`;
        document.getElementById("resultMessage").innerText = "기록 저장 완료 ✅";
    });

    /* 공유 */
    window.shareReport = function(){
        const formData = new FormData(document.getElementById("recordForm"));
        let text=""; formData.forEach((v,k)=>text+=`${k}: ${v}\n`);
        text+="GCS: "+document.getElementById("gcsResult").innerText;
        if(navigator.share) navigator.share({title:"환자 평가 기록", text});
        else alert("이 브라우저는 공유 기능을 지원하지 않습니다.");
    }

    /* GPS */
    let map, marker, currentLat, currentLng;
    function initMap(lat,lng){ map=new kakao.maps.Map(document.getElementById('map'), {center:new kakao.maps.LatLng(lat,lng), level:3}); marker=new kakao.maps.Marker({position:new kakao.maps.LatLng(lat,lng), map:map});}
    document.getElementById("getLocation").addEventListener("click", function(){
        if(navigator.geolocation) navigator.geolocation.getCurrentPosition(showPosition, showError);
        else alert("이 브라우저는 위치 정보를 지원하지 않습니다.");
    });
    function showPosition(pos){currentLat=pos.coords.latitude; currentLng=pos.coords.longitude;
        document.getElementById('locationDisplay').textContent=`위도: ${currentLat}, 경도: ${currentLng}`;
        document.getElementById('dmsCoordinates').textContent=`도분초: ${convertToDMS(currentLat,'lat')}, ${convertToDMS(currentLng,'lng')}`;
        initMap(currentLat,currentLng);
    }
    function showError(err){switch(err.code){case err.PERMISSION_DENIED: alert("사용자가 위치 정보를 요청하지 않았습니다."); break; case err.POSITION_UNAVAILABLE: alert("위치 정보를 사용할 수 없습니다."); break; case err.TIMEOUT: alert("위치 정보 요청이 시간초과되었습니다."); break; default: alert("알 수 없는 오류가 발생했습니다."); break;}}
    function convertToDMS(deg,type){let d=Math.floor(deg); let m=Math.floor((deg-d)*60); let s=((deg-d-m/60)*3600).toFixed(2); return `${d}° ${m}' ${s}" ${type==='lat'?(deg>0?'N':'S'):(deg>0?'E':'W')}`;}
    document.getElementById("shareLocation").addEventListener("click", function(){
        if(currentLat&&currentLng){ const g=`https://www.google.com/maps?q=${currentLat},${currentLng}`; const k=`https://map.kakao.com/link/map/Location,${currentLat},${currentLng}`; const msg=`🚨 요구조자 현위치 좌표:\n위도:${currentLat}\n경도:${currentLng}\nGoogle Map:${g}\nKakao Map:${k}`; if(navigator.share) navigator.share({title:"[구조요청] GPS좌표 공유", text:msg,url:k}); else alert('이 브라우저는 위치 공유를 지원하지 않습니다.\n'+msg);}
        else alert('위치를 먼저 확인 후 공유하세요.');
    });

});
</script>

</div>
</body>
</html>
