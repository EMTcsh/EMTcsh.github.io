<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸš‘ ë¬´ë“±ì‚° ì‚°ì•…ì‚¬ê³  êµ¬ê¸‰ ê¸°ë¡</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ff9e145029506d6e4c72d1f2b01ea424&libraries=services"></script>
<style>
body{background:#eef1f5;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;}
.critical-mode{animation:criticalFlash 0.8s infinite;}
@keyframes criticalFlash{0%{background-color:#fee2e2;}50%{background-color:#dc2626;}100%{background-color:#fee2e2;}}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border-left:5px solid #2563eb;}
.card h2{font-weight:700;font-size:15px;margin-bottom:10px;color:#1e3a8a;}
input,select,textarea{width:100%;border:1px solid #d1d5db;border-radius:10px;padding:12px;margin-bottom:10px;font-size:15px;background:#f9fafb;}
input:focus,select:focus,textarea:focus{outline:none;border-color:#2563eb;background:#fff;box-shadow:0 0 0 2px rgba(37,99,235,0.15);}
textarea{min-height:100px;}
button{width:100%;padding:14px;border-radius:12px;font-size:16px;font-weight:600;}
.coordinate-box{background:#e0e7ff;padding:10px;border-radius:8px;font-size:13px;margin-bottom:8px;}
#map{width:100%;height:220px;border-radius:12px;}
.board-item{white-space:pre-line;font-size:13px;background:#f3f4f6;padding:12px;border-radius:10px;line-height:1.5;}
.header{text-align:center;font-weight:800;font-size:20px;margin:18px 0;color:#1d4ed8;}
</style>
</head>
<body id="mainBody" class="px-4">

<div class="header">ğŸš‘ ë¬´ë“±ì‚° ì‚°ì•…ì‚¬ê³  êµ¬ê¸‰ ê¸°ë¡</div>

<form id="recordForm">
<div class="card">
<h2>ğŸ“ í˜„ì¥ì •ë³´</h2>
<input type="text" name="ì¶œë™ëŒ€ì›" placeholder="ì¶œë™ëŒ€ì› ì´ë¦„" required>
<input type="datetime-local" name="ë„ì°©ì‹œê°„" required>
<input type="text" name="ì‚¬ê³ ì¥ì†Œ" placeholder="ì‚¬ê³ ì¥ì†Œ" required>
<input type="text" name="ì£¼ì¦ìƒ" placeholder="í™˜ì ì¦ìƒ" required>
<div id="locationDisplay" class="coordinate-box">ìœ„ë„: -, ê²½ë„: -</div>
<button type="button" id="getLocation" class="bg-green-600 text-white mb-2">ğŸŒ í˜„ì¥ ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°</button>
<input type="hidden" name="ì‚¬ê³ ì¢Œí‘œ" id="hiddenCoordinate">
<div id="map"></div>
</div>

<div class="card">
<h2>ğŸ§  GCS</h2>
<select id="eye">
<option value="4">ìë°œì ìœ¼ë¡œ ëˆˆì„ ëœ¬ë‹¤</option>
<option value="3">ë§ë¡œ ì§€ì‹œí–ˆì„ë•Œ ëˆˆì„ ëœ¬ë‹¤</option>
<option value="2">í†µì¦ ìê·¹ì— ì˜í•´ ëˆˆì„ ëœ¬ë‹¤</option>
<option value="1">ëˆˆì„ ëœ¨ì§€ ëª»í•¨</option>
</select>
<select id="verbal">
<option value="5">ì •í™•í•œ ë°˜ì‘(6í•˜ì›ì¹™)</option>
<option value="4">ëŒ€í™” í˜¼ë€</option>
<option value="3">ì–¸ì–´í˜¼ë€</option>
<option value="2">ì‹ ìŒì†Œë¦¬ë§Œ</option>
<option value="1">ë°˜ì‘ ì—†ìŒ</option>
</select>
<select id="motor">
<option value="6">ëª…ë ¹ ìˆ˜í–‰</option>
<option value="5">í†µì¦ ìê·¹ êµ­ì†Œí™”</option>
<option value="4">í†µì¦ ìê·¹ ì›€ì¸ ë¦¼</option>
<option value="3">í†µì¦ ì´ìƒêµ´ê³¡</option>
<option value="2">í†µì¦ ì´ìƒì‹ ì „</option>
<option value="1">ë¬´ë°˜ì‘</option>
</select>
<div class="font-bold text-lg mt-2">GCS: <span id="gcsResult"></span></div>
<div id="gcsWarning" style="display:none;margin-top:10px;padding:10px;border-radius:10px;background:#fee2e2;color:#b91c1c;font-weight:600;">
ğŸš¨ ì¤‘ì¦ ì˜ì‹ì €í•˜ â€” ì¦‰ì‹œ ê¸°ë„/í˜¸í¡/ìˆœí™˜ í™•ì¸ í•„ìš”
</div>
</div>

<div class="card">
<h2>ğŸ‘¤ í™˜ìì •ë³´</h2>
<input type="text" name="í™˜ìì´ë¦„" placeholder="ì´ë¦„" required>
<input type="date" name="ìƒë…„ì›”ì¼" required>
<input type="text" name="ê±°ì£¼ì§€" placeholder="ê±°ì£¼ì§€" required>
<input type="tel" name="ì—°ë½ì²˜" placeholder="ì—°ë½ì²˜" required>
</div>

<div class="card">
<h2>ğŸš¨ ì‘ê¸‰ì²˜ì¹˜</h2>
<textarea name="ì‘ê¸‰ì²˜ì¹˜" placeholder="ì²˜ì¹˜ ë‚´ìš© ì…ë ¥"></textarea>
</div>

<button type="submit" class="bg-blue-600 text-white mb-4">ê¸°ë¡ ì €ì¥</button>
</form>

<div class="card">
<h2>ğŸ“‹ ì‘ì„±ê¸°ë¡</h2>
<div id="savedData"></div>
</div>

<div class="card">
<h2>ğŸ—ºï¸ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h2>
<div id="monitorMap" style="width:100%;height:400px;border-radius:12px;"></div>
</div>

<script>
const SERVER_URL="https://script.google.com/macros/s/AKfycbzlomCAxIqxNLLLXeoI_7PZzP9WguNFk3OH84Nzgcxhncm1mLx6LuqNbcAgniODAFgDIQ/exec"; // ë°°í¬ URLë¡œ êµì²´

let patientID="PT-"+Date.now();
let monitorMap, monitorMarkers=[];

// GCS ê³„ì‚°
function calculateGCS(){
  const eye=parseInt(document.getElementById("eye").value);
  const verbal=parseInt(document.getElementById("verbal").value);
  const motor=parseInt(document.getElementById("motor").value);
  const total=eye+verbal+motor;
  const gcsResult=document.getElementById("gcsResult");
  gcsResult.textContent=`${total}ì `;
}
[...document.querySelectorAll("#eye,#verbal,#motor")].forEach(el=>el.addEventListener("change",calculateGCS));
calculateGCS();

// GPS
document.getElementById("getLocation").onclick=()=>{
  navigator.geolocation.getCurrentPosition(p=>{
    const lat=p.coords.latitude;
    const lng=p.coords.longitude;
    document.getElementById("locationDisplay").textContent=`ìœ„ë„:${lat}, ê²½ë„:${lng}`;
    document.getElementById("hiddenCoordinate").value=`${lat},${lng}`;
    const loc=new kakao.maps.LatLng(lat,lng);
    const mapObj=new kakao.maps.Map(document.getElementById("map"),{center:loc,level:3});
    new kakao.maps.Marker({position:loc,map:mapObj});
  });
};

// ê¸°ë¡ ì €ì¥
document.getElementById("recordForm").onsubmit=async e=>{
  e.preventDefault();
  const formData={};
  new FormData(recordForm).forEach((v,k)=>formData[k]=v);
  formData["GCS"]=document.getElementById("gcsResult").textContent;
  formData["patientID"]=patientID;
  if(formData.ì‚¬ê³ ì¢Œí‘œ?.includes(",")){
    const parts=formData.ì‚¬ê³ ì¢Œí‘œ.split(",");
    formData.latitude=parts[0].trim();
    formData.longitude=parts[1].trim();
  }

  document.getElementById("savedData").innerHTML=`<pre>${JSON.stringify(formData,null,2)}</pre>`;

  try{
    const res=await fetch(SERVER_URL,{
      method:"POST",
      body:JSON.stringify(formData)
    });
    alert("ì„œë²„ ì „ì†¡ ì™„ë£Œ");
  }catch(err){
    console.error(err);
    alert("ì„œë²„ ì „ì†¡ ì‹¤íŒ¨ - ì½˜ì†” í™•ì¸");
  }
};

// ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì§€ë„
function initMonitorMap(){
  monitorMap=new kakao.maps.Map(document.getElementById("monitorMap"),{
    center:new kakao.maps.LatLng(35.145,126.888), level:7
  });
}
initMonitorMap();

async function updateMonitor(){
  try{
    const res=await fetch(SERVER_URL);
    const data=await res.json();
    monitorMarkers.forEach(m=>m.setMap(null));
    monitorMarkers=[];
    data.forEach(d=>{
      if(d.latitude && d.longitude){
        const pos=new kakao.maps.LatLng(d.latitude,d.longitude);
        monitorMarkers.push(new kakao.maps.Marker({position:pos,map:monitorMap}));
      }
    });
  }catch(err){console.error(err);}
}
setInterval(updateMonitor,5000);
updateMonitor();
</script>
</body>
</html>
