<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🚨 특수산악구조대 비상대응 상황판</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  .table th, .table td { padding: 0.5rem; text-align: center; border: 1px solid #ddd; }
  .table { border-collapse: collapse; width: 100%; margin-top: 1rem; background: white; }
  .delete-btn { color: red; cursor: pointer; }
</style>
</head>
<body class="p-4 bg-gray-100">
<h1 class="text-2xl font-bold mb-4">🚨 특수산악구조대 비상대응 상황판</h1>

<form id="incidentForm" class="bg-white p-4 rounded shadow mb-4">
  <div class="grid grid-cols-4 gap-4">
    <input type="date" id="date" class="border p-2 rounded" required>
    <input type="time" id="startTime" class="border p-2 rounded">
    
    <!-- 대응종류 (select box) -->
    <select id="alertLevel" class="border p-2 rounded">
      <option value="0"></option>
      <option value="1">구조</option>
      <option value="2">조난</option>
      <option value="3">산불</option>
      <option value="4">산사태</option>
      <option value="4">기타</option>
    </select>
    
    <input type="text" id="location" placeholder="상세내용" class="border p-2 rounded" required>
    <input type="text" id="area" placeholder="발생지역" class="border p-2 rounded">
    <input type="text" id="task" placeholder="대응임무" class="border p-2 rounded">
    <input type="text" id="personnel" placeholder="대응인력" class="border p-2 rounded">
    <input type="time" id="endTime" class="border p-2 rounded">
  </div>
  <button type="submit" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded">추가</button>
</form>

<table class="table shadow rounded" id="incidentTable">
  <thead class="bg-gray-200">
    <tr>
      <th>날짜</th>
      <th>시간</th> 
      <th>대응종류</th>
      <th>상세내용</th>
      <th>발생지역</th>
      <th>대응임무</th>      
      <th>대응인력</th>
      <th>종료시간</th>
      <th>기록시간</th>
      <th>삭제</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const form = document.getElementById('incidentForm');
const tableBody = document.getElementById('incidentTable').querySelector('tbody');
const SHEET_URL = "https://script.google.com/macros/s/AKfycby-2144RWCM2Ss8h6Wu5R-DPjVQOglqV7Ol3gt0rtuFLMBuOqsvXI7Dc6MuHQiJkUrFpw/exec";

// 현재 날짜시간 포맷 함수
function getDateTimeString() {
  const now = new Date();
  const pad = (n) => String(n).padStart(2, '0');
  return (
    now.getFullYear() + "-" +
    pad(now.getMonth() + 1) + "-" +
    pad(now.getDate()) + " " +
    pad(now.getHours()) + ":" +
    pad(now.getMinutes()) + ":" +
    pad(now.getSeconds())
  );
}

// Excel 자동 저장 함수
function exportToExcel() {
  const table = document.getElementById('incidentTable');
  const wb = XLSX.utils.book_new();
  const ws_data = [];

  // 헤더
  const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
  ws_data.push(headers.slice(0, -1)); // 삭제 컬럼 제외

  // 데이터
  table.querySelectorAll('tbody tr').forEach(row => {
    const rowData = Array.from(row.querySelectorAll('td')).slice(0, -1).map(td => td.innerText);
    ws_data.push(rowData);
  });

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "상황판");

  const filename = "비상대응_상황판_" + getDateTimeString().replace(/[: ]/g,"_") + ".xlsx";
  XLSX.writeFile(wb, filename);
}

// 추가 이벤트
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const nowStr = getDateTimeString();
  const alertLevelSelect = document.getElementById('alertLevel');

  const rowData = {
    date: document.getElementById('date').value,
    startTime: document.getElementById('startTime').value || "",
    alertLevel: alertLevelSelect.options[alertLevelSelect.selectedIndex].text,
    location: document.getElementById('location').value,
    area: document.getElementById('area').value,
    task: document.getElementById('task').value,
    personnel: document.getElementById('personnel').value,
    endTime: document.getElementById('endTime').value || "",
    recordTime: nowStr
  };

  // 테이블에 추가 (헤더 순서에 맞춤)
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${rowData.date}</td>
    <td>${rowData.startTime}</td>
    <td>${rowData.alertLevel}</td>
    <td>${rowData.location}</td>
    <td>${rowData.area}</td>
    <td>${rowData.task}</td>
    <td>${rowData.personnel}</td>
    <td>${rowData.endTime}</td>
    <td>${rowData.recordTime}</td>
    <td class="delete-btn">❌</td>
  `;
  tableBody.appendChild(row);

  // 삭제 기능
  row.querySelector('.delete-btn').addEventListener('click', () => {
    tableBody.removeChild(row);
  });

  // 구글 시트 전송
  try {
    await fetch(SHEET_URL, {
      method: 'POST',
      body: JSON.stringify(rowData),
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (err) {
    console.error("구글 시트 전송 실패", err);
  }

  // Excel 자동 저장
  exportToExcel();

  form.reset();
});
</script>
</body>
</html>

