<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸš¨ ë¹„ìƒëŒ€ì‘ ìƒí™©íŒ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  .table th, .table td { padding: 0.5rem; text-align: center; border: 1px solid #ddd; }
  .table { border-collapse: collapse; width: 100%; margin-top: 1rem; background: white; }
  .delete-btn { color: red; cursor: pointer; }
</style>
</head>
<body class="p-4 bg-gray-100">
<h1 class="text-2xl font-bold mb-4">ë¹„ìƒëŒ€ì‘ ìƒí™©íŒ</h1>

<form id="incidentForm" class="bg-white p-4 rounded shadow mb-4">
  <div class="grid grid-cols-4 gap-4">
    <input type="date" id="date" class="border p-2 rounded" required>
    <input type="time" id="startTime" class="border p-2 rounded" required>
    <input type="time" id="endTime" class="border p-2 rounded" required>
    <input type="text" id="location" placeholder="ë°œìƒì¥ì†Œ" class="border p-2 rounded" required>
    <input type="text" id="area" placeholder="ëŒ€ì‘êµ¬ì—­" class="border p-2 rounded">
    <input type="text" id="personnel" placeholder="ëŒ€ì‘ì¸ë ¥" class="border p-2 rounded">
    <select id="alertLevel" class="border p-2 rounded">
      <option value="1">1ë‹¨ê³„</option>
      <option value="2">2ë‹¨ê³„</option>
      <option value="3">3ë‹¨ê³„</option>
      <option value="4">4ë‹¨ê³„</option>
    </select>
    <input type="text" id="task" placeholder="ê°œì¸ì„ë¬´" class="border p-2 rounded">
  </div>
  <button type="submit" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded">ì¶”ê°€</button>
</form>

<table class="table shadow rounded" id="incidentTable">
  <thead class="bg-gray-200">
    <tr>
      <th>ë‚ ì§œ</th>
      <th>ì‹œì‘ì‹œê°„</th>
      <th>ì¢…ë£Œì‹œê°„</th>
      <th>ë°œìƒì¥ì†Œ</th>
      <th>ëŒ€ì‘êµ¬ì—­</th>
      <th>ëŒ€ì‘ì¸ë ¥</th>
      <th>ìœ„ê¸°ê²½ë³´ë‹¨ê³„</th>
      <th>ê°œì¸ì„ë¬´</th>
      <th>ì‚­ì œ</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const form = document.getElementById('incidentForm');
const tableBody = document.getElementById('incidentTable').querySelector('tbody');

// êµ¬ê¸€ ì•±ìŠ¤ìŠ¤í¬ë¦½íŠ¸ ì›¹ì•± URL
const SHEET_URL = "https://script.google.com/macros/s/AKfycby-2144RWCM2Ss8h6Wu5R-DPjVQOglqV7Ol3gt0rtuFLMBuOqsvXI7Dc6MuHQiJkUrFpw/exec";

// Excel ìë™ ì €ì¥ í•¨ìˆ˜
function exportToExcel() {
  const table = document.getElementById('incidentTable');
  const wb = XLSX.utils.book_new();
  const ws_data = [];
  
  // í—¤ë”
  const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
  ws_data.push(headers.slice(0, -1)); // ì‚­ì œ ì»¬ëŸ¼ ì œì™¸

  // ë°ì´í„°
  table.querySelectorAll('tbody tr').forEach(row => {
    const rowData = Array.from(row.querySelectorAll('td')).slice(0, -1).map(td => td.innerText);
    ws_data.push(rowData);
  });

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "ìƒí™©íŒ");

  XLSX.writeFile(wb, "ë¹„ìƒëŒ€ì‘_ìƒí™©íŒ.xlsx");
}

// ì¶”ê°€ ì´ë²¤íŠ¸
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const rowData = {
    date: document.getElementById('date').value,
    startTime: document.getElementById('startTime').value,
    endTime: document.getElementById('endTime').value,
    location: document.getElementById('location').value,
    area: document.getElementById('area').value,
    personnel: document.getElementById('personnel').value,
    alertLevel: document.getElementById('alertLevel').value,
    task: document.getElementById('task').value
  };

  // í…Œì´ë¸”ì— ì¶”ê°€
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${rowData.date}</td>
    <td>${rowData.startTime}</td>
    <td>${rowData.endTime}</td>
    <td>${rowData.location}</td>
    <td>${rowData.area}</td>
    <td>${rowData.personnel}</td>
    <td>${rowData.alertLevel}</td>
    <td>${rowData.task}</td>
    <td class="delete-btn">âŒ</td>
  `;
  tableBody.appendChild(row);

  // ì‚­ì œ ê¸°ëŠ¥
  row.querySelector('.delete-btn').addEventListener('click', () => {
    tableBody.removeChild(row);
  });

  // êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡
  try {
    await fetch(SHEET_URL, {
      method: 'POST',
      body: JSON.stringify(rowData),
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (err) {
    console.error("êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ ì‹¤íŒ¨", err);
  }

  // Excel ìë™ ì €ì¥
  exportToExcel();

  form.reset();
});
</script>
</body>
</html>
